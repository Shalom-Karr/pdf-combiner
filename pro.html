<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visual PDF Editor Pro</title>

    <!-- 
    OFFLINE INSTRUCTIONS:
    Ensure you have a folder named 'js' containing:
    1. pdf-lib.min.js
    2. pdf.min.js
    3. pdf.worker.min.js
    4. sortable.min.js
    5. tailwindcss.js
    -->
    <script src="js/pdf-lib.min.js"></script>
    <script src="js/pdf.min.js"></script>
    <script src="js/sortable.min.js"></script>
    <script src="js/tailwindcss.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    animation: { 
                        'shimmer': 'shimmer 1.5s infinite', 
                        'pop-in': 'popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards'
                    },
                    keyframes: { 
                        shimmer: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } },
                        popIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; user-select: none; overscroll-behavior: none; -webkit-tap-highlight-color: transparent; }
        
        /* CARD ANIMATIONS */
        .page-item { transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1); outline: none; touch-action: pan-y; }
        .page-item:hover { transform: translateY(-4px) scale(1.02); z-index: 10; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .page-item.selected { ring: 2px solid #6366f1; transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgb(99 102 241 / 0.15); }
        
        /* DRAG UI */
        .sortable-ghost { opacity: 0.4; background: #e0e7ff; border: 2px dashed #6366f1; }
        .sortable-drag { cursor: grabbing; opacity: 1 !important; background: white; transform: scale(1.05); z-index: 50; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.2); }
        
        /* LAYOUT & UTILS */
        :root { --grid-size: 160px; }
        /* Mobile friendly grid */
        .view-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; padding-bottom: 8rem; }
        @media (min-width: 640px) {
            .view-grid { grid-template-columns: repeat(auto-fill, minmax(var(--grid-size), 1fr)); gap: 1.5rem; }
        }

        .view-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .view-list .page-item { flex-direction: row; height: 80px; align-items: center; padding: 0.5rem; }
        .view-list .canvas-wrapper { width: 60px; height: 100%; margin-right: 1rem; flex-shrink: 0; }
        .view-list .page-info { border: none; flex: 1; text-align: left; }
        
        #contextual-footer { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; }
        #contextual-footer.hidden-island { transform: translate(-50%, 200%); opacity: 0; pointer-events: none; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }

        /* EDITOR OVERLAYS */
        .draggable-text { position: absolute; cursor: move; user-select: none; white-space: pre; border: 1px dashed transparent; padding: 4px; line-height: 1; transform-origin: center center; touch-action: none; }
        .draggable-text:hover { border-color: rgba(99, 102, 241, 0.5); }
        .draggable-text.active { border: 1px solid #6366f1; background: rgba(255, 255, 255, 0.1); box-shadow: 0 0 0 1px white, 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Tooltip fix for mobile */
        @media (hover: hover) {
            [data-tooltip]:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); padding: 4px 8px; background: #1e293b; color: white; font-size: 10px; border-radius: 4px; white-space: nowrap; z-index: 60; margin-bottom: 6px; pointer-events: none; }
        }
        #signature-pad { touch-action: none; cursor: crosshair; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 h-full overflow-hidden transition-colors duration-200">

    <!-- OVERLAYS -->
    <div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-3 z-[100] pointer-events-none"></div>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity backdrop-blur-sm"></div>
    <iframe id="printFrame" class="hidden"></iframe>
    <input type="file" id="stampInput" accept="image/png, image/jpeg" class="hidden">

    <!-- CONTEXT MENU -->
    <div id="context-menu" class="hidden fixed z-50 bg-white dark:bg-slate-800 shadow-xl rounded-lg border border-slate-200 dark:border-slate-700 w-52 py-1 transform scale-100 origin-top-left animate-pop-in">
        <button id="ctx-edit" class="w-full text-left px-4 py-3 text-sm font-bold text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-slate-700 flex items-center gap-3"><span>‚úé</span> Edit Page</button>
        <button id="ctx-rotate-cw" class="w-full text-left px-4 py-3 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-3"><span>‚Ü∑</span> Rotate Right</button>
        <button id="ctx-duplicate" class="w-full text-left px-4 py-3 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-3"><span>‚ùê</span> Duplicate</button>
        <div class="h-px bg-slate-200 dark:bg-slate-700 my-1"></div>
        <button id="ctx-delete" class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-3"><span>üóë</span> Delete</button>
    </div>

    <!-- START SCREEN -->
    <div id="start-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-900 via-slate-900 to-black p-4">
        <div class="w-full max-w-4xl bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh] overflow-y-auto">
            <div class="p-8 md:p-10 md:w-1/2 flex flex-col justify-center text-left text-white border-b md:border-b-0 md:border-r border-white/10">
                <div class="inline-flex w-fit items-center gap-2 bg-emerald-500/20 border border-emerald-500/40 text-emerald-300 px-3 py-1 rounded-full text-xs font-medium mb-4">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                    Offline & Secure
                </div>
                <h1 class="text-3xl md:text-4xl font-bold mb-4 tracking-tight">Visual PDF Editor <span class="text-indigo-400">Pro</span></h1>
                <p class="opacity-80 mb-6 text-base md:text-lg font-light leading-relaxed">Securely merge, organize, and protect documents locally.</p>
                <div id="restore-banner" class="hidden bg-indigo-600/30 border border-indigo-500/50 p-4 rounded-lg">
                    <p class="text-sm">‚ö†Ô∏è Previous session found.</p>
                    <button id="restoreBtn" class="mt-2 text-sm bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded transition w-full md:w-auto">Restore Session</button>
                </div>
            </div>
            <div class="p-8 md:p-10 md:w-1/2 bg-black/20 flex flex-col justify-center items-center">
                <div id="startDropZone" class="w-full aspect-square border-2 border-dashed border-slate-500/50 rounded-2xl flex flex-col items-center justify-center hover:bg-white/5 hover:border-indigo-400 transition-all cursor-pointer group relative overflow-hidden">
                    <svg class="w-16 h-16 text-slate-500 group-hover:text-indigo-400 transition-colors mb-4 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="text-slate-400 font-medium relative z-10">Tap or Drag files</p>
                    <button id="startChooseFileBtn" class="mt-6 bg-white text-slate-900 hover:bg-indigo-50 font-bold py-3 px-8 rounded-full shadow-lg transition relative z-10">Select Files</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div class="app-container hidden flex h-screen flex-col md:flex-row">
        <!-- SIDEBAR -->
        <aside id="sidebar" class="w-72 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col flex-shrink-0 z-40 fixed md:relative h-full transition-transform duration-300 transform -translate-x-full md:translate-x-0 shadow-xl md:shadow-none top-0 left-0">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                <div><h2 class="font-bold text-lg">Tools</h2></div>
                <button id="sidebar-close-btn" class="md:hidden text-slate-500 p-2">‚úï</button>
            </div>
            <div id="sourceFileList" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scroll"></div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 space-y-3 pb-safe">
                <button id="insertBlankBtn" class="tool-btn">+ Insert Blank Page</button>
                <button id="openTextModalBtn" class="tool-btn">‚úé Edit / Sign Page</button>
                <button id="openMetadataBtn" class="tool-btn">‚öô Metadata</button>
                <button id="openProtectBtn" class="tool-btn text-indigo-600 dark:text-indigo-400">üîí Protect / Password</button>
            </div>
        </aside>

        <!-- MAIN VIEW -->
        <main id="main-view" class="flex-1 flex flex-col min-w-0 bg-slate-100 dark:bg-slate-900/50 relative transition-all duration-300 h-full">
            <header class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-sm z-30 px-4 py-3 flex gap-2 items-center justify-between shrink-0">
                <div class="flex items-center gap-2">
                    <button id="menu-toggle-btn" class="md:hidden text-slate-500 p-2 hover:bg-slate-100 rounded">‚ò∞</button>
                    <div class="hidden md:flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                        <button id="undoBtn" disabled class="p-1.5 rounded opacity-50"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg></button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="clearBtn" class="text-xs font-bold px-3 py-2 bg-red-50 text-red-600 rounded">Clear</button>
                    <button id="addFilesBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-4 rounded shadow-md flex items-center gap-2">Add</button>
                    <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.jpg,.jpeg,.png">
                </div>
            </header>

            <div id="page-grid-container" class="flex-1 overflow-y-auto p-4 md:p-8 relative custom-scroll">
                <div id="page-grid" class="view-grid"></div>
                <div id="empty-grid-state" class="hidden absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-50"><div class="text-6xl mb-4">üìÑ</div><p class="text-xl">No pages</p></div>
            </div>

            <!-- FOOTER BAR -->
            <footer id="contextual-footer" class="fixed bottom-6 left-4 right-4 md:left-1/2 md:-translate-x-1/2 md:w-auto hidden-island z-40 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl shadow-2xl p-3 flex items-center justify-between gap-4 border border-slate-700">
                <div class="text-sm font-bold whitespace-nowrap pl-2"><span id="selection-count">0</span></div>
                <div class="flex items-center gap-1">
                    <button id="rotateSelectedBtn" class="p-3 bg-white/10 rounded-lg">‚Üª</button>
                    <button id="deleteSelectedBtn" class="p-3 bg-red-500/20 text-red-400 rounded-lg">üóë</button>
                </div>
                <button id="saveBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">Save PDF</button>
            </footer>
        </main>
    </div>

    <!-- EDITOR MODAL (Mobile Friendly) -->
    <div id="text-modal" class="fixed inset-0 z-[60] bg-black/90 hidden flex flex-col backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-800 p-3 flex justify-between items-center shrink-0">
            <button class="close-text-modal text-slate-500 p-2">‚úï Cancel</button>
            <h3 class="font-bold text-sm">Edit Page</h3>
            <button id="savePageEdits" class="bg-indigo-600 text-white px-4 py-1.5 rounded text-sm font-bold">Done</button>
        </div>
        
        <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
            <!-- CANVAS AREA -->
            <div class="flex-1 bg-slate-900 relative overflow-hidden touch-none flex items-center justify-center" id="preview-container-parent">
                <div id="preview-wrapper" class="relative shadow-2xl transition-transform duration-200">
                    <canvas id="modal-bg-canvas" class="block"></canvas>
                    <div id="overlay-container" class="absolute inset-0"></div>
                </div>
            </div>

            <!-- TOOLS (Bottom on mobile, Right on Desktop) -->
            <div class="h-1/3 md:h-auto md:w-80 bg-white dark:bg-slate-800 border-t md:border-t-0 md:border-l border-slate-200 dark:border-slate-700 flex flex-col overflow-y-auto p-4 z-20">
                <div class="space-y-4">
                    <!-- Text Input -->
                    <div>
                        <div class="flex gap-2 mb-2">
                            <textarea id="txt-content" placeholder="Text..." class="flex-1 h-10 text-sm p-2 rounded border bg-slate-50 dark:bg-slate-900"></textarea>
                            <button id="addTextLayerBtn" class="bg-indigo-600 text-white px-3 rounded font-bold">+</button>
                        </div>
                        <div class="flex gap-2 justify-between">
                            <input type="color" id="txt-color" class="h-8 w-8 rounded cursor-pointer">
                            <input type="number" id="txt-size" value="24" class="w-16 text-sm p-1 border rounded">
                            <button id="delete-layer-btn" class="text-red-500 text-xs font-bold px-2">Delete</button>
                        </div>
                    </div>
                    
                    <!-- Signature -->
                    <div class="border-t pt-4">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Signature</label>
                        <div class="border border-slate-300 rounded h-20 mb-2 bg-white touch-none" id="sig-pad-container">
                            <canvas id="signature-pad" class="w-full h-full block"></canvas>
                        </div>
                        <div class="flex gap-2">
                            <button id="clearSigBtn" class="text-xs px-3 py-1 bg-slate-200 rounded">Clear</button>
                            <button id="addSigBtn" class="flex-1 text-xs px-3 py-1 bg-indigo-600 text-white rounded">Add to Page</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PROTECT MODAL -->
    <div id="protect-modal" class="fixed inset-0 z-[70] bg-black/80 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-2 dark:text-white">üîí Set Password</h3>
            <p class="text-xs text-slate-500 mb-4">This will encrypt the PDF. The password will be required to OPEN or VIEW the file.</p>
            <input type="password" id="protect-password" placeholder="Enter password" class="w-full border rounded-lg px-3 py-3 text-lg mb-4 dark:bg-slate-700 dark:text-white">
            <div class="flex justify-end gap-2">
                <button class="close-protect-modal px-4 py-2 text-slate-500">Cancel</button>
                <button id="saveProtectBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold">Set Password</button>
            </div>
        </div>
    </div>
    
    <!-- METADATA MODAL -->
    <div id="metadata-modal" class="fixed inset-0 z-[70] bg-black/80 hidden flex items-center justify-center p-4">
         <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-xl p-6 shadow-2xl space-y-3">
            <h3 class="font-bold dark:text-white">PDF Metadata</h3>
            <input type="text" id="meta-title" placeholder="Title" class="w-full border rounded p-2 text-sm">
            <input type="text" id="meta-author" placeholder="Author" class="w-full border rounded p-2 text-sm">
            <div class="flex justify-end gap-2 mt-4">
                <button class="close-meta-modal px-4 py-2 text-slate-500">Cancel</button>
                <button id="saveMetadataBtn" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold">Save</button>
            </div>
         </div>
    </div>

    <div id="loader" class="fixed inset-0 z-[100] bg-white/90 dark:bg-slate-900/90 flex flex-col items-center justify-center hidden"><div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div><p id="loader-text">Processing...</p></div>

    <style>
        .tool-btn { width: 100%; padding: 10px 16px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; text-align: left; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .dark .tool-btn { background: #334155; border-color: #475569; color: white; }
        .tool-btn:active { transform: scale(0.98); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>

    <script>
    // --- WORKER CONFIG ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/pdf.worker.min.js';

    class VisualPDFTool {
        constructor() {
            this.sourceFiles = []; this.pages = []; this.selectedPageIds = new Set();
            this.metadata = { title: '', author: '', subject: '' };
            this.protection = { password: '' };
            this.tempTextOverlays = []; this.activeTextIndex = -1;
            this.pageGrid = document.getElementById('page-grid'); 
            this.init();
        }
        
        async init() {
            this.initEventListeners();
            Sortable.create(this.pageGrid, { animation: 200, ghostClass: 'sortable-ghost', delay: 100, delayOnTouchOnly: true, onEnd: () => this.updateOrder() });
            this.initSignaturePad();
        }

        async addFiles(files) {
            if (files.length === 0) return;
            this.showLoader(true);
            document.getElementById('start-screen').classList.add('hidden');
            document.querySelector('.app-container').classList.remove('hidden');

            for (const file of files) {
                const sourceFile = { id: Math.random().toString(36), name: file.name, type: file.type, file: file };
                if (file.type === 'application/pdf') {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        sourceFile.pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        sourceFile.pdfLibDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                        this.sourceFiles.push(sourceFile);
                        for (let i = 0; i < sourceFile.pdfDoc.numPages; i++) {
                            this.pages.push({ id: Math.random().toString(36), sourceFile, sourcePageIndex: i, rotation: 0, textOverlays: [] });
                        }
                    } catch (e) { alert("Error reading PDF"); }
                } else if (file.type.startsWith('image/')) {
                    this.sourceFiles.push(sourceFile);
                    this.pages.push({ id: Math.random().toString(36), sourceFile, sourcePageIndex: 0, type: 'image', rotation: 0, textOverlays: [] });
                }
            }
            this.renderAllPages();
            this.showLoader(false);
        }

        renderAllPages() {
            this.pageGrid.innerHTML = '';
            this.pages.forEach((p, i) => {
                const item = document.createElement('div');
                item.className = `page-item relative bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg shadow-sm flex flex-col overflow-hidden select-none ${this.selectedPageIds.has(p.id)?'selected':''}`;
                item.dataset.id = p.id;
                
                // Canvas Container
                const cvCont = document.createElement('div');
                cvCont.className = 'w-full h-40 bg-slate-100 dark:bg-slate-900 flex items-center justify-center overflow-hidden';
                const canvas = document.createElement('canvas');
                cvCont.appendChild(canvas);
                
                // Info Bar
                const info = document.createElement('div');
                info.className = 'p-2 text-[10px] bg-white dark:bg-slate-800 border-t flex justify-between items-center';
                info.innerHTML = `<span class="truncate w-20">${p.sourceFile.name}</span><span class="text-slate-400">P ${p.sourcePageIndex+1}</span>`;
                
                // Selection overlay for touch
                const clickArea = document.createElement('div');
                clickArea.className = 'absolute inset-0 z-10';
                clickArea.onclick = (e) => this.toggleSelection(p.id);

                // Edit Button
                const editBtn = document.createElement('button');
                editBtn.className = 'absolute top-2 right-2 z-20 bg-white shadow rounded-full p-1.5 text-indigo-600';
                editBtn.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>';
                editBtn.onclick = (e) => { e.stopPropagation(); this.openPageEditor(p.id); };

                item.appendChild(cvCont);
                item.appendChild(info);
                item.appendChild(editBtn);
                item.appendChild(clickArea);
                this.pageGrid.appendChild(item);
                
                this.renderThumbnail(canvas, p);
            });
            
            // Footer Logic
            const footer = document.getElementById('contextual-footer');
            if(this.selectedPageIds.size > 0) {
                footer.classList.remove('hidden-island');
                document.getElementById('selection-count').innerText = `${this.selectedPageIds.size} Selected`;
            } else {
                footer.classList.add('hidden-island');
            }
        }

        async renderThumbnail(canvas, p) {
            const dpr = window.devicePixelRatio || 1;
            const ctx = canvas.getContext('2d');
            
            if (p.type === 'image') {
                const img = new Image(); img.src = URL.createObjectURL(p.sourceFile.file);
                img.onload = () => {
                    const ratio = img.height/img.width;
                    canvas.width = 150 * dpr; canvas.height = 150 * ratio * dpr;
                    ctx.scale(dpr,dpr);
                    ctx.translate(75, 75*ratio); ctx.rotate((p.rotation*Math.PI)/180);
                    if(p.rotation%180===0) ctx.drawImage(img, -75, -75*ratio, 150, 150*ratio);
                    else ctx.drawImage(img, -75*ratio, -75, 150*ratio, 150);
                };
            } else {
                try {
                    const page = await p.sourceFile.pdfDoc.getPage(p.sourcePageIndex + 1);
                    const vp = page.getViewport({ scale: 1, rotation: p.rotation });
                    const scale = (150 / vp.width) * dpr;
                    const scaledVp = page.getViewport({ scale: scale, rotation: p.rotation });
                    canvas.width = scaledVp.width; canvas.height = scaledVp.height;
                    await page.render({ canvasContext: ctx, viewport: scaledVp }).promise;
                } catch(e){}
            }
        }

        toggleSelection(id) {
            if(this.selectedPageIds.has(id)) this.selectedPageIds.delete(id);
            else this.selectedPageIds.add(id);
            this.renderAllPages();
        }

        updateOrder() {
            const newOrder = [];
            [...this.pageGrid.children].forEach(el => newOrder.push(this.pages.find(p => p.id === el.dataset.id)));
            this.pages = newOrder;
        }

        // --- EDITOR LOGIC (Updated for Touch) ---
        async openPageEditor(pageId) {
            const page = this.pages.find(p => p.id === pageId); if(!page) return;
            this.editingPageId = pageId;
            this.tempTextOverlays = JSON.parse(JSON.stringify(page.textOverlays || []));
            this.activeTextIndex = -1;
            
            const modal = document.getElementById('text-modal');
            modal.classList.remove('hidden');
            
            await this.renderEditorCanvas();
            this.renderOverlayLayers();
        }
        
        async renderEditorCanvas() {
            const page = this.pages.find(p => p.id === this.editingPageId);
            const canvas = document.getElementById('modal-bg-canvas');
            const wrapper = document.getElementById('preview-wrapper');
            const parent = document.getElementById('preview-container-parent');
            
            // Get dimensions
            let w, h, renderTask;
            if(page.type === 'image') {
                const img = new Image(); img.src = URL.createObjectURL(page.sourceFile.file);
                await new Promise(r => img.onload = r);
                w = img.width; h = img.height;
                renderTask = (ctx, w, h) => ctx.drawImage(img, 0, 0, w, h);
            } else {
                const pdfPage = await page.sourceFile.pdfDoc.getPage(page.sourcePageIndex+1);
                const vp = pdfPage.getViewport({scale: 1});
                w = vp.width; h = vp.height;
                renderTask = (ctx, w, h) => pdfPage.render({ canvasContext: ctx, viewport: pdfPage.getViewport({scale: w/vp.width}) }).promise;
            }

            // Fit logic
            const availW = parent.clientWidth - 20;
            const availH = parent.clientHeight - 20;
            const scale = Math.min(availW/w, availH/h);
            
            canvas.width = w * scale; canvas.height = h * scale;
            wrapper.style.width = canvas.width + 'px'; wrapper.style.height = canvas.height + 'px';
            
            const ctx = canvas.getContext('2d');
            // Rotation logic could be added here similar to thumb
            await renderTask(ctx, canvas.width, canvas.height);
        }

        renderOverlayLayers() {
            const container = document.getElementById('overlay-container'); container.innerHTML = '';
            this.tempTextOverlays.forEach((txt, index) => {
                const el = document.createElement('div'); 
                el.className = 'draggable-text'; 
                if(index === this.activeTextIndex) el.classList.add('active');
                
                if(txt.isImage) {
                    const img = document.createElement('img'); img.src = txt.imageData; img.style.width = (txt.size * 2) + 'px';
                    el.appendChild(img);
                } else {
                    el.innerText = txt.text;
                    el.style.fontSize = Math.max(12, txt.size) + 'px'; 
                    el.style.color = txt.color;
                }
                
                el.style.left = `${txt.xPercent}%`; el.style.top = `${txt.yPercent}%`;
                el.style.transform = `translate(-50%, -50%)`; // Simplified for mobile
                
                // EVENTS (Mouse + Touch)
                const startDrag = (e) => {
                    e.preventDefault(); e.stopPropagation();
                    this.activeTextIndex = index; this.renderOverlayLayers();
                    this.updateEditorControls();
                    
                    const rect = container.getBoundingClientRect();
                    const getPos = (ev) => ev.touches ? ev.touches[0] : ev;
                    
                    const move = (ev) => {
                        const clientX = getPos(ev).clientX;
                        const clientY = getPos(ev).clientY;
                        let x = ((clientX - rect.left) / rect.width) * 100;
                        let y = ((clientY - rect.top) / rect.height) * 100;
                        this.tempTextOverlays[index].xPercent = Math.max(0, Math.min(100, x));
                        this.tempTextOverlays[index].yPercent = Math.max(0, Math.min(100, y));
                        el.style.left = `${this.tempTextOverlays[index].xPercent}%`;
                        el.style.top = `${this.tempTextOverlays[index].yPercent}%`;
                    };
                    const stop = () => {
                        document.removeEventListener('mousemove', move);
                        document.removeEventListener('touchmove', move);
                        document.removeEventListener('mouseup', stop);
                        document.removeEventListener('touchend', stop);
                    };
                    document.addEventListener('mousemove', move);
                    document.addEventListener('touchmove', move, { passive: false });
                    document.addEventListener('mouseup', stop);
                    document.addEventListener('touchend', stop);
                };
                
                el.addEventListener('mousedown', startDrag);
                el.addEventListener('touchstart', startDrag, { passive: false });
                container.appendChild(el);
            });
        }
        
        updateEditorControls() {
            if(this.activeTextIndex === -1) return;
            const t = this.tempTextOverlays[this.activeTextIndex];
            if(!t.isImage) {
                document.getElementById('txt-content').value = t.text;
                document.getElementById('txt-color').value = t.color;
                document.getElementById('txt-size').value = t.size;
            }
        }
        
        initSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            const ctx = canvas.getContext('2d');
            const resize = () => { canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight; ctx.lineWidth = 2; };
            // Simple resize observer
            new ResizeObserver(resize).observe(canvas.parentElement);
            
            let painting = false;
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            }
            const start = (e) => { e.preventDefault(); painting = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
            const draw = (e) => { if(!painting) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
            const end = () => painting = false;

            canvas.addEventListener('mousedown', start); canvas.addEventListener('touchstart', start, {passive:false});
            canvas.addEventListener('mousemove', draw); canvas.addEventListener('touchmove', draw, {passive:false});
            document.addEventListener('mouseup', end); document.addEventListener('touchend', end);
            
            document.getElementById('clearSigBtn').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);
            document.getElementById('addSigBtn').onclick = () => {
                this.tempTextOverlays.push({ isImage: true, imageData: canvas.toDataURL(), xPercent: 50, yPercent: 50, size: 50 });
                this.renderOverlayLayers();
            };
        }

        // --- EXPORT LOGIC (FIXED PASSWORD) ---
        async createPdf() {
            if (this.pages.length === 0) return;
            this.showLoader(true, "Encrypting...");

            try {
                const doc = await PDFLib.PDFDocument.create();
                doc.setTitle(this.metadata.title || 'Untitled');
                doc.setAuthor(this.metadata.author || '');

                for (const p of this.pages) {
                    let page;
                    if (p.type === 'image') {
                        const imgBytes = await p.sourceFile.file.arrayBuffer();
                        const img = p.sourceFile.type.includes('png') ? await doc.embedPng(imgBytes) : await doc.embedJpg(imgBytes);
                        page = doc.addPage([img.width, img.height]);
                        page.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });
                    } else {
                        const [cp] = await doc.copyPages(p.sourceFile.pdfLibDoc, [p.sourcePageIndex]);
                        cp.setRotation(PDFLib.degrees((cp.getRotation().angle + p.rotation) % 360));
                        page = doc.addPage(cp);
                    }
                    
                    // Flatten Overlays
                    if(p.textOverlays) {
                        const { width, height } = page.getSize();
                        const helv = await doc.embedFont(PDFLib.StandardFonts.Helvetica);
                        for(const t of p.textOverlays) {
                            const x = width * (t.xPercent/100);
                            const y = height - (height * (t.yPercent/100));
                            if(t.isImage) {
                                const emb = await doc.embedPng(t.imageData);
                                const dims = emb.scaleToFit(t.size*2, t.size*2);
                                page.drawImage(emb, {x: x - dims.width/2, y: y - dims.height/2, width: dims.width, height: dims.height});
                            } else {
                                page.drawText(t.text, { x, y, size: parseInt(t.size), font: helv, color: PDFLib.rgb(0,0,0) }); // Simplified color for stability
                            }
                        }
                    }
                }

                // --- SECURITY FIX ---
                const saveOptions = {};
                if (this.protection.password && this.protection.password.trim() !== '') {
                    saveOptions.userPassword = this.protection.password;
                    saveOptions.ownerPassword = this.protection.password + "_owner"; // Different owner password allows recovery/editing permissions
                    saveOptions.permissions = {
                        printing: 'highResolution', // Allow printing
                        modifying: false, // PREVENT EDITING
                        copying: false,   // PREVENT COPYING TEXT
                        annotating: false,
                        fillingForms: false,
                        contentAccessibility: false
                    };
                }

                const pdfBytes = await doc.save(saveOptions);
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `protected_document.pdf`;
                document.body.appendChild(link);
                link.click();
                link.remove();
                
            } catch (e) {
                alert("Error saving: " + e.message);
                console.error(e);
            }
            this.showLoader(false);
        }
        
        showLoader(show, text) { 
            const el = document.getElementById('loader'); 
            if(show) { el.classList.remove('hidden'); if(text) document.getElementById('loader-text').innerText=text; }
            else el.classList.add('hidden');
        }
        
        initEventListeners() {
            // UI Toggles
            document.getElementById('startChooseFileBtn').onclick = () => document.getElementById('fileInput').click();
            document.getElementById('addFilesBtn').onclick = () => document.getElementById('fileInput').click();
            document.getElementById('fileInput').onchange = (e) => this.addFiles(Array.from(e.target.files));
            document.getElementById('sidebar-close-btn').onclick = () => document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('menu-toggle-btn').onclick = () => document.getElementById('sidebar').classList.remove('-translate-x-full');
            
            // Text Modal
            document.getElementById('openTextModalBtn').onclick = () => { if(this.pages.length) this.openPageEditor(this.pages[0].id); };
            document.querySelector('.close-text-modal').onclick = () => document.getElementById('text-modal').classList.add('hidden');
            document.getElementById('addTextLayerBtn').onclick = () => { 
                this.tempTextOverlays.push({ text: "Text", xPercent: 50, yPercent: 50, size: 24, color: '#000000' }); 
                this.activeTextIndex = this.tempTextOverlays.length-1; 
                this.renderOverlayLayers(); 
                this.updateEditorControls();
            };
            document.getElementById('savePageEdits').onclick = () => {
                const p = this.pages.find(x => x.id === this.editingPageId);
                if(p) p.textOverlays = JSON.parse(JSON.stringify(this.tempTextOverlays));
                document.getElementById('text-modal').classList.add('hidden');
                this.renderAllPages();
            };
            
            // Text Inputs
            ['txt-content','txt-size','txt-color'].forEach(id => {
               document.getElementById(id).addEventListener('input', () => {
                   if(this.activeTextIndex > -1) {
                       const t = this.tempTextOverlays[this.activeTextIndex];
                       t.text = document.getElementById('txt-content').value;
                       t.size = parseInt(document.getElementById('txt-size').value);
                       t.color = document.getElementById('txt-color').value;
                       this.renderOverlayLayers();
                   }
               }) 
            });
            document.getElementById('delete-layer-btn').onclick = () => {
                if(this.activeTextIndex > -1) {
                    this.tempTextOverlays.splice(this.activeTextIndex, 1);
                    this.activeTextIndex = -1;
                    this.renderOverlayLayers();
                }
            };
            
            // Protect
            document.getElementById('openProtectBtn').onclick = () => document.getElementById('protect-modal').classList.remove('hidden');
            document.querySelector('.close-protect-modal').onclick = () => document.getElementById('protect-modal').classList.add('hidden');
            document.getElementById('saveProtectBtn').onclick = () => {
                this.protection.password = document.getElementById('protect-password').value;
                document.getElementById('protect-modal').classList.add('hidden');
                alert(this.protection.password ? "Password Set!" : "Password Removed");
            };
            
            // Footer Actions
            document.getElementById('deleteSelectedBtn').onclick = () => {
                this.pages = this.pages.filter(p => !this.selectedPageIds.has(p.id));
                this.selectedPageIds.clear();
                this.renderAllPages();
            };
            document.getElementById('saveBtn').onclick = () => this.createPdf();
            document.getElementById('clearBtn').onclick = () => location.reload();
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        new VisualPDFTool();
    });
    </script>
</body>
</html>
