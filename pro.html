<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visual PDF Editor Pro</title>

    <!-- LOCAL LIBRARIES -->
    <script src="js/pdf-lib.min.js"></script>
    <script src="js/pdf.min.js"></script>
    <script src="js/sortable.min.js"></script>
    <script src="js/tailwindcss.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    animation: { 
                        'shimmer': 'shimmer 1.5s infinite', 
                        'pop-in': 'popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards'
                    },
                    keyframes: { 
                        shimmer: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } },
                        popIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; user-select: none; overscroll-behavior: none; }
        
        /* CARD ANIMATIONS */
        .page-item { transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1); outline: none; }
        .page-item:hover { transform: translateY(-4px) scale(1.02); z-index: 10; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .page-item.selected { ring: 2px solid #6366f1; transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgb(99 102 241 / 0.15); }
        
        /* DRAG UI */
        .sortable-ghost { opacity: 0.4; background: #e0e7ff; border: 2px dashed #6366f1; }
        .sortable-drag { cursor: grabbing; opacity: 1 !important; background: white; transform: scale(1.05); z-index: 50; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.2); }
        
        /* LAYOUT & UTILS */
        :root { --grid-size: 180px; }
        .view-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--grid-size), 1fr)); gap: 1.5rem; }
        .view-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .view-list .page-item { flex-direction: row; height: 80px; align-items: center; padding: 0.5rem; }
        .view-list .canvas-wrapper { width: 60px; height: 100%; margin-right: 1rem; flex-shrink: 0; }
        .view-list .page-info { border: none; flex: 1; text-align: left; }
        
        #contextual-footer { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; }
        #contextual-footer.hidden-island { transform: translate(-50%, 200%); opacity: 0; pointer-events: none; }
        .marquee-box { position: absolute; border: 1px solid #6366f1; background-color: rgba(99, 102, 241, 0.1); z-index: 50; pointer-events: none; }
        
        .skeleton-shimmer { background: #f1f5f9; position: relative; overflow: hidden; }
        .skeleton-shimmer::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent); animation: shimmer 1.5s infinite; }
        .dark .skeleton-shimmer { background: #334155; }
        .dark .skeleton-shimmer::after { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent); }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }

        /* EDITOR OVERLAYS */
        .draggable-text { position: absolute; cursor: move; cursor: grab; user-select: none; white-space: pre; border: 1px dashed transparent; padding: 4px; line-height: 1; transform-origin: center center; touch-action: none; }
        .draggable-text:active { cursor: grabbing; }
        .draggable-text:hover { border-color: rgba(99, 102, 241, 0.5); }
        .draggable-text.active { border: 1px solid #6366f1; background: rgba(255, 255, 255, 0.1); box-shadow: 0 0 0 1px white, 0 4px 6px rgba(0,0,0,0.1); }
        
        [data-tooltip]:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); padding: 4px 8px; background: #1e293b; color: white; font-size: 10px; border-radius: 4px; white-space: nowrap; z-index: 60; margin-bottom: 6px; pointer-events: none; }
        #signature-pad { touch-action: none; cursor: crosshair; }
        
        /* Mobile Helper */
        @media (max-width: 768px) {
            .view-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
            #contextual-footer { width: 90%; border-radius: 1rem; flex-direction: row; padding: 0.75rem 1rem; bottom: 1.5rem; }
            #contextual-footer span { display: none; }
        }
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="icon-192.png">
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 h-full overflow-hidden transition-colors duration-200">

    <!-- OVERLAYS -->
    <div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-3 z-[100] pointer-events-none"></div>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity backdrop-blur-sm"></div>
    <iframe id="printFrame" class="hidden"></iframe>
    <input type="file" id="stampInput" accept="image/png, image/jpeg" class="hidden">

    <!-- CONTEXT MENU -->
    <div id="context-menu" class="hidden fixed z-50 bg-white dark:bg-slate-800 shadow-xl rounded-lg border border-slate-200 dark:border-slate-700 w-52 py-1 transform scale-100 origin-top-left animate-pop-in">
        <button id="ctx-edit" class="w-full text-left px-4 py-2.5 text-sm font-bold text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-slate-700 flex items-center gap-3"><span>‚úé</span> Edit Page</button>
        <button id="ctx-split" class="w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3"><span>‚úÇ</span> Split Half (L/R)</button>
        <div class="h-px bg-slate-200 dark:bg-slate-700 my-1"></div>
        <button id="ctx-rotate-cw" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-3"><span>‚Ü∑</span> Rotate Right</button>
        <button id="ctx-duplicate" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-3"><span>‚ùê</span> Duplicate</button>
        <div class="h-px bg-slate-200 dark:bg-slate-700 my-1"></div>
        <button id="ctx-delete" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-3"><span>üóë</span> Delete</button>
    </div>

    <!-- START SCREEN -->
    <div id="start-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-900 via-slate-900 to-black p-4 overflow-y-auto">
        <div class="w-full max-w-4xl bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row my-auto">
            <div class="p-8 md:p-10 md:w-1/2 flex flex-col justify-center text-left text-white border-b md:border-b-0 md:border-r border-white/10">
                <div class="inline-flex w-fit items-center gap-2 bg-emerald-500/20 border border-emerald-500/40 text-emerald-300 px-3 py-1 rounded-full text-xs font-medium mb-4">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                    HIPAA Ready: 100% Local
                </div>
                <h1 class="text-3xl md:text-4xl font-bold mb-4 tracking-tight">Visual PDF Editor <span class="text-indigo-400">Pro</span></h1>
                <p class="opacity-80 mb-6 text-base md:text-lg font-light leading-relaxed">Securely merge, organize, and protect documents locally.</p>
                <div id="restore-banner" class="hidden bg-indigo-600/30 border border-indigo-500/50 p-4 rounded-lg">
                    <p class="text-sm">‚ö†Ô∏è Previous session found.</p>
                    <button id="restoreBtn" class="mt-2 text-sm bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded transition w-full md:w-auto">Restore Session</button>
                </div>
            </div>
            <div class="p-8 md:p-10 md:w-1/2 bg-black/20 flex flex-col justify-center items-center">
                <div id="startDropZone" class="w-full aspect-square border-2 border-dashed border-slate-500/50 rounded-2xl flex flex-col items-center justify-center hover:bg-white/5 hover:border-indigo-400 transition-all cursor-pointer group relative overflow-hidden">
                    <div class="absolute inset-0 bg-indigo-500/10 blur-3xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <svg class="w-16 h-16 text-slate-500 group-hover:text-indigo-400 transition-colors mb-4 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="text-slate-400 font-medium relative z-10">Drag files here</p>
                    <p class="text-slate-600 text-sm mt-2 relative z-10">PDF, JPG, PNG</p>
                    <button id="startChooseFileBtn" class="mt-6 bg-white text-slate-900 hover:bg-indigo-50 font-bold py-2 px-6 rounded-full shadow-lg transition relative z-10">Browse Files</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div class="app-container hidden flex h-screen">
        <!-- SIDEBAR -->
        <aside id="sidebar" class="w-72 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col flex-shrink-0 z-40 fixed md:relative h-full transition-all duration-300 transform -translate-x-full md:translate-x-0 shadow-xl md:shadow-none">
            
            <!-- HEADER -->
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                <div>
                    <h2 class="font-bold text-lg">Source Files</h2>
                    <div class="flex items-center gap-1 text-[10px] text-green-600 dark:text-green-400 font-bold uppercase tracking-wider">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        Local &amp; Secure
                    </div>
                </div>
                <button id="sidebar-close-btn" class="md:hidden text-slate-500 hover:text-slate-800 dark:hover:text-white">‚úï</button>
            </div>

            <div id="sourceFileList" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scroll">
                <!-- Dynamically populated -->
            </div>

            <div class="p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 space-y-3">
                <button id="insertBlankBtn" class="w-full py-2.5 px-4 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 text-sm font-medium text-left flex items-center gap-3 transition shadow-sm group"><span class="text-indigo-500 font-bold group-hover:scale-110 transition">+</span> <span class="truncate">Insert Blank</span></button>
                <button id="openTextModalBtn" class="w-full py-2.5 px-4 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 text-sm font-medium text-left flex items-center gap-3 transition shadow-sm group"><span class="text-indigo-500 font-bold group-hover:scale-110 transition">‚úé</span> <span class="truncate">Edit / Sign</span></button>
                <button id="openMetadataBtn" class="w-full py-2.5 px-4 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 text-sm font-medium text-left flex items-center gap-3 transition shadow-sm group"><span class="text-indigo-500 font-bold group-hover:scale-110 transition">‚öô</span> <span class="truncate">Metadata</span></button>
                <button id="openProtectBtn" class="w-full py-2.5 px-4 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 text-sm font-medium text-left flex items-center gap-3 transition shadow-sm group"><span class="text-indigo-500 font-bold group-hover:scale-110 transition">üîí</span> <span class="truncate">Protect / Encrypt</span></button>
                
                <!-- RANGE SELECTION TOOL -->
                <div>
                    <label class="block text-xs text-slate-500 mb-1">Select Range (e.g. 1-3, 5)</label>
                    <div class="flex gap-2">
                        <input type="text" id="rangeInput" class="flex-1 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="1-3, 5">
                        <button id="selectRangeBtn" class="bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 px-3 py-1 rounded text-sm font-medium">Go</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN VIEW -->
        <main id="main-view" class="flex-1 flex flex-col min-w-0 bg-slate-100 dark:bg-slate-900/50 relative transition-all duration-300">
            <header class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-sm z-30 px-4 py-3 flex flex-wrap gap-4 items-center justify-between">
                <div class="flex items-center gap-4">
                    <button id="menu-toggle-btn" class="md:hidden text-slate-500 p-2 hover:bg-slate-100 rounded">‚ò∞</button>
                    <div class="flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                        <button id="viewGridBtn" class="p-1.5 rounded bg-white dark:bg-slate-600 shadow-sm text-indigo-600" data-tooltip="Grid View"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg></button>
                        <button id="viewListBtn" class="p-1.5 rounded hover:bg-slate-200 dark:hover:bg-slate-500 text-slate-500" data-tooltip="List View"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button>
                    </div>
                    <div class="flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                        <button id="undoBtn" disabled class="p-1.5 rounded hover:bg-white dark:hover:bg-slate-600 disabled:opacity-30 transition text-slate-600 dark:text-slate-300" data-tooltip="Undo"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg></button>
                        <button id="redoBtn" disabled class="p-1.5 rounded hover:bg-white dark:hover:bg-slate-600 disabled:opacity-30 transition text-slate-600 dark:text-slate-300" data-tooltip="Redo"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10H11a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/></svg></button>
                    </div>
                    <div class="hidden sm:flex items-center gap-2"><input type="range" id="zoomSlider" min="100" max="300" value="180" class="w-24 h-1 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-indigo-600"></div>
                    <span id="auto-save-indicator" class="text-xs text-emerald-500 font-medium opacity-0 transition-opacity flex items-center gap-1">Saved <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                </div>
                <div class="flex items-center gap-3">
                    <button id="sortByAlphaBtn" class="text-xs font-bold px-3 py-1.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 rounded text-slate-600 dark:text-slate-300 transition" data-tooltip="Sort A-Z">A-Z</button>
                    <button id="sortByNumberBtn" class="text-xs font-bold px-3 py-1.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 rounded text-slate-600 dark:text-slate-300 transition" data-tooltip="Sort 1-9">1-9</button>
                    <button id="clearBtn" class="text-xs font-bold px-3 py-1.5 bg-red-50 hover:bg-red-100 dark:bg-red-900/20 dark:hover:bg-red-900/40 text-red-600 dark:text-red-400 rounded transition">Clear</button>
                    <div class="hidden sm:block h-6 w-px bg-slate-300 dark:bg-slate-600 mx-1"></div>
                    <div class="hidden sm:flex items-center gap-1 text-sm bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded px-2 py-1"><input type="text" id="filenameInput" value="document" class="bg-transparent border-none outline-none w-24 text-right"><span class="text-slate-400">.pdf</span></div>
                    <button id="darkModeToggle" class="p-2 text-slate-400 hover:text-indigo-500 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button>
                    <button id="addFilesBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-1.5 px-4 rounded shadow-md transition hover:-translate-y-0.5 flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> Add</button>
                    <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.jpg,.jpeg,.png">
                </div>
            </header>

            <div id="page-grid-container" class="flex-1 overflow-y-auto p-4 md:p-8 relative custom-scroll">
                <div id="page-grid" class="view-grid pb-32"></div>
                <div id="empty-grid-state" class="hidden absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-50"><div class="text-6xl mb-4">üìÑ</div><p class="text-xl font-light">Workspace is empty</p><p class="text-sm">Add files to get started</p></div>
            </div>

            <footer id="contextual-footer" class="fixed bottom-6 md:bottom-8 left-1/2 -translate-x-1/2 hidden-island z-40 bg-slate-900/95 dark:bg-white/95 text-white dark:text-slate-900 backdrop-blur-xl rounded-full shadow-2xl px-6 py-3 flex items-center gap-4 md:gap-6 border border-slate-700 dark:border-slate-200 transition-all duration-300">
                <div class="flex items-center gap-3 text-sm font-medium border-r border-slate-600 dark:border-slate-300 pr-4 md:pr-6">
                    <span id="selection-count" class="hidden md:inline">0 selected</span>
                    <button id="selectAllBtn" class="text-indigo-400 dark:text-indigo-600 hover:underline">All</button>
                    <span class="opacity-50">/</span>
                    <button id="deselectAllBtn" class="hover:text-slate-300 dark:hover:text-slate-600 underline decoration-dotted">None</button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="duplicateSelectedBtn" class="p-2 hover:bg-white/10 dark:hover:bg-slate-200 rounded-full transition" data-tooltip="Duplicate (Ctrl+D)"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                    <button id="rotateSelectedBtn" class="p-2 hover:bg-white/10 dark:hover:bg-slate-200 rounded-full transition" data-tooltip="Rotate"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
                    <button id="deleteSelectedBtn" class="p-2 hover:bg-red-500/20 text-red-400 hover:text-red-300 dark:text-red-600 dark:hover:text-red-700 rounded-full transition" data-tooltip="Delete"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                </div>
                <div class="h-6 w-px bg-slate-600 dark:bg-slate-300"></div>
                <div class="relative">
                    <button id="exportMenuBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white pl-5 pr-3 py-1.5 rounded-full text-sm font-bold shadow-lg shadow-indigo-500/30 transition flex items-center gap-2">Export <svg class="w-4 h-4 transition-transform duration-200" id="exportArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>
                    <div id="exportMenuDropdown" class="hidden absolute bottom-full right-0 mb-3 w-56 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden text-left z-50 animate-pop-in">
                        <button id="saveBtn" class="w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-indigo-50 dark:hover:bg-slate-700 flex items-center gap-3"><span>üíæ</span> Save All Pages</button>
                        <button id="saveSelectedBtn" class="w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-indigo-50 dark:hover:bg-slate-700 flex items-center gap-3"><span>üìù</span> Save Selected Only</button>
                        <button id="printBtn" class="w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-indigo-50 dark:hover:bg-slate-700 flex items-center gap-3"><span>üñ®</span> Print</button>
                        <div class="h-px bg-slate-200 dark:bg-slate-700"></div>
                        <div class="px-4 py-3 bg-slate-50 dark:bg-slate-800/50"><label class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 cursor-pointer select-none"><input type="checkbox" id="addPageNumbersCheckbox" class="rounded text-indigo-600 focus:ring-indigo-500"> Add Page Numbers</label></div>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <!-- METADATA MODAL -->
    <div id="metadata-modal" class="fixed inset-0 z-[60] bg-black/80 hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300 m-4">
            <h3 class="text-xl font-bold mb-4 dark:text-white">PDF Properties</h3>
            <div class="space-y-3">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Title</label><input type="text" id="meta-title" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Author</label><input type="text" id="meta-author" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Subject</label><input type="text" id="meta-subject" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
            </div>
            <div class="mt-6 flex justify-end gap-2"><button class="close-meta-modal px-4 py-2 text-sm text-slate-500 hover:text-slate-700 dark:text-slate-400">Cancel</button><button id="saveMetadataBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold">Save</button></div>
        </div>
    </div>

    <!-- PASSWORD/PROTECT MODAL -->
    <div id="protect-modal" class="fixed inset-0 z-[60] bg-black/80 hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300 border border-slate-200 dark:border-slate-700 m-4">
            <div class="flex items-center gap-3 mb-4 text-indigo-600 dark:text-indigo-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                <h3 class="text-xl font-bold dark:text-white">Protect Document</h3>
            </div>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Set a password to encrypt the final PDF. This password will be required to open the file.</p>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Document Password</label>
                    <input type="password" id="protect-password" placeholder="Enter password..." class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button class="close-protect-modal px-4 py-2 text-sm text-slate-500 hover:text-slate-700 dark:text-slate-400">Cancel</button>
                <button id="saveProtectBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold">Set Password</button>
            </div>
        </div>
    </div>

    <!-- TEXT/EDITOR MODAL -->
    <div id="text-modal" class="fixed inset-0 z-[60] bg-black/80 hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <!-- Changed to full screen on mobile, limited on desktop -->
        <div class="bg-white dark:bg-slate-800 w-full h-full md:max-w-7xl md:h-[90vh] md:rounded-2xl shadow-2xl overflow-hidden flex flex-col transform md:scale-95 scale-100 transition-transform duration-300">
            <div class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-4"><h3 class="font-bold text-lg text-slate-800 dark:text-white">Page Editor</h3><div class="hidden md:block h-4 w-px bg-slate-300 dark:bg-slate-600"></div><p id="editor-page-info" class="hidden md:block text-slate-500 text-sm"></p></div>
                <div class="flex gap-2"><button id="savePageEdits" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 md:px-6 py-2 rounded-lg text-sm font-bold transition shadow-md">Save</button><button class="close-text-modal text-slate-500 hover:text-slate-800 dark:hover:text-white px-3 font-medium">Cancel</button></div>
            </div>
            <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
                <!-- Sidebar Tools: Full width on mobile, 20rem on desktop -->
                <div class="w-full md:w-80 h-1/3 md:h-full bg-slate-50 dark:bg-slate-900 border-b md:border-b-0 md:border-r border-slate-200 dark:border-slate-700 flex flex-col overflow-y-auto p-4 md:p-6 z-10 shadow-lg custom-scroll shrink-0">
                    <!-- IMAGE TOOLS -->
                    <div class="mb-6 pb-6 border-b border-slate-200 dark:border-slate-700">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Crop & Filters</label>
                        <div class="flex gap-2 mb-3"><button id="toggleCropBtn" class="flex-1 p-2 bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 rounded text-xs font-medium border border-slate-200 dark:border-slate-700 transition">‚úÇ Toggle Crop Mode</button></div>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <div><label class="text-[10px] text-slate-500">Brightness</label><input type="range" id="filter-brightness" min="0" max="200" value="100" class="w-full h-1.5 bg-slate-200 rounded-lg"></div>
                            <div><label class="text-[10px] text-slate-500">Contrast</label><input type="range" id="filter-contrast" min="0" max="200" value="100" class="w-full h-1.5 bg-slate-200 rounded-lg"></div>
                        </div>
                        
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Stamps</label>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button class="stamp-btn w-full bg-red-100 text-red-700 border border-red-200 py-1.5 rounded text-xs font-bold" data-text="CONFIDENTIAL" data-color="#DC2626">CONFIDENTIAL</button>
                            <button class="stamp-btn w-full bg-green-100 text-green-700 border border-green-200 py-1.5 rounded text-xs font-bold" data-text="APPROVED" data-color="#16A34A">APPROVED</button>
                            <button class="stamp-btn w-full bg-blue-100 text-blue-700 border border-blue-200 py-1.5 rounded text-xs font-bold" data-text="DRAFT" data-color="#2563EB">DRAFT</button>
                            <button class="stamp-btn w-full bg-yellow-100 text-yellow-700 border border-yellow-200 py-1.5 rounded text-xs font-bold" data-text="COPY" data-color="#CA8A04">COPY</button>
                        </div>
                        <button id="uploadStampBtn" class="w-full py-1.5 text-xs border border-dashed border-slate-400 text-slate-500 rounded hover:bg-slate-50 dark:hover:bg-slate-800">Upload Image / Logo</button>
                    </div>

                    <div class="space-y-4 flex-1">
                        <!-- SIGNATURE -->
                        <div class="p-4 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
                            <label class="block text-xs font-bold text-slate-500 mb-2">SIGNATURE</label>
                            <div class="border border-slate-200 rounded h-24 mb-2 bg-white relative cursor-crosshair overflow-hidden touch-none" id="sig-pad-container"><canvas id="signature-pad" class="w-full h-full block touch-none"></canvas><div class="absolute bottom-1 right-1 text-[10px] text-slate-400 pointer-events-none">Draw here</div></div>
                            <div class="flex gap-2"><button id="addSigBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-1.5 rounded text-xs font-bold transition">Add Signature</button><button id="clearSigBtn" class="px-3 bg-slate-100 hover:bg-slate-200 text-slate-600 py-1.5 rounded text-xs transition">Clear</button></div>
                        </div>

                        <!-- TEXT TOOLS -->
                        <div class="p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800">
                            <label class="block text-xs font-bold text-indigo-900 dark:text-indigo-300 mb-2">TEXT OVERLAY</label>
                            <div class="flex gap-2 mb-2"><button id="txt-bold-btn" class="style-btn w-8 h-8 rounded border bg-white font-bold text-xs" title="Bold">B</button><button id="txt-italic-btn" class="style-btn w-8 h-8 rounded border bg-white italic font-serif text-xs" title="Italic">I</button></div>
                            <textarea id="txt-content" placeholder="Type text here..." class="w-full h-16 text-sm p-3 rounded-lg border-0 focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-800 mb-2 resize-none shadow-sm"></textarea>
                            
                            <!-- RESTORED: QUICK POS GRID -->
                            <div class="grid grid-cols-3 gap-1 mb-2">
                                <button class="pos-btn p-1 bg-white dark:bg-slate-800 border rounded hover:bg-slate-50" data-pos="tl">‚Üñ</button>
                                <button class="pos-btn p-1 bg-white dark:bg-slate-800 border rounded hover:bg-slate-50" data-pos="tc">‚Üë</button>
                                <button class="pos-btn p-1 bg-white dark:bg-slate-800 border rounded hover:bg-slate-50" data-pos="tr">‚Üó</button>
                                <button class="pos-btn p-1 bg-white dark:bg-slate-800 border rounded hover:bg-slate-50" data-pos="cl">‚Üê</button>
                                <button class="pos-btn p-1 bg-white dark:bg-slate-800 border rounded hover:bg-slate-50" data-pos="cc">‚óè</button>
                                <button class="pos-btn p-1 bg-white dark:bg-slate-800 border rounded hover:bg-slate-50" data-pos="cr">‚Üí</button>
                                <button class="pos-btn p-1 bg-white dark:bg-slate-800 border rounded hover:bg-slate-50" data-pos="bl">‚Üô</button>
                                <button class="pos-btn p-1 bg-white dark:bg-slate-800 border rounded hover:bg-slate-50" data-pos="bc">‚Üì</button>
                                <button class="pos-btn p-1 bg-white dark:bg-slate-800 border rounded hover:bg-slate-50" data-pos="br">‚Üò</button>
                            </div>

                            <button id="addTextLayerBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg text-sm font-medium shadow-sm transition">Add Text Layer</button>
                        </div>
                        
                        <div id="layer-controls" class="hidden space-y-4 opacity-50 pointer-events-none transition-opacity">
                            <div class="h-px bg-slate-200 dark:bg-slate-700"></div><div class="flex justify-between items-center"><span class="text-xs font-bold text-slate-400 uppercase">Selected Layer</span><button id="delete-layer-btn" class="text-red-500 text-xs hover:underline font-bold">Remove</button></div>
                            <div class="grid grid-cols-2 gap-3"><div><label class="text-xs text-slate-500 mb-1 block">Font</label><select id="txt-font" class="w-full text-sm p-1.5 rounded border border-slate-200 dark:border-slate-600 bg-transparent"><option value="Helvetica">Helvetica</option><option value="TimesRoman">Times</option><option value="Courier">Courier</option></select></div><div><label class="text-xs text-slate-500 mb-1 block">Size (px)</label><input type="number" id="txt-size" class="w-full text-sm p-1.5 rounded border border-slate-200 dark:border-slate-600 bg-transparent"></div></div>
                            <div class="grid grid-cols-2 gap-3"><div><label class="text-xs text-slate-500 mb-1 block">Color</label><input type="color" id="txt-color" class="w-full h-8 cursor-pointer rounded"></div><div><label class="text-xs text-slate-500 mb-1 block">Opacity</label><input type="range" id="txt-opacity" min="0.1" max="1" step="0.1" value="1" class="w-full h-2 bg-slate-200 rounded-lg mt-2"></div></div>
                            <div><label class="text-xs text-slate-500 mb-1 block">Text Rotation</label><input type="range" id="txt-rotation" min="-180" max="180" class="w-full h-2 bg-slate-200 rounded-lg accent-indigo-600"></div>
                            <div><label class="flex items-center gap-2 text-xs text-slate-500"><input type="checkbox" id="txt-shadow" class="rounded text-indigo-600"> Add Shadow (for contrast)</label></div>
                        </div>
                    </div>
                </div>
                <!-- Preview Canvas Area -->
                <div id="preview-container-parent" class="flex-1 bg-slate-200 dark:bg-slate-950 flex items-center justify-center p-4 md:p-8 overflow-hidden relative touch-none">
                    <div id="preview-wrapper" class="relative shadow-2xl transition-transform duration-200 ease-out origin-center bg-white"><canvas id="modal-bg-canvas" class="block"></canvas><div id="overlay-container" class="absolute inset-0"></div><div id="crop-overlay" class="absolute inset-0 hidden pointer-events-none border-4 border-indigo-500/50 z-50 flex items-center justify-center"><div class="bg-indigo-600 text-white text-xs px-2 py-1 rounded">Crop Preview (Non-Destructive)</div></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="loader" class="fixed inset-0 z-[100] bg-white/90 dark:bg-slate-900/90 flex flex-col items-center justify-center hidden backdrop-blur-sm"><div class="w-12 h-12 border-4 border-slate-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div><p id="loader-text" class="text-slate-600 dark:text-slate-300 font-medium animate-pulse">Processing...</p></div>

    <script>
    // --- WORKER CONFIG ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/pdf.worker.min.js';

    // --- INDEXED DB MANAGER (Robust Offline Storage) ---
    class LocalStorageManager {
        constructor(dbName='PDFEditorDB', storeName='StateStore') { this.dbName=dbName; this.storeName=storeName; this.db=null; }
        async init() { return new Promise((resolve, reject) => { const req = indexedDB.open(this.dbName, 1); req.onerror = e => reject(e); req.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains(this.storeName)) e.target.result.createObjectStore(this.storeName); }; req.onsuccess = e => { this.db = e.target.result; resolve(); }; }); }
        async saveState(sourceFiles, pages, metadata, protection) { if(!this.db) await this.init(); const serialized = sourceFiles.map(f => ({ id: f.id, name: f.name, type: f.type, file: f.file })); const state = { sourceFiles: serialized, pages: pages, metadata: metadata, protection: protection }; return new Promise((r, j) => { const tx=this.db.transaction([this.storeName], 'readwrite'); tx.objectStore(this.storeName).put(state, 'currentState'); tx.oncomplete=r; tx.onerror=j; }); }
        async loadState() { if(!this.db) await this.init(); return new Promise((r, j) => { const tx=this.db.transaction([this.storeName], 'readonly'); const req=tx.objectStore(this.storeName).get('currentState'); req.onsuccess=()=>r(req.result); req.onerror=j; }); }
        async clear() { if(!this.db) await this.init(); const tx=this.db.transaction([this.storeName], 'readwrite'); tx.objectStore(this.storeName).clear(); }
    }

    class VisualPDFTool {
        constructor() {
            this.sourceFiles = []; this.pages = []; this.selectedPageIds = new Set();
            this.metadata = { title: '', author: '', subject: '' };
            this.protection = { password: '' }; // State for password
            this.historyStack = []; this.redoStack = []; this.maxHistory = 20;
            this.dbManager = new LocalStorageManager();
            this.observer = null; this.contextTargetId = null;
            this.editingPageId = null; this.tempTextOverlays = []; this.activeTextIndex = -1; this.tempRotation = 0; 
            this.tempBrightness = 100; this.tempContrast = 100; this.isCropping = false;
            this.pageGrid = document.getElementById('page-grid'); 
            this.textModal = document.getElementById('text-modal'); 
            this.metaModal = document.getElementById('metadata-modal'); 
            this.protectModal = document.getElementById('protect-modal');
            this.contextMenu = document.getElementById('context-menu');
            this.lastSelectedId = null;
            this.init();
        }
        async init() {
            this.initSortable(); this.initEventListeners(); this.initIntersectionObserver(); this.initContextMenu(); this.initMarqueeSelection(); this.initSignaturePad();
            this.checkTheme(); document.documentElement.style.setProperty('--grid-size', '180px');
            try { 
                await this.dbManager.init(); 
                const saved = await this.dbManager.loadState(); 
                if(saved && saved.pages.length > 0) { 
                    if(saved.metadata) this.metadata = saved.metadata; 
                    if(saved.protection) this.protection = saved.protection;
                    // Show Restore Banner if session found
                    document.getElementById('restore-banner').classList.remove('hidden'); 
                    document.getElementById('restoreBtn').addEventListener('click', () => this.restoreSession(saved)); 
                } 
            } catch(e) { console.log("DB Init Error", e); }
        }
        checkTheme() { if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark'); }
        safeAddListener(id, event, handler) { const el = document.getElementById(id); if (el) el.addEventListener(event, handler); }
        showToast(message, type='success') { const container = document.getElementById('toast-container'); const el = document.createElement('div'); const color = type === 'error' ? 'bg-red-500' : 'bg-indigo-600'; el.className = `${color} text-white px-4 py-3 rounded-lg shadow-lg animate-slide-up flex items-center gap-2`; el.innerHTML = `<span>${type==='error'?'‚ö†Ô∏è':'‚úì'}</span><span>${message}</span>`; container.appendChild(el); setTimeout(() => el.remove(), 3000); }
        autoSaveNotify() { const indicator = document.getElementById('auto-save-indicator'); indicator.classList.remove('opacity-0'); setTimeout(() => indicator.classList.add('opacity-0'), 2000); }
        
        // FILES
        async addFiles(files) {
            if (files.length === 0) return;
            this.showLoader(true, 'Processing Files...');
            if (this.pages.length === 0) { 
                document.getElementById('start-screen').classList.add('hidden'); 
                document.querySelector('.app-container').classList.remove('hidden'); 
            }
            for (const file of files) {
                const fileId = `file_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const sourceFile = { id: fileId, name: file.name, type: file.type, file: file };
                if (file.type.startsWith('image/')) { 
                    this.sourceFiles.push(sourceFile); 
                    this.addPageToData(sourceFile, 0, 'image'); 
                } else if (file.type === 'application/pdf') {
                    try { 
                        const arrayBuffer = await file.arrayBuffer(); 
                        const bufferCopy = arrayBuffer.slice(0); 
                        sourceFile.pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise; 
                        sourceFile.pdfLibDoc = await PDFLib.PDFDocument.load(bufferCopy); 
                        this.sourceFiles.push(sourceFile); 
                        for (let i = 0; i < sourceFile.pdfDoc.numPages; i++) { this.addPageToData(sourceFile, i, 'pdf'); } 
                    } catch (err) { console.error(err); this.showToast(`Error loading ${file.name}`, 'error'); }
                }
            }
            this.updateSourceFileList(); this.renderNewPages(); this.updateStatus(); await this.saveState(); this.showLoader(false);
        }
        addPageToData(sourceFile, index, type) { this.pages.push({ id: `page_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, sourceFile: sourceFile, sourcePageIndex: index, type: type, rotation: 0, brightness: 100, contrast: 100, crop: {x:0, y:0, w:1, h:1}, textOverlays: [] }); }
        insertBlankPage() { this.saveState(); let blankSource = this.sourceFiles.find(f => f.id === 'virtual_blank'); if (!blankSource) { blankSource = { id: 'virtual_blank', name: 'Blank Page', type: 'blank' }; this.sourceFiles.push(blankSource); } this.addPageToData(blankSource, 0, 'blank'); this.renderNewPages(); this.updateStatus(); }
        updateSourceFileList() {
            const el = document.getElementById('sourceFileList'); if(!el) return;
            const activeFiles = new Set(this.pages.map(p => p.sourceFile.id));
            const files = this.sourceFiles.filter(f => activeFiles.has(f.id) || f.type === 'blank');
            if(files.length === 0) { el.innerHTML = '<div id="empty-source-state" class="text-center py-10 opacity-50"><svg class="w-10 h-10 mx-auto mb-2 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path></svg><p class="text-[10px] uppercase tracking-wider">Empty</p></div>'; } else { el.innerHTML = files.map(f => `<div class="p-2.5 text-xs bg-white dark:bg-slate-700 rounded-lg mb-2 shadow-sm border border-slate-200 dark:border-slate-600 flex items-center gap-3 group hover:scale-[1.02] transition-transform cursor-default"><div class="w-8 h-8 rounded bg-slate-100 dark:bg-slate-600 flex items-center justify-center text-lg">${f.type.includes('image')?'üñº':'üìÑ'}</div><div class="flex-1 truncate font-medium text-slate-700 dark:text-slate-200">${f.name}</div></div>`).join(''); }
        }

        // RENDERING
        initIntersectionObserver() { const container = document.getElementById('page-grid-container'); if(!container) return; this.observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { this.observer.unobserve(entry.target); const p = this.pages.find(page => page.id === entry.target.dataset.id); if(p) this.actuallyDrawCanvas(entry.target, p); } }); }, { root: container, rootMargin: '300px', threshold: 0 }); }
        renderAllPages() { this.pageGrid.innerHTML = ''; this.pages.forEach((p, i) => this.renderThumbnail(p, i)); }
        renderNewPages() { const existingIds = new Set([...this.pageGrid.children].map(el => el.dataset.id)); this.pages.forEach((p, i) => { if (!existingIds.has(p.id)) this.renderThumbnail(p, i); }); }
        async renderThumbnail(pageData, index) {
            const item = document.createElement('div'); item.className = 'page-item group relative cursor-pointer overflow-hidden flex flex-col h-full rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm'; item.dataset.id = pageData.id; item.setAttribute('tabindex', '0');
            const hasText = pageData.textOverlays && pageData.textOverlays.length > 0;
            const badgeHtml = hasText ? '<div class="absolute top-2 right-2 bg-indigo-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow z-10">T</div>' : '';
            const isSplit = pageData.crop && pageData.crop.w < 1;
            const widthStyle = isSplit ? 'width:50%; margin:0 auto;' : 'width:100%';
            item.innerHTML = `<div class="absolute top-2 left-2 z-20 opacity-0 group-hover:opacity-100 transition-opacity page-checkbox-wrapper"><input type="checkbox" class="page-checkbox w-5 h-5 cursor-pointer accent-indigo-600 rounded"></div>${badgeHtml}<div class="canvas-wrapper flex-1 bg-slate-50 dark:bg-slate-900/50 relative overflow-hidden flex items-center justify-center p-2"><div class="skeleton-shimmer w-full h-full absolute inset-0 z-0"></div><div class="relative shadow-sm bg-white z-10 opacity-0 transition-opacity duration-300 w-full h-full flex items-center justify-center" id="cv-cont-${pageData.id}"><canvas class="page-canvas max-w-full max-h-full object-contain block" style="${widthStyle}"></canvas></div></div><div class="page-info px-3 py-2 bg-white dark:bg-slate-800 border-t border-slate-100 dark:border-slate-700 text-xs flex justify-between items-center h-10"><div class="flex flex-col min-w-0"><span class="font-medium text-slate-700 dark:text-slate-200 truncate">${pageData.sourceFile.name}</span><span class="text-[10px] text-slate-400">Page ${pageData.sourcePageIndex + 1}</span></div><div class="page-actions flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button class="rotate-ccw-btn hover:text-indigo-600 text-slate-400 p-1" data-tooltip="Rotate Left">‚Ü∂</button><input type="text" class="page-order-input w-6 text-center bg-transparent font-bold text-slate-500" value="${index + 1}" disabled><button class="rotate-cw-btn hover:text-indigo-600 text-slate-400 p-1" data-tooltip="Rotate Right">‚Ü∑</button></div></div>`;
            item.querySelector('.page-checkbox').addEventListener('click', (e) => { e.stopPropagation(); this.toggleSelection(pageData.id); }); this.pageGrid.appendChild(item); this.observer.observe(item);
        }
        async actuallyDrawCanvas(item, pageData) {
            const canvas = item.querySelector('canvas'); const container = item.querySelector(`#cv-cont-${pageData.id}`); const skeleton = item.querySelector('.skeleton-shimmer'); const dpr = window.devicePixelRatio || 1;
            const ctx = canvas.getContext('2d');
            const crop = pageData.crop || {x:0, y:0, w:1, h:1};
            
            if (pageData.type === 'blank') { canvas.width = 150*dpr; canvas.height = 200*dpr; ctx.scale(dpr,dpr); ctx.fillStyle='white'; ctx.fillRect(0,0,150,200); ctx.strokeStyle='#e2e8f0'; ctx.strokeRect(0,0,150,200); } 
            else if (pageData.type === 'image') { 
                const img = new Image(); const url = URL.createObjectURL(pageData.sourceFile.file); img.src = url; 
                img.onload = () => { 
                    const visualW = img.width * crop.w; const visualH = img.height * crop.h; const ratio = visualH / visualW; 
                    canvas.width = 200 * dpr; canvas.height = 200 * ratio * dpr; 
                    ctx.scale(dpr, dpr); ctx.translate(100, 100 * ratio); ctx.rotate((pageData.rotation * Math.PI) / 180);
                    const sx = img.width * crop.x; const sy = img.height * crop.y; const sW = img.width * crop.w; const sH = img.height * crop.h;
                    if(pageData.rotation % 180 !== 0) ctx.drawImage(img, sx, sy, sW, sH, -100 * ratio, -100, 200 * ratio, 200); else ctx.drawImage(img, sx, sy, sW, sH, -100, -100 * ratio, 200, 200 * ratio); 
                    URL.revokeObjectURL(url); 
                }; 
            } 
            else { 
                try { 
                    const page = await pageData.sourceFile.pdfDoc.getPage(pageData.sourcePageIndex + 1); 
                    const viewport = page.getViewport({ scale: 1, rotation: pageData.rotation });
                    const scale = (250 / viewport.width) * dpr;
                    const croppedVp = page.getViewport({ scale: scale, rotation: pageData.rotation });
                    canvas.width = croppedVp.width * crop.w; canvas.height = croppedVp.height * crop.h;
                    ctx.save(); ctx.translate(-croppedVp.width * crop.x, -croppedVp.height * crop.y);
                    await page.render({ canvasContext: ctx, viewport: croppedVp }).promise;
                    ctx.restore();
                } catch(e) {} 
            }
            if(skeleton) skeleton.remove(); container.classList.remove('opacity-0');
        }
        
        splitPage(pageId) {
            const index = this.pages.findIndex(p => p.id === pageId);
            if (index > -1) {
                const p = this.pages[index];
                const p1 = JSON.parse(JSON.stringify(p)); p1.id = `page_${Date.now()}_L`; p1.crop = { x: 0, y: 0, w: 0.5, h: 1 };
                const p2 = JSON.parse(JSON.stringify(p)); p2.id = `page_${Date.now()}_R`; p2.crop = { x: 0.5, y: 0, w: 0.5, h: 1 };
                this.pages.splice(index, 1, p1, p2); this.saveState(); this.renderAllPages(); this.showToast("Page Split Successfully");
            }
        }

        // NEW: RANGE SELECTION LOGIC
        selectRange() {
            const input = document.getElementById('rangeInput');
            if (!input) return;
            const val = input.value.trim();
            if (!val) return;

            this.selectedPageIds.clear();
            const parts = val.split(',');
            
            parts.forEach(part => {
                part = part.trim();
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(n => parseInt(n.trim()));
                    if (!isNaN(start) && !isNaN(end)) {
                        for (let i = start; i <= end; i++) {
                            // Convert 1-based user input to 0-indexed array
                            if (i > 0 && i <= this.pages.length) {
                                this.selectedPageIds.add(this.pages[i-1].id);
                            }
                        }
                    }
                } else {
                    const num = parseInt(part);
                    if (!isNaN(num) && num > 0 && num <= this.pages.length) {
                        this.selectedPageIds.add(this.pages[num-1].id);
                    }
                }
            });
            this.updateSelectionUI();
            this.showToast(`Selected ${this.selectedPageIds.size} pages`);
        }

        // EDITOR
        async openPageEditor(pageId) {
            const page = this.pages.find(p => p.id === pageId); if(!page) return;
            this.editingPageId = pageId; 
            this.tempTextOverlays = JSON.parse(JSON.stringify(page.textOverlays || [])); 
            this.tempRotation = page.rotation; 
            this.tempBrightness = page.brightness || 100; this.tempContrast = page.contrast || 100;
            this.activeTextIndex = -1;
            document.getElementById('editor-page-info').innerText = `${page.sourceFile.name} (Page ${page.sourcePageIndex + 1})`;
            document.getElementById('filter-brightness').value = this.tempBrightness;
            document.getElementById('filter-contrast').value = this.tempContrast;
            this.textModal.classList.remove('hidden', 'opacity-0'); this.textModal.querySelector('div').classList.remove('scale-95', 'md:scale-95');
            await this.renderEditorCanvas(); this.renderOverlayLayers();
        }
        async renderEditorCanvas() {
            const page = this.pages.find(p => p.id === this.editingPageId); const canvas = document.getElementById('modal-bg-canvas'); const wrapper = document.getElementById('preview-wrapper'); const container = document.getElementById('preview-container-parent'); const ctx = canvas.getContext('2d'); const dpr = window.devicePixelRatio || 1;
            let natWidth, natHeight; let imgBitmap = null; let pdfPageProxy = null;
            if (page.type === 'blank') { natWidth = 595; natHeight = 842; } 
            else if (page.type === 'image') { const url = URL.createObjectURL(page.sourceFile.file); const img = new Image(); img.src = url; await new Promise(r => img.onload = r); natWidth = img.width; natHeight = img.height; imgBitmap = img; URL.revokeObjectURL(url); } 
            else { pdfPageProxy = await page.sourceFile.pdfDoc.getPage(page.sourcePageIndex + 1); const vp = pdfPageProxy.getViewport({ scale: 1 }); natWidth = vp.width; natHeight = vp.height; }
            
            const crop = page.crop || {x:0, y:0, w:1, h:1};
            const cropW = natWidth * crop.w; const cropH = natHeight * crop.h;
            const totalRotation = (this.tempRotation) % 360; const isRotated = (totalRotation === 90 || totalRotation === 270);
            const displayWidth = isRotated ? cropH : cropW; const displayHeight = isRotated ? cropW : cropH;
            const availW = container.clientWidth - 40; const availH = container.clientHeight - 40; 
            const scale = Math.min(availW / displayWidth, availH / displayHeight);
            const finalW = displayWidth * scale; const finalH = displayHeight * scale;
            
            wrapper.style.width = `${finalW}px`; wrapper.style.height = `${finalH}px`;
            canvas.width = finalW * dpr; canvas.height = finalH * dpr; canvas.style.width = "100%"; canvas.style.height = "100%";
            ctx.scale(dpr, dpr); ctx.save(); 
            ctx.translate(finalW/2, finalH/2); ctx.rotate((totalRotation * Math.PI) / 180);
            if (this.tempBrightness != 100 || this.tempContrast != 100) ctx.filter = `brightness(${this.tempBrightness}%) contrast(${this.tempContrast}%)`;
            ctx.translate(-cropW*scale/2, -cropH*scale/2);

            if (page.type === 'blank') { ctx.fillStyle = 'white'; ctx.fillRect(0, 0, cropW*scale, cropH*scale); } 
            else if (page.type === 'image') { ctx.drawImage(imgBitmap, natWidth*crop.x, natHeight*crop.y, natWidth*crop.w, natHeight*crop.h, 0, 0, cropW*scale, cropH*scale); } 
            else { 
                ctx.save(); ctx.translate(-natWidth*crop.x*scale, -natHeight*crop.y*scale);
                const renderContext = { canvasContext: ctx, viewport: pdfPageProxy.getViewport({ scale: scale }) }; 
                await pdfPageProxy.render(renderContext).promise; ctx.restore(); 
            }
            ctx.restore();
        }
        renderOverlayLayers() {
            const container = document.getElementById('overlay-container'); container.innerHTML = '';
            this.tempTextOverlays.forEach((txt, index) => {
                const el = document.createElement('div'); el.className = 'draggable-text'; if(index === this.activeTextIndex) el.classList.add('active'); el.innerText = txt.text;
                if(txt.isImage) { el.innerText = ''; const img = document.createElement('img'); img.src = txt.imageData; img.style.width = '100px'; el.appendChild(img); el.style.border = 'none'; }
                el.style.left = `${txt.xPercent}%`; el.style.top = `${txt.yPercent}%`; el.style.fontSize = `${txt.size}px`; el.style.color = txt.color; el.style.opacity = txt.opacity;
                el.style.transform = `translate(-50%, -50%) rotate(${txt.rotation}deg)`; el.style.fontFamily = txt.font === 'TimesRoman' ? 'serif' : (txt.font === 'Courier' ? 'monospace' : 'sans-serif');
                if(txt.isBold) el.style.fontWeight = 'bold'; if(txt.isItalic) el.style.fontStyle = 'italic'; if(txt.hasShadow) el.style.textShadow = '1px 1px 2px rgba(0,0,0,0.8)';
                
                // Add both mouse and touch listeners for text dragging
                el.addEventListener('mousedown', e => { e.stopPropagation(); this.setActiveLayer(index); this.startDrag(e, index, container); });
                el.addEventListener('touchstart', e => { e.stopPropagation(); e.preventDefault(); this.setActiveLayer(index); this.startDrag(e, index, container); }, {passive: false});
                
                container.appendChild(el);
            });
            const controls = document.getElementById('layer-controls');
            if(this.activeTextIndex > -1) {
                controls.classList.remove('hidden', 'opacity-50', 'pointer-events-none'); const l = this.tempTextOverlays[this.activeTextIndex];
                document.getElementById('txt-content').value = l.isImage ? '' : l.text; document.getElementById('txt-size').value = l.size; document.getElementById('txt-color').value = l.color; document.getElementById('txt-font').value = l.font; document.getElementById('txt-rotation').value = l.rotation; const op = document.getElementById('txt-opacity'); if(op) op.value = l.opacity;
                document.getElementById('txt-shadow').checked = !!l.hasShadow; document.getElementById('txt-bold-btn').classList.toggle('active', !!l.isBold); document.getElementById('txt-italic-btn').classList.toggle('active', !!l.isItalic);
            } else { controls.classList.add('opacity-50', 'pointer-events-none'); }
        }
        addTextLayerToEditor() { const text = document.getElementById('txt-content').value || "New Text"; this.tempTextOverlays.push({ text, xPercent: 50, yPercent: 50, size: 24, color: '#000000', opacity: 1, rotation: 0, font: 'Helvetica', isBold: false, isItalic: false, hasShadow: false }); this.activeTextIndex = this.tempTextOverlays.length - 1; this.renderOverlayLayers(); }
        addStamp(text, color) { this.tempTextOverlays.push({ text: text, xPercent: 50, yPercent: 50, size: 60, color: color, opacity: 0.3, rotation: 45, font: 'Helvetica', isBold: true, isItalic: false }); this.activeTextIndex = this.tempTextOverlays.length - 1; this.renderOverlayLayers(); }
        uploadStamp(file) { const reader = new FileReader(); reader.onload = e => { this.tempTextOverlays.push({ text: '', xPercent: 50, yPercent: 50, size: 100, color: 'transparent', opacity: 1, rotation: 0, font: 'Helvetica', isImage: true, imageData: e.target.result }); this.renderOverlayLayers(); }; reader.readAsDataURL(file); }
        setTextPosition(pos) { if(this.activeTextIndex === -1) return; const l = this.tempTextOverlays[this.activeTextIndex]; const m = 10; if(pos.includes('l')) l.xPercent = m; if(pos.includes('r')) l.xPercent = 100-m; if(pos.includes('c') && pos[0] !== 'c') l.xPercent=50; else if(pos=='cc') l.xPercent=50; if(pos.includes('t')) l.yPercent = m; if(pos.includes('b')) l.yPercent = 100-m; if(pos.includes('c') && pos[1] !== 'c') l.yPercent=50; else if(pos=='cc') l.yPercent=50; this.renderOverlayLayers(); }
        toggleBold() { if(this.activeTextIndex > -1) { this.tempTextOverlays[this.activeTextIndex].isBold = !this.tempTextOverlays[this.activeTextIndex].isBold; this.renderOverlayLayers(); } }
        toggleItalic() { if(this.activeTextIndex > -1) { this.tempTextOverlays[this.activeTextIndex].isItalic = !this.tempTextOverlays[this.activeTextIndex].isItalic; this.renderOverlayLayers(); } }
        toggleShadow() { if(this.activeTextIndex > -1) { this.tempTextOverlays[this.activeTextIndex].hasShadow = !this.tempTextOverlays[this.activeTextIndex].hasShadow; this.renderOverlayLayers(); } }
        setActiveLayer(index) { this.activeTextIndex = index; this.renderOverlayLayers(); }
        deleteActiveLayer() { if(this.activeTextIndex > -1) { this.tempTextOverlays.splice(this.activeTextIndex, 1); this.activeTextIndex = -1; this.renderOverlayLayers(); } }
        updateActiveTextLayer() { if(this.activeTextIndex === -1) return; const l = this.tempTextOverlays[this.activeTextIndex]; if(!l.isImage) l.text = document.getElementById('txt-content').value; l.size = parseInt(document.getElementById('txt-size').value); l.color = document.getElementById('txt-color').value; l.font = document.getElementById('txt-font').value; l.rotation = parseInt(document.getElementById('txt-rotation').value); l.opacity = parseFloat(document.getElementById('txt-opacity').value); this.renderOverlayLayers(); }
        editorRotate(deg) { this.tempRotation = (this.tempRotation + deg) % 360; this.renderEditorCanvas(); this.renderOverlayLayers(); }
        updateFilter(type, val) { if(type === 'brightness') this.tempBrightness = val; if(type === 'contrast') this.tempContrast = val; this.renderEditorCanvas(); }
        toggleCrop() { this.isCropping = !this.isCropping; document.getElementById('crop-overlay').classList.toggle('hidden', !this.isCropping); this.showToast(this.isCropping ? "Crop Mode Active (Visual Only)" : "Crop Cancelled"); }
        
        startDrag(e, index, container) { 
            let isDragging = true; 
            const rect = container.getBoundingClientRect(); 
            
            // Helper to extract clientX/Y from either mouse or touch event
            const getClientPos = (ev) => {
                if (ev.touches && ev.touches.length > 0) {
                    return { x: ev.touches[0].clientX, y: ev.touches[0].clientY };
                }
                return { x: ev.clientX, y: ev.clientY };
            };

            const moveHandler = (ev) => { 
                if(!isDragging) return; 
                ev.preventDefault(); // Stop mobile scrolling while dragging overlay
                const pos = getClientPos(ev);
                const x = pos.x - rect.left; 
                const y = pos.y - rect.top; 
                this.tempTextOverlays[index].xPercent = Math.max(0, Math.min(100, (x / rect.width) * 100)); 
                this.tempTextOverlays[index].yPercent = Math.max(0, Math.min(100, (y / rect.height) * 100)); 
                this.renderOverlayLayers(); 
            }; 
            const upHandler = () => { 
                isDragging = false; 
                document.removeEventListener('mousemove', moveHandler); 
                document.removeEventListener('mouseup', upHandler); 
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('touchend', upHandler);
            }; 
            
            document.addEventListener('mousemove', moveHandler); 
            document.addEventListener('mouseup', upHandler);
            document.addEventListener('touchmove', moveHandler, {passive: false});
            document.addEventListener('touchend', upHandler);
        }

        initSignaturePad() {
            const canvas = document.getElementById('signature-pad'); 
            const ctx = canvas.getContext('2d'); 
            let painting = false;
            const resize = () => { 
                canvas.width = canvas.parentElement.offsetWidth; 
                canvas.height = canvas.parentElement.offsetHeight; 
                ctx.lineWidth = 3; 
                ctx.lineCap = 'round'; 
            }; 
            resize();
            // Debounced resize observer might be better but simple works
            window.addEventListener('resize', resize);

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            }

            const start = (e) => { 
                painting = true; 
                if(e.type === 'touchstart') e.preventDefault();
                ctx.beginPath();
                const pos = getPos(e);
                ctx.moveTo(pos.x, pos.y);
            }; 
            
            const end = (e) => { 
                if(e.type === 'touchend') e.preventDefault();
                painting = false; 
                ctx.beginPath(); 
            };
            
            const draw = (e) => { 
                if (!painting) return; 
                if(e.type === 'touchmove') e.preventDefault();
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y); 
                ctx.stroke(); 
                ctx.beginPath(); 
                ctx.moveTo(pos.x, pos.y); 
            };

            canvas.addEventListener('mousedown', start); 
            canvas.addEventListener('mouseup', end); 
            canvas.addEventListener('mousemove', draw);
            // Touch events
            canvas.addEventListener('touchstart', start, {passive: false});
            canvas.addEventListener('touchend', end);
            canvas.addEventListener('touchmove', draw, {passive: false});

            document.getElementById('clearSigBtn').addEventListener('click', () => ctx.clearRect(0,0,canvas.width,canvas.height));
            document.getElementById('addSigBtn').addEventListener('click', () => { this.tempTextOverlays.push({ text: '', xPercent: 50, yPercent: 50, size: 100, color: 'transparent', opacity: 1, rotation: 0, font: 'Helvetica', isImage: true, imageData: canvas.toDataURL() }); this.renderOverlayLayers(); });
        }
        
        savePageEdits() { if (!this.editingPageId) return; const page = this.pages.find(p => p.id === this.editingPageId); if (!page) { this.showToast("Error saving: Page not found", "error"); return; } page.textOverlays = JSON.parse(JSON.stringify(this.tempTextOverlays)); page.rotation = this.tempRotation; page.brightness = this.tempBrightness; page.contrast = this.tempContrast; this.saveState(); this.showToast("Changes saved"); this.renderAllPages(); this.textModal.classList.add('hidden', 'opacity-0'); this.textModal.querySelector('div').classList.add('scale-95', 'md:scale-95'); }
        
        // PROTECTION / METADATA
        openMetadataModal() { document.getElementById('meta-title').value = this.metadata.title; document.getElementById('meta-author').value = this.metadata.author; document.getElementById('meta-subject').value = this.metadata.subject; this.metaModal.classList.remove('hidden', 'opacity-0'); this.metaModal.querySelector('div').classList.remove('scale-95'); }
        saveMetadata() { this.metadata.title = document.getElementById('meta-title').value; this.metadata.author = document.getElementById('meta-author').value; this.metadata.subject = document.getElementById('meta-subject').value; this.saveState(); this.metaModal.classList.add('hidden', 'opacity-0'); this.metaModal.querySelector('div').classList.add('scale-95'); this.showToast("Metadata saved"); }
        openProtectModal() { document.getElementById('protect-password').value = this.protection.password || ''; this.protectModal.classList.remove('hidden', 'opacity-0'); this.protectModal.querySelector('div').classList.remove('scale-95'); }
        saveProtection() { this.protection.password = document.getElementById('protect-password').value; this.saveState(); this.protectModal.classList.add('hidden', 'opacity-0'); this.protectModal.querySelector('div').classList.add('scale-95'); this.showToast(this.protection.password ? "Password Set" : "Password Removed"); }

        // INTERACTIONS
        initContextMenu() { document.addEventListener('click', () => this.contextMenu.classList.add('hidden')); this.pageGrid.addEventListener('contextmenu', e => { const item = e.target.closest('.page-item'); if(!item) return; e.preventDefault(); this.contextTargetId = item.dataset.id; let x = e.clientX, y = e.clientY; if(x + 200 > window.innerWidth) x = window.innerWidth - 210; if(y + 200 > window.innerHeight) y = window.innerHeight - 210; this.contextMenu.style.left = `${x}px`; this.contextMenu.style.top = `${y}px`; this.contextMenu.classList.remove('hidden'); }); this.safeAddListener('ctx-edit', 'click', () => this.openPageEditor(this.contextTargetId)); this.safeAddListener('ctx-split', 'click', () => this.splitPage(this.contextTargetId)); this.safeAddListener('ctx-delete', 'click', () => this.deletePages([this.contextTargetId])); this.safeAddListener('ctx-duplicate', 'click', () => { this.selectedPageIds.clear(); this.selectedPageIds.add(this.contextTargetId); this.duplicateSelected(); }); this.safeAddListener('ctx-rotate-cw', 'click', () => this.rotatePages([this.contextTargetId], 90)); this.safeAddListener('ctx-rotate-ccw', 'click', () => this.rotatePages([this.contextTargetId], -90)); }
        async restoreSession(saved) { this.showLoader(true, 'Restoring Session...'); this.sourceFiles = []; for (const f of saved.sourceFiles) { const source = { id: f.id, name: f.name, type: f.type, file: f.file }; if(f.type === 'application/pdf') { const ab = await f.file.arrayBuffer(); source.pdfDoc = await pdfjsLib.getDocument({ data: ab }).promise; source.pdfLibDoc = await PDFLib.PDFDocument.load(ab); } this.sourceFiles.push(source); } this.pages = []; saved.pages.forEach(p => { const source = this.sourceFiles.find(s => s.id === p.sourceFileId); if(source) this.pages.push({ id: p.id, sourceFile: source, sourcePageIndex: p.sourcePageIndex, type: p.type, rotation: p.rotation, textOverlays: p.textOverlays, brightness: p.brightness, contrast: p.contrast, crop: p.crop || {x:0,y:0,w:1,h:1} }); }); document.getElementById('start-screen').classList.add('hidden'); document.querySelector('.app-container').classList.remove('hidden'); this.renderAllPages(); this.updateStatus(); this.showLoader(false); }
        saveState() { const snapshot = this.pages.map(p => ({ id: p.id, sourceFileId: p.sourceFile.id, sourcePageIndex: p.sourcePageIndex, type: p.type, rotation: p.rotation, textOverlays: JSON.parse(JSON.stringify(p.textOverlays || [])), brightness: p.brightness, contrast: p.contrast, crop: p.crop })); this.historyStack.push(snapshot); if(this.historyStack.length > this.maxHistory) this.historyStack.shift(); this.redoStack = []; this.updateHistoryButtons(); this.dbManager.saveState(this.sourceFiles, snapshot, this.metadata, this.protection); this.autoSaveNotify(); }
        restoreState(snapshot) { this.pages = []; snapshot.forEach(item => { const source = this.sourceFiles.find(f => f.id === item.sourceFileId); if(source) this.pages.push({ id: item.id, sourceFile: source, sourcePageIndex: item.sourcePageIndex, type: item.type, rotation: item.rotation, textOverlays: item.textOverlays || [], brightness: item.brightness, contrast: item.contrast, crop: item.crop || {x:0,y:0,w:1,h:1} }); }); this.selectedPageIds.clear(); this.renderAllPages(); this.updateStatus(); this.dbManager.saveState(this.sourceFiles, snapshot, this.metadata, this.protection); }
        performUndo() { if(this.historyStack.length) { this.redoStack.push(this.snapshotCurrentState()); this.restoreState(this.historyStack.pop()); this.updateHistoryButtons(); } }
        performRedo() { if(this.redoStack.length) { this.historyStack.push(this.snapshotCurrentState()); this.restoreState(this.redoStack.pop()); this.updateHistoryButtons(); } }
        snapshotCurrentState() { return this.pages.map(p => ({ id: p.id, sourceFileId: p.sourceFile.id, sourcePageIndex: p.sourcePageIndex, type: p.type, rotation: p.rotation, textOverlays: JSON.parse(JSON.stringify(p.textOverlays || [])), brightness: p.brightness, contrast: p.contrast, crop: p.crop })); }
        updateHistoryButtons() { const u = document.getElementById('undoBtn'); if(u) u.disabled = !this.historyStack.length; const r = document.getElementById('redoBtn'); if(r) r.disabled = !this.redoStack.length; }
        initSortable() { Sortable.create(this.pageGrid, { animation: 200, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', onStart: () => {}, onEnd: () => { this.saveState(); this.updateDataOrderFromDOM(); } }); }
        handlePageClick(e) { const item = e.target.closest('.page-item'); if (!item) return; if (e.target.closest('.rotate-cw-btn')) { this.rotatePages([item.dataset.id], 90); return; } else if (e.target.closest('.rotate-ccw-btn')) { this.rotatePages([item.dataset.id], -90); return; } const id = item.dataset.id; 
            if (e.shiftKey && this.lastSelectedId) { const all = [...this.pageGrid.children]; const start = all.findIndex(el => el.dataset.id === this.lastSelectedId); const end = all.findIndex(el => el.dataset.id === id); if(start > -1 && end > -1) { const range = all.slice(Math.min(start, end), Math.max(start, end) + 1); range.forEach(el => this.selectedPageIds.add(el.dataset.id)); } } else if (e.ctrlKey || e.metaKey) { this.toggleSelection(id); } else { this.selectedPageIds.clear(); this.selectedPageIds.add(id); } this.lastSelectedId = id; this.updateSelectionUI(); }
        toggleSelection(id) { if (this.selectedPageIds.has(id)) this.selectedPageIds.delete(id); else this.selectedPageIds.add(id); this.updateSelectionUI(); }
        updateSelectionUI() { [...this.pageGrid.children].forEach(el => { const s = this.selectedPageIds.has(el.dataset.id); if(s) { el.classList.add('selected'); el.querySelector('.page-checkbox').checked=true; el.querySelector('.page-checkbox-wrapper').classList.remove('opacity-0'); } else { el.classList.remove('selected'); el.querySelector('.page-checkbox').checked=false; el.querySelector('.page-checkbox-wrapper').classList.add('opacity-0'); } }); document.getElementById('selection-count').innerText = `${this.selectedPageIds.size} selected`; if(this.selectedPageIds.size > 0) document.getElementById('contextual-footer').classList.remove('hidden-island'); else document.getElementById('contextual-footer').classList.add('hidden-island'); }
        deleteSelectedPages() { if (this.selectedPageIds.size) this.deletePages(Array.from(this.selectedPageIds)); }
        deletePages(ids) { this.saveState(); this.pages = this.pages.filter(p => !ids.includes(p.id)); this.selectedPageIds.clear(); this.renderAllPages(); this.updateStatus(); this.showToast('Pages deleted'); }
        duplicateSelected() { if (!this.selectedPageIds.size) return; this.saveState(); const newPages = []; this.pages.forEach(p => { newPages.push(p); if (this.selectedPageIds.has(p.id)) { newPages.push({ id: `page_${Date.now()}_dup_${Math.random().toString(36).substr(2, 9)}`, sourceFile: p.sourceFile, sourcePageIndex: p.sourcePageIndex, type: p.type, rotation: p.rotation, textOverlays: JSON.parse(JSON.stringify(p.textOverlays || [])), brightness: p.brightness, contrast: p.contrast, crop: p.crop }); } }); this.pages = newPages; this.renderAllPages(); this.updateStatus(); this.showToast('Pages duplicated'); }
        rotateSelectedPages(deg) { if (this.selectedPageIds.size) this.rotatePages(Array.from(this.selectedPageIds), deg); }
        rotatePages(ids, deg) { this.saveState(); ids.forEach(id => { const p = this.pages.find(x => x.id === id); if (p) p.rotation = (p.rotation + deg + 360) % 360; }); this.renderAllPages(); this.showToast('Pages rotated'); }
        sortByNumber() { this.saveState(); const map = new Map(); document.querySelectorAll('.page-order-input').forEach(i => map.set(i.closest('.page-item').dataset.id, parseInt(i.value) || 9999)); this.pages.sort((a, b) => map.get(a.id) - map.get(b.id)); this.renderAllPages(); this.showToast('Sorted by number'); }
        sortByAlpha() { this.saveState(); this.pages.sort((a,b) => a.sourceFile.name.localeCompare(b.sourceFile.name)); this.renderAllPages(); this.showToast('Sorted A-Z'); }
        updateDataOrderFromDOM() { const newPages = []; [...this.pageGrid.children].forEach(el => newPages.push(this.pages.find(p => p.id === el.dataset.id))); this.pages = newPages; this.renderAllPages(); }
        updateStatus() { this.updateSelectionUI(); if(this.pages.length === 0) this.clearWorkspace(); }
        async clearWorkspace() { if(!confirm("Clear everything?")) return; this.saveState(); this.pages = []; this.sourceFiles = []; this.selectedPageIds.clear(); this.renderAllPages(); document.getElementById('start-screen').classList.remove('hidden'); document.querySelector('.app-container').classList.add('hidden'); await this.dbManager.clear(); }
        showLoader(show, text = 'Processing...') { const loader = document.getElementById('loader'); if(loader) { loader.classList.toggle('hidden', !show); document.getElementById('loader-text').innerText = text; } }
        toggleSidebar(show){ document.querySelector('.app-container').classList.toggle('sidebar-mobile-open', show); document.getElementById('sidebar-overlay').classList.toggle('hidden', !show); if(show) document.getElementById('sidebar').classList.remove('-translate-x-full'); else document.getElementById('sidebar').classList.add('-translate-x-full'); }
        toggleSidebarSize() { const sb = document.getElementById('sidebar'); sb.classList.toggle('w-72'); sb.classList.toggle('w-16'); const labels = sb.querySelectorAll('.text-sm, .text-xs, .truncate'); labels.forEach(l => l.classList.toggle('hidden')); }
        initMarqueeSelection() { const container = document.getElementById('page-grid-container'); if(!container) return; let isSelecting=false, startX, startY, marquee=null; container.addEventListener('mousedown', e => { if(e.target !== container && e.target !== document.getElementById('page-grid')) return; isSelecting=true; const rect=container.getBoundingClientRect(); startX=e.clientX-rect.left+container.scrollLeft; startY=e.clientY-rect.top+container.scrollTop; marquee=document.createElement('div'); marquee.className='marquee-box'; marquee.style.left=startX+'px'; marquee.style.top=startY+'px'; container.appendChild(marquee); if(!e.ctrlKey&&!e.shiftKey) { this.selectedPageIds.clear(); this.updateSelectionUI(); } }); container.addEventListener('mousemove', e => { if(!isSelecting) return; const rect=container.getBoundingClientRect(); const currentX=e.clientX-rect.left+container.scrollLeft; const currentY=e.clientY-rect.top+container.scrollTop; const width=Math.abs(currentX-startX); const height=Math.abs(currentY-startY); marquee.style.width=width+'px'; marquee.style.height=height+'px'; marquee.style.left=Math.min(currentX,startX)+'px'; marquee.style.top=Math.min(currentY,startY)+'px'; }); document.addEventListener('mouseup', () => { if(!isSelecting) return; isSelecting=false; if(marquee) { const marqueeRect=marquee.getBoundingClientRect(); document.querySelectorAll('.page-item').forEach(item => { const itemRect=item.getBoundingClientRect(); if (marqueeRect.left<itemRect.right && marqueeRect.right>itemRect.left && marqueeRect.top<itemRect.bottom && marqueeRect.bottom>itemRect.top) { this.selectedPageIds.add(item.dataset.id); } }); marquee.remove(); } this.updateSelectionUI(); }); }
        initEventListeners() {
            document.addEventListener('keydown', e => { if ((e.ctrlKey||e.metaKey) && e.key === 'z') { e.preventDefault(); this.performUndo(); } if ((e.ctrlKey||e.metaKey) && e.key === 'y') { e.preventDefault(); this.performRedo(); } if ((e.key === 'Delete'||e.key === 'Backspace') && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) this.deleteSelectedPages(); if ((e.ctrlKey||e.metaKey) && e.key === 'a') { e.preventDefault(); this.pages.forEach(p=>this.selectedPageIds.add(p.id)); this.updateSelectionUI(); } if(['ArrowRight','ArrowLeft'].includes(e.key) && document.activeElement.classList.contains('page-item')) { const items = [...document.querySelectorAll('.page-item')]; const idx = items.indexOf(document.activeElement); if(e.key==='ArrowRight' && idx < items.length-1) items[idx+1].focus(); if(e.key==='ArrowLeft' && idx > 0) items[idx-1].focus(); } });
            window.addEventListener('beforeunload', e => { if (this.pages.length > 0) { e.preventDefault(); e.returnValue = ''; } });
            document.getElementById('exportMenuBtn').addEventListener('click', e => { e.stopPropagation(); document.getElementById('exportMenuDropdown').classList.toggle('hidden'); }); document.addEventListener('click', () => document.getElementById('exportMenuDropdown').classList.add('hidden'));
            this.safeAddListener('undoBtn', 'click', () => this.performUndo()); this.safeAddListener('redoBtn', 'click', () => this.performRedo()); this.safeAddListener('zoomSlider', 'input', e => document.documentElement.style.setProperty('--grid-size', `${e.target.value}px`)); this.safeAddListener('darkModeToggle', 'click', () => document.documentElement.classList.toggle('dark'));
            this.safeAddListener('viewGridBtn', 'click', () => { document.getElementById('page-grid').className = 'grid gap-6 dynamic-grid pb-20 view-grid'; }); this.safeAddListener('viewListBtn', 'click', () => { document.getElementById('page-grid').className = 'view-list pb-20'; });
            this.safeAddListener('addFilesBtn', 'click', () => document.getElementById('fileInput').click()); this.safeAddListener('startChooseFileBtn', 'click', () => document.getElementById('fileInput').click()); this.safeAddListener('fileInput', 'change', async (e) => { await this.addFiles(Array.from(e.target.files)); e.target.value = ''; });
            this.safeAddListener('sidebar-close-btn', 'click', () => this.toggleSidebar(false)); this.safeAddListener('menu-toggle-btn', 'click', () => this.toggleSidebar(true)); this.safeAddListener('toggleSidebarSize', 'click', () => this.toggleSidebarSize());
            this.safeAddListener('insertBlankBtn', 'click', () => this.insertBlankPage()); this.safeAddListener('openTextModalBtn', 'click', () => { if(this.pages.length > 0) this.openPageEditor(this.pages[0].id); else this.showToast('Add pages first', 'error'); });
            const closeText = document.querySelector('.close-text-modal'); if(closeText) closeText.addEventListener('click', () => { this.textModal.classList.add('hidden', 'opacity-0'); this.textModal.querySelector('div').classList.add('scale-95', 'md:scale-95'); });
            this.safeAddListener('addTextLayerBtn', 'click', () => this.addTextLayerToEditor()); this.safeAddListener('editor-rotate-cw', 'click', () => this.editorRotate(90)); this.safeAddListener('editor-rotate-ccw', 'click', () => this.editorRotate(-90)); this.safeAddListener('savePageEdits', 'click', () => this.savePageEdits());
            ['txt-content', 'txt-size', 'txt-color', 'txt-rotation', 'txt-font', 'txt-opacity'].forEach(id => { const el = document.getElementById(id); if(el) el.addEventListener('input', () => this.updateActiveTextLayer()); });
            this.safeAddListener('txt-shadow', 'change', () => this.toggleShadow()); this.safeAddListener('txt-bold-btn', 'click', () => this.toggleBold()); this.safeAddListener('txt-italic-btn', 'click', () => this.toggleItalic());
            this.safeAddListener('delete-layer-btn', 'click', () => this.deleteActiveLayer()); this.safeAddListener('selectAllBtn', 'click', () => { this.pages.forEach(p=>this.selectedPageIds.add(p.id)); this.updateSelectionUI(); }); this.safeAddListener('deselectAllBtn', 'click', () => { this.selectedPageIds.clear(); this.updateSelectionUI(); });
            this.safeAddListener('deleteSelectedBtn', 'click', () => this.deleteSelectedPages()); this.safeAddListener('rotateSelectedBtn', 'click', () => this.rotateSelectedPages(90)); this.safeAddListener('duplicateSelectedBtn', 'click', () => this.duplicateSelected());
            this.safeAddListener('sortByNumberBtn', 'click', () => this.sortByNumber()); this.safeAddListener('sortByAlphaBtn', 'click', () => this.sortByAlpha()); this.safeAddListener('clearBtn', 'click', () => this.clearWorkspace());
            this.safeAddListener('saveBtn', 'click', () => this.createPdf()); this.safeAddListener('saveSelectedBtn', 'click', () => this.createPdf(false, false, true)); this.safeAddListener('printBtn', 'click', () => this.createPdf(false, true)); this.safeAddListener('previewBtn', 'click', () => this.createPdf(true));
            this.safeAddListener('openMetadataBtn', 'click', () => this.openMetadataModal()); this.safeAddListener('saveMetadataBtn', 'click', () => this.saveMetadata());
            const closeMeta = document.querySelector('.close-meta-modal'); if(closeMeta) closeMeta.addEventListener('click', () => { this.metaModal.classList.add('hidden', 'opacity-0'); this.metaModal.querySelector('div').classList.add('scale-95'); });
            this.safeAddListener('openProtectBtn', 'click', () => this.openProtectModal()); this.safeAddListener('saveProtectBtn', 'click', () => this.saveProtection());
            const closeProtect = document.querySelector('.close-protect-modal'); if(closeProtect) closeProtect.addEventListener('click', () => { this.protectModal.classList.add('hidden', 'opacity-0'); this.protectModal.querySelector('div').classList.add('scale-95'); });
            document.querySelectorAll('.pos-btn').forEach(btn => btn.addEventListener('click', e => this.setTextPosition(e.target.dataset.pos))); document.querySelectorAll('.stamp-btn').forEach(btn => btn.addEventListener('click', e => this.addStamp(e.target.dataset.text, e.target.dataset.color)));
            document.getElementById('filter-brightness').addEventListener('input', e => this.updateFilter('brightness', e.target.value)); document.getElementById('filter-contrast').addEventListener('input', e => this.updateFilter('contrast', e.target.value));
            document.getElementById('uploadStampBtn').addEventListener('click', () => document.getElementById('stampInput').click()); document.getElementById('stampInput').addEventListener('change', e => this.uploadStamp(e.target.files[0]));
            document.getElementById('toggleCropBtn').addEventListener('click', () => this.toggleCrop());
            this.safeAddListener('selectRangeBtn', 'click', () => this.selectRange());
            
            // --- START SCREEN DROP ZONE CLICK ---
            const dz = document.getElementById('startDropZone');
            if(dz) dz.addEventListener('click', () => document.getElementById('fileInput').click());
            const startBtn = document.getElementById('startChooseFileBtn');
            if(startBtn) startBtn.addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('fileInput').click(); });

            this.pageGrid.addEventListener('click', this.handlePageClick.bind(this)); this.pageGrid.addEventListener('dblclick', e => { const item = e.target.closest('.page-item'); if (item) this.openPageEditor(item.dataset.id); });
            ['startDropZone', 'main-view'].forEach(id => { const z = document.getElementById(id); if(z) { z.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); z.classList.add('dragover'); }); z.addEventListener('dragleave', e => { e.preventDefault(); e.stopPropagation(); z.classList.remove('dragover'); }); z.addEventListener('drop', e => { e.preventDefault(); e.stopPropagation(); z.classList.remove('dragover'); this.addFiles(Array.from(e.dataTransfer.files)); }); } });
        }
        hexToRgb(hex) { const r = parseInt(hex.substr(1, 2), 16) / 255; const g = parseInt(hex.substr(3, 2), 16) / 255; const b = parseInt(hex.substr(5, 2), 16) / 255; return { r, g, b }; }
        getFont(family, isBold, isItalic) { if (family === 'Helvetica') return isBold && isItalic ? 'HelveticaBoldOblique' : isBold ? 'HelveticaBold' : isItalic ? 'HelveticaOblique' : 'Helvetica'; if (family === 'TimesRoman') return isBold && isItalic ? 'TimesRomanBoldItalic' : isBold ? 'TimesRomanBold' : isItalic ? 'TimesRomanItalic' : 'TimesRoman'; if (family === 'Courier') return isBold && isItalic ? 'CourierBoldOblique' : isBold ? 'CourierBold' : isItalic ? 'CourierOblique' : 'Courier'; return 'Helvetica'; }
        
        // EXPORT
        async createPdf(preview, print, onlySelected) {
            let targetPages = this.pages;
            if(onlySelected && this.selectedPageIds.size > 0) targetPages = this.pages.filter(p => this.selectedPageIds.has(p.id));
            if (!targetPages.length) return; this.showLoader(true, 'Generating PDF...');
            try {
                const doc = await PDFLib.PDFDocument.create(); doc.setTitle(this.metadata.title); doc.setAuthor(this.metadata.author); doc.setSubject(this.metadata.subject);
                const embeddedFonts = {}; const fontList = ['Helvetica','HelveticaBold','HelveticaOblique','HelveticaBoldOblique','TimesRoman','TimesRomanBold','TimesRomanItalic','TimesRomanBoldItalic','Courier','CourierBold','CourierOblique','CourierBoldOblique'];
                for(const f of fontList) embeddedFonts[f] = await doc.embedFont(PDFLib.StandardFonts[f]);
                const addPageNum = document.getElementById('addPageNumbersCheckbox').checked;
                for (let i=0; i<targetPages.length; i++) {
                    const p = targetPages[i]; let page;
                    const crop = p.crop || {x:0, y:0, w:1, h:1};
                    if (p.filter && (p.filter !== 'none' || p.brightness != 100 || p.contrast != 100) && p.sourceFile.type.startsWith('image')) {
                        const img = new Image(); img.src = URL.createObjectURL(p.sourceFile.file); await new Promise(r => img.onload = r);
                        const canvas = document.createElement('canvas'); 
                        canvas.width = img.width * crop.w; canvas.height = img.height * crop.h; const ctx = canvas.getContext('2d');
                        ctx.filter = `brightness(${p.brightness}%) contrast(${p.contrast}%)`; 
                        ctx.drawImage(img, img.width*crop.x, img.height*crop.y, img.width*crop.w, img.height*crop.h, 0, 0, canvas.width, canvas.height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8); const emb = await doc.embedJpg(dataUrl); page = doc.addPage([emb.width, emb.height]); page.drawImage(emb, {x:0, y:0, width: emb.width, height: emb.height});
                    } else {
                        if (p.type === 'blank') page = doc.addPage([595, 842]);
                        else if (p.type === 'image') { 
                            const buff = await p.sourceFile.file.arrayBuffer(); const emb = p.sourceFile.type.includes('png') ? await doc.embedPng(buff) : await doc.embedJpg(buff); const r = p.rotation % 360; const isRotated = r === 90 || r === 270; 
                            const finalW = emb.width * crop.w; const finalH = emb.height * crop.h;
                            page = doc.addPage([isRotated ? finalH : finalW, isRotated ? finalW : finalH]);
                            page.drawImage(emb, { x: -emb.width*crop.x, y: -emb.height*(1-crop.y-crop.h), width: emb.width, height: emb.height, rotate: PDFLib.degrees(r) });
                        } 
                        else { 
                            const [cp] = await doc.copyPages(p.sourceFile.pdfLibDoc, [p.sourcePageIndex]); 
                            const { x, y, width, height } = cp.getMediaBox();
                            cp.setCropBox(x + width * crop.x, y + height * crop.y, width * crop.w, height * crop.h);
                            cp.setRotation(PDFLib.degrees((cp.getRotation().angle + p.rotation) % 360)); 
                            page = doc.addPage(cp); 
                        }
                    }
                    if (p.textOverlays) { const { width, height } = page.getSize(); p.textOverlays.forEach(async t => { const x = width * (t.xPercent / 100); const y = height - (height * (t.yPercent / 100)); 
                        if(t.isImage) { const pngImage = await doc.embedPng(t.imageData); const imgDims = pngImage.scale(0.5); page.drawImage(pngImage, { x: x - imgDims.width/2, y: y - imgDims.height/2, width: imgDims.width, height: imgDims.height }); }
                        else { const fontKey = this.getFont(t.font, t.isBold, t.isItalic); page.drawText(t.text, { x, y, size: t.size, font: embeddedFonts[fontKey], color: PDFLib.rgb(this.hexToRgb(t.color).r, this.hexToRgb(t.color).g, this.hexToRgb(t.color).b), opacity: t.opacity || 1, rotate: PDFLib.degrees(t.rotation || 0), xCentered: true, yCentered: true }); } 
                    }); }
                    if (addPageNum) { const { width } = page.getSize(); page.drawText(`${i+1} / ${targetPages.length}`, { x: width/2, y: 20, size: 10, font: embeddedFonts['Helvetica'], color: PDFLib.rgb(0,0,0), xCentered: true }); }
                }
                
                // SAVE WITH ENCRYPTION IF PASSWORD SET
                if(this.protection.password) {
                    await doc.encrypt({
                        userPassword: this.protection.password,
                        ownerPassword: this.protection.password,
                        permissions: {
                            printing: 'highResolution',
                            modifying: false,
                            copying: false,
                            annotating: false,
                            fillingForms: false,
                            contentAccessibility: false,
                            documentAssembly: false
                        }
                    });
                }
                
                const pdfBytes = await doc.save(); 
                
                const blob = new Blob([pdfBytes], { type: 'application/pdf' }); const url = URL.createObjectURL(blob);
                if (preview) window.open(url, '_blank'); else if (print) { const iframe = document.getElementById('printFrame'); iframe.src = url; iframe.onload = () => { iframe.contentWindow.print(); }; } else { const link = document.createElement('a'); link.href = url; const nameInput = document.getElementById('filenameInput'); link.download = (nameInput ? nameInput.value : 'document') + '.pdf'; document.body.appendChild(link); link.click(); document.body.removeChild(link); this.showToast('PDF Exported Successfully'); }
            } catch (e) { console.error(e); this.showToast('Error: ' + e.message, 'error'); }
            this.showLoader(false);
        }
    }
    document.addEventListener('DOMContentLoaded', () => new VisualPDFTool());
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker Registered'))
                .catch(err => console.log('Service Worker Error:', err));
        });
    }
    </script>
</body>
</html>
