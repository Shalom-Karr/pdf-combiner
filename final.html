<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate PDF Editor Pro | HIPAA Secure</title>

    <script src="js/pdf-lib.min.js"></script>
    <script src="js/pdf.min.js"></script>
    <script src="js/sortable.min.js"></script>
    <script src="js/cropper.min.js"></script>
    <link rel="stylesheet" href="css/cropper.min.css">
    <script src="js/tailwindcss.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: { primary: '#4f46e5', secondary: '#64748b' },
                    animation: { 
                        'pop-in': 'popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'shimmer': 'shimmer 1.5s infinite'
                    },
                    keyframes: { 
                        popIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        shimmer: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* CORE UX */
        body { font-family: 'Inter', sans-serif; user-select: none; overscroll-behavior: none; }
        
        /* GLASS EFFECTS & LAYERS */
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        /* PAGE THUMBNAILS */
        .page-item { transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1); outline: none; position: relative; }
        .page-item:hover { transform: translateY(-4px) scale(1.02); z-index: 20; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        .page-item.selected { ring: 2px solid #4f46e5; transform: translateY(-4px); }
        
        /* DRAG & DROP UI */
        .sortable-ghost { opacity: 0.3; background: #e0e7ff; border: 2px dashed #6366f1; }
        .sortable-drag { cursor: grabbing; opacity: 1 !important; background: white; transform: scale(1.05) rotate(2deg); z-index: 50; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        
        /* EDITOR OVERLAYS */
        .draggable-text { position: absolute; cursor: move; white-space: pre; padding: 2px; line-height: 1; transform-origin: center center; user-select: none; border: 1px dashed transparent; }
        .draggable-text:hover { border-color: rgba(99, 102, 241, 0.5); }
        .draggable-text.active { border: 2px solid #6366f1; background: rgba(99, 102, 241, 0.1); box-shadow: 0 0 0 2px white; z-index: 50; }
        .draggable-text.redaction { background: black !important; color: transparent !important; border: 1px solid #ef4444; opacity: 0.9; }
        .draggable-text.redaction.active { opacity: 1; border: 2px solid #ef4444; }

        /* FOOTER ISLAND */
        #contextual-footer { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; }
        #contextual-footer.hidden-island { transform: translate(-50%, 150%); opacity: 0; pointer-events: none; }
        
        /* SCROLLBARS */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }
        
        /* BLUR PRIVACY */
        body.privacy-blur > *:not(#idle-modal) { filter: blur(8px); pointer-events: none; }
        
        /* GRID */
        .view-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 2rem; }
        .view-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .view-list .page-item { flex-direction: row; height: 80px; align-items: center; padding: 0.5rem; width: 100%; max-width: 900px; margin: 0 auto; }
        .view-list .canvas-wrapper { width: 70px; height: 100%; margin-right: 1rem; flex-shrink: 0; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 h-full overflow-hidden transition-colors duration-200">

    <div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-3 z-[100] pointer-events-none"></div>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity backdrop-blur-sm"></div>
    <iframe id="printFrame" class="hidden"></iframe>

    <div id="idle-modal" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/90 hidden backdrop-blur-md">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-sm text-center border border-slate-200 dark:border-slate-700">
            <div class="w-16 h-16 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">üîí</div>
            <h2 class="text-xl font-bold mb-2">Session Secured</h2>
            <p class="text-sm text-slate-500 mb-6">Session locked due to inactivity to protect sensitive data.</p>
            <button id="resumeSessionBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white w-full py-2.5 rounded-lg font-bold shadow-lg transition">Resume</button>
        </div>
    </div>

    <div id="context-menu" class="hidden fixed z-50 bg-white dark:bg-slate-800 shadow-xl rounded-lg border border-slate-200 dark:border-slate-700 w-56 py-1 transform scale-100 origin-top-left animate-pop-in">
        <button id="ctx-edit" class="w-full text-left px-4 py-2.5 text-sm font-bold text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-slate-700 flex items-center gap-3">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg> Edit / Redact
        </button>
        <button id="ctx-split" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg> Split Page (L/R)
        </button>
        <div class="h-px bg-slate-200 dark:bg-slate-700 my-1"></div>
        <button id="ctx-rotate-cw" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Rotate Right
        </button>
        <button id="ctx-duplicate" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="8" y="8" width="12" height="12" rx="2"></rect><path d="M16 8V6a2 2 0 00-2-2H6a2 2 0 00-2 2v8a2 2 0 002 2h2"></path></svg> Duplicate
        </button>
        <div class="h-px bg-slate-200 dark:bg-slate-700 my-1"></div>
        <button id="ctx-delete" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-3">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> Delete
        </button>
    </div>

    <div id="start-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-900 via-slate-900 to-black p-4">
        <div class="w-full max-w-5xl bg-white/10 backdrop-blur-2xl border border-white/10 rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row">
            <div class="p-12 md:w-1/2 flex flex-col justify-center text-left text-white border-b md:border-b-0 md:border-r border-white/10">
                <div class="inline-flex w-fit items-center gap-2 bg-emerald-500/20 border border-emerald-500/40 text-emerald-300 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-6">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                    HIPAA Ready: 100% Local
                </div>
                <h1 class="text-5xl font-extrabold mb-6 tracking-tight leading-tight">Ultimate <br><span class="text-indigo-400">PDF Editor</span></h1>
                <p class="opacity-80 mb-8 text-lg font-light leading-relaxed">Merge, split, edit, and redact documents entirely in your browser. No data ever leaves your device.</p>
                
                <div id="restore-banner" class="hidden bg-emerald-900/30 border border-emerald-500/30 p-4 rounded-xl backdrop-blur-md flex justify-between items-center">
                    <span class="text-sm font-medium text-emerald-100">‚ö†Ô∏è Previous session found.</span>
                    <button id="restoreBtn" class="text-xs bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold transition shadow-lg">Restore</button>
                </div>
            </div>
            
            <div class="p-12 md:w-1/2 bg-black/20 flex flex-col justify-center items-center">
                <div id="startDropZone" class="w-full aspect-square border-2 border-dashed border-slate-500/30 rounded-3xl flex flex-col items-center justify-center hover:bg-white/5 hover:border-indigo-400 transition-all cursor-pointer group relative overflow-hidden">
                    <div class="absolute inset-0 bg-indigo-500/10 blur-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
                    <svg class="w-20 h-20 text-slate-500 group-hover:text-indigo-400 transition-colors mb-6 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="text-slate-300 font-medium relative z-10 text-lg">Drag medical files here</p>
                    <button id="startChooseFileBtn" class="mt-8 bg-white text-slate-900 hover:bg-indigo-50 font-bold py-3 px-8 rounded-full shadow-xl transition transform hover:scale-105 relative z-10">Browse Files</button>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container hidden flex h-screen">
        <aside id="sidebar" class="w-72 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col flex-shrink-0 z-40 fixed md:relative h-full transition-transform transform -translate-x-full md:translate-x-0 shadow-xl md:shadow-none">
            <div class="p-5 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800">
                <h2 class="font-bold text-sm uppercase tracking-wider text-slate-500 dark:text-slate-400">Source Files</h2>
                <div class="flex gap-2">
                    <button id="toggleSidebarSize" class="text-slate-400 hover:text-indigo-500" title="Collapse">¬´</button>
                    <button id="sidebar-close-btn" class="md:hidden text-slate-400 hover:text-slate-700">‚úï</button>
                </div>
            </div>
            
            <div id="sourceFileList" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scroll">
                <div id="empty-source-state" class="text-center py-10 opacity-50">
                    <div class="text-4xl mb-2">üìÇ</div>
                    <p class="text-xs">No files added</p>
                </div>
            </div>
            
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 space-y-3">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Actions</div>
                <button id="insertBlankBtn" class="w-full py-2.5 px-4 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 text-sm font-medium text-left flex items-center gap-3 transition shadow-sm group">
                    <span class="text-indigo-500 font-bold group-hover:scale-110 transition">+</span> Insert Blank Page
                </button>
                <button id="openTextModalBtn" class="w-full py-2.5 px-4 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 text-sm font-medium text-left flex items-center gap-3 transition shadow-sm group">
                    <span class="text-indigo-500 font-bold group-hover:scale-110 transition">T</span> Text / Watermark
                </button>
                <button id="openMetadataBtn" class="w-full py-3 px-4 bg-white dark:bg-slate-700 border border-slate-200 rounded-lg hover:bg-slate-50 text-sm font-medium text-left flex items-center gap-3 shadow-sm"><span>‚öô</span> Metadata</button>
                <div class="h-px bg-slate-200 dark:bg-slate-600 my-2"></div>
                <div class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-2">Sort</div>
                <button id="sortByNumberBtn" class="w-full py-2 px-3 bg-slate-100 hover:bg-slate-200 rounded text-xs text-left">1-9 Numeric</button>
                <button id="sortByAlphaBtn" class="w-full py-2 px-3 bg-slate-100 hover:bg-slate-200 rounded text-xs text-left">A-Z Filename</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-slate-100 dark:bg-slate-900/50 relative">
            <header class="glass-panel border-b border-slate-200 dark:border-slate-700 shadow-sm z-30 px-6 py-3 flex items-center justify-between sticky top-0">
                <div class="flex items-center gap-4">
                    <span class="font-bold text-slate-700 dark:text-slate-200 text-lg">Workspace</span>
                    <div class="flex bg-slate-200 dark:bg-slate-700 rounded-lg p-1">
                        <button id="viewGridBtn" class="px-3 py-1 rounded bg-white dark:bg-slate-600 shadow-sm text-xs font-bold text-slate-700 dark:text-slate-200">Grid</button>
                        <button id="viewListBtn" class="px-3 py-1 rounded hover:bg-slate-300 dark:hover:bg-slate-500 text-xs font-bold text-slate-500 dark:text-slate-400">List</button>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button id="clearBtn" class="text-xs font-bold px-3 py-1.5 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition">Clear All</button>
                    <div class="h-6 w-px bg-slate-300 dark:bg-slate-600 mx-1"></div>
                    <div class="flex items-center gap-1 text-sm bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded px-2 py-1.5 focus-within:ring-2 focus-within:ring-indigo-500 ring-offset-1">
                        <input type="text" id="filenameInput" value="patient_record" class="bg-transparent border-none outline-none w-32 text-right text-slate-700 dark:text-slate-200 placeholder-slate-400">
                        <span class="text-slate-400 font-medium">.pdf</span>
                    </div>
                    <button id="addFilesBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-5 rounded-lg shadow-md transition transform active:scale-95 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Files
                    </button>
                    <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.jpg,.jpeg,.png">
                </div>
            </header>

            <div id="page-grid-container" class="flex-1 overflow-y-auto p-8 relative custom-scroll">
                <div id="page-grid" class="view-grid pb-32"></div>
                <div id="empty-grid-state" class="hidden absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-50">
                    <p class="text-xl font-light text-slate-400">Workspace is empty</p>
                </div>
            </div>

            <footer id="contextual-footer" class="fixed bottom-8 left-1/2 -translate-x-1/2 hidden-island z-40 glass-panel text-slate-800 dark:text-white rounded-full shadow-2xl px-6 py-3 flex items-center gap-6">
                <div class="flex items-center gap-3 text-sm font-medium border-r border-slate-300 pr-6">
                    <span id="selection-count">0 selected</span>
                    <button id="selectAllBtn" class="text-indigo-600 hover:underline">All</button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="rotateSelectedBtn" class="p-2 hover:bg-slate-100 rounded-full" title="Rotate">‚ü≥</button>
                    <button id="deleteSelectedBtn" class="p-2 hover:bg-red-50 text-red-500 rounded-full" title="Delete">üóë</button>
                </div>
                <div class="h-6 w-px bg-slate-300"></div>
                <div class="relative group">
                    <button id="exportMenuBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white pl-5 pr-3 py-1.5 rounded-full text-sm font-bold shadow-lg flex items-center gap-2">Export PDF ‚ñº</button>
                    <div id="exportMenuDropdown" class="hidden absolute bottom-full right-0 mb-3 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden text-left z-50">
                        <button id="saveBtn" class="w-full text-left px-4 py-3 text-sm hover:bg-indigo-50 flex items-center gap-3">üíæ Save All Pages</button>
                        <button id="saveSelectedBtn" class="w-full text-left px-4 py-3 text-sm hover:bg-indigo-50 flex items-center gap-3">üìù Save Selected Only</button>
                        <div class="h-px bg-slate-200 dark:bg-slate-700"></div>
                        <div class="px-4 py-3 bg-slate-50 dark:bg-slate-800/50 space-y-2">
                             <label class="flex items-center gap-2 text-xs text-slate-500 cursor-pointer"><input type="checkbox" id="auditTrailCheckbox" class="rounded text-indigo-600"> Append Audit Trail</label>
                        </div>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <div id="metadata-modal" class="fixed inset-0 z-[60] bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl p-6">
            <h3 class="text-xl font-bold mb-4 dark:text-white">PDF Properties</h3>
            <div class="space-y-3">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Title</label><input type="text" id="meta-title" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Author</label><input type="text" id="meta-author" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Subject (PHI)</label><input type="text" id="meta-subject" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:text-white"></div>
            </div>
            <div class="mt-6 flex justify-end gap-2"><button class="close-meta-modal px-4 py-2 text-sm">Cancel</button><button id="saveMetadataBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Save</button></div>
        </div>
    </div>

    <div id="text-modal" class="fixed inset-0 z-[60] bg-black/90 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-7xl h-[95vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
            <div class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-4"><h3 class="font-bold text-lg text-slate-800 dark:text-white">Secure Page Editor</h3><p id="editor-page-info" class="text-slate-500 text-sm"></p></div>
                <div class="flex gap-2"><button id="savePageEdits" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-md">Apply Changes</button><button class="close-text-modal text-slate-500 hover:text-slate-800 px-3 font-medium">Cancel</button></div>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <div class="w-72 bg-slate-50 dark:bg-slate-900 border-r border-slate-200 flex flex-col overflow-y-auto p-4 z-10 custom-scroll">
                    <div class="mb-4 bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/30 p-3 rounded-xl">
                        <label class="text-[10px] font-bold text-red-500 uppercase tracking-wider mb-2 block">HIPAA Redaction</label>
                        <p class="text-[10px] text-slate-500 mb-2">Blacking out text here will flatten the final PDF page to an image, permanently removing data.</p>
                        <button id="addRedactBtn" class="w-full bg-red-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-red-700 transition">Add Black Box</button>
                    </div>
                     <div class="mb-6 pb-6 border-b border-slate-200">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Crop Image</label>
                        <div class="flex gap-2">
                            <button id="toggleCropBtn" class="flex-1 py-2 bg-indigo-50 text-indigo-700 border border-indigo-200 rounded text-xs font-bold">Start Crop</button>
                            <button id="applyCropBtn" class="hidden flex-1 py-2 bg-emerald-600 text-white rounded text-xs font-bold">Apply</button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="p-3 bg-white dark:bg-slate-800 rounded-xl border border-slate-200">
                            <label class="block text-xs font-bold text-slate-500 mb-2">SIGNATURE</label>
                            <div class="border border-slate-200 rounded h-24 mb-2 bg-white relative cursor-crosshair overflow-hidden touch-none" id="sig-pad-container"><canvas id="signature-pad" class="w-full h-full block"></canvas><div class="absolute bottom-1 right-1 text-[10px] text-slate-400 pointer-events-none">Draw here</div></div>
                            <div class="flex gap-2 mb-2"><button id="addSigBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-1.5 rounded text-xs font-bold transition">Add Drawn</button><button id="clearSigBtn" class="px-3 bg-slate-100 hover:bg-slate-200 text-slate-600 py-1.5 rounded text-xs transition">Clear</button></div>
                            <button id="uploadSigBtn" class="w-full py-1.5 text-xs border border-dashed border-slate-400 text-slate-500 rounded hover:bg-slate-50 dark:hover:bg-slate-800">Upload Signature Image</button>
                            <input type="file" id="sigUpload" class="hidden" accept="image/*">
                        </div>
                        <div class="p-3 bg-white dark:bg-slate-800 rounded-xl border border-slate-200">
                            <label class="block text-xs font-bold text-slate-500 mb-2">TEXT / ANNOTATION</label>
                            <textarea id="txt-content" placeholder="Type text..." class="w-full h-16 text-sm p-2 rounded border bg-transparent mb-2"></textarea>
                            <div class="flex gap-2 mb-2">
                                <input type="number" id="txt-size" class="w-16 text-sm p-1 rounded border" value="20">
                                <input type="color" id="txt-color" class="flex-1 h-8 cursor-pointer rounded" value="#000000">
                            </div>
                            <button id="addTextLayerBtn" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 py-2 rounded-lg text-xs font-bold">Add Text</button>
                        </div>
                        <button id="delete-layer-btn" class="w-full py-2 text-red-500 text-xs font-bold border border-red-200 rounded hover:bg-red-50">Remove Selected Item</button>
                    </div>
                </div>
                <div id="preview-container-parent" class="flex-1 bg-slate-200/50 dark:bg-slate-950 flex items-center justify-center p-8 overflow-hidden relative">
                    <div id="preview-wrapper" class="relative shadow-2xl bg-white">
                        <canvas id="modal-bg-canvas" class="block"></canvas>
                        <img id="crop-image-target" class="hidden max-w-full max-h-full">
                        <div id="overlay-container" class="absolute inset-0"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loader" class="fixed inset-0 z-[100] bg-white/90 dark:bg-slate-900/90 flex flex-col items-center justify-center hidden"><div class="w-12 h-12 border-4 border-slate-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div><p id="loader-text" class="text-slate-600 font-medium">Processing...</p></div>

    <script>
    // --- LOCAL WORKER CONFIG ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/pdf.worker.min.js';

    class AuditLogger {
        constructor() { this.logs = []; this.add('Session Started'); }
        add(action) { const timestamp = new Date().toISOString(); this.logs.push(`[${timestamp}] ${action}`); }
        getLogText() { return "AUDIT TRAIL\n" + "-".repeat(50) + "\n" + this.logs.join('\n'); }
    }

    class IdleMonitor {
        constructor(callback, timeoutMinutes = 15) {
            this.callback = callback; this.timeout = timeoutMinutes * 60 * 1000; this.timer = null; this.init();
        }
        init() { ['mousemove', 'keydown', 'mousedown', 'touchstart'].forEach(evt => document.addEventListener(evt, () => this.resetTimer())); this.resetTimer(); }
        resetTimer() { clearTimeout(this.timer); this.timer = setTimeout(this.callback, this.timeout); }
    }

    class LocalStorageManager {
        constructor(dbName='PDFEditorDB', storeName='StateStore') { this.dbName=dbName; this.storeName=storeName; this.db=null; }
        
        async init() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(this.dbName, 1);
                req.onerror = e => reject(e);
                req.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains(this.storeName)) e.target.result.createObjectStore(this.storeName); };
                req.onsuccess = e => { this.db = e.target.result; resolve(); };
            });
        }

        async saveState(sourceFiles, pages, metadata) {
            if(!this.db) await this.init();
            const serialized = sourceFiles.map(f => ({ id: f.id, name: f.name, type: f.type, file: f.file }));
            const state = { sourceFiles: serialized, pages: pages, metadata: metadata, timestamp: Date.now() };
            const tx = this.db.transaction([this.storeName], 'readwrite');
            tx.objectStore(this.storeName).put(state, 'currentState');
        }

        async loadState() {
            if(!this.db) await this.init();
            return new Promise((r) => {
                const tx = this.db.transaction([this.storeName], 'readonly');
                const req = tx.objectStore(this.storeName).get('currentState');
                req.onsuccess = () => r(req.result);
                req.onerror = () => r(null);
            });
        }

        async clear() {
            if(!this.db) await this.init();
            const tx = this.db.transaction([this.storeName], 'readwrite');
            tx.objectStore(this.storeName).clear();
        }
    }

    class VisualPDFTool {
        constructor() {
            this.sourceFiles = []; this.pages = []; this.selectedPageIds = new Set();
            this.metadata = { title: '', author: '', subject: '' };
            this.auditLogger = new AuditLogger();
            this.dbManager = new LocalStorageManager();
            this.objectUrlCache = new Map();
            this.editorState = { pageId: null, tempOverlays: [], rotation: 0, cropper: null, selectedIndex: -1 };
            this.pageGrid = document.getElementById('page-grid');
            this.init();
        }

        async init() {
            this.initListeners();
            this.initSortable();
            this.initSignaturePad();
            if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
            this.idleMonitor = new IdleMonitor(() => { document.body.classList.add('privacy-blur'); document.getElementById('idle-modal').classList.remove('hidden'); });
            document.getElementById('resumeSessionBtn').addEventListener('click', () => { document.body.classList.remove('privacy-blur'); document.getElementById('idle-modal').classList.add('hidden'); this.idleMonitor.resetTimer(); });
            
            try { 
                await this.dbManager.init(); 
                const saved = await this.dbManager.loadState(); 
                if(saved && saved.pages.length > 0) { 
                    document.getElementById('restore-banner').classList.remove('hidden'); 
                    document.getElementById('restoreBtn').addEventListener('click', () => this.restoreSession(saved)); 
                } 
            } catch(e) {}
        }

        async addFiles(files) {
            if (files.length === 0) return;
            this.showLoader(true);
            if (this.pages.length === 0) {
                document.getElementById('start-screen').classList.add('hidden');
                document.querySelector('.app-container').classList.remove('hidden');
            }
            for (const file of files) {
                this.auditLogger.add(`Imported file: ${file.name}`);
                const fileId = `f_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                const source = { id: fileId, name: file.name, type: file.type, file: file };
                if (file.type === 'application/pdf') {
                    const ab = await file.arrayBuffer();
                    source.pdfDoc = await pdfjsLib.getDocument({ data: ab }).promise;
                    source.pdfLibDoc = await PDFLib.PDFDocument.load(ab);
                    this.sourceFiles.push(source);
                    for (let i = 0; i < source.pdfDoc.numPages; i++) this.pages.push({ id: `p_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`, sourceFile: source, sourcePageIndex: i, type: 'pdf', rotation: 0, textOverlays: [], hasRedactions: false });
                } else {
                    this.sourceFiles.push(source);
                    this.pages.push({ id: `p_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`, sourceFile: source, sourcePageIndex: 0, type: 'image', rotation: 0, textOverlays: [], hasRedactions: false });
                }
            }
            this.renderAllPages();
            this.saveState();
            this.showLoader(false);
        }

        renderAllPages() {
            this.pageGrid.innerHTML = '';
            this.pages.forEach((p, i) => {
                const item = document.createElement('div');
                item.className = 'page-item group relative cursor-pointer overflow-hidden flex flex-col h-full rounded-xl bg-white dark:bg-slate-800 border border-slate-200 shadow-sm';
                item.dataset.id = p.id;
                if(this.selectedPageIds.has(p.id)) item.classList.add('selected');
                let indicators = '';
                if(p.hasRedactions) indicators += '<span class="text-[10px] bg-red-500 text-white px-1 rounded mr-1">REDACTED</span>';
                if(p.textOverlays.length > 0) indicators += '<span class="text-[10px] bg-indigo-500 text-white px-1 rounded">EDITED</span>';
                item.innerHTML = `<div class="canvas-wrapper flex-1 bg-slate-50 relative flex items-center justify-center p-2 min-h-[140px]"><canvas class="max-w-full max-h-full object-contain"></canvas><div class="absolute top-2 right-2 flex">${indicators}</div></div><div class="px-3 py-2 bg-white text-xs border-t flex justify-between"><span class="truncate max-w-[100px]">${p.sourceFile.name}</span><span class="text-slate-400">${i + 1}</span></div>`;
                requestAnimationFrame(() => this.drawThumbnail(item.querySelector('canvas'), p));
                item.addEventListener('click', (e) => this.handlePageClick(e, p.id));
                item.addEventListener('dblclick', () => this.openEditor(p.id));
                this.pageGrid.appendChild(item);
            });
            document.getElementById('empty-grid-state').classList.toggle('hidden', this.pages.length > 0);
            this.updateFooter();
        }

        async drawThumbnail(canvas, page) {
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            if (page.type === 'pdf') {
                try {
                    const pdfPage = await page.sourceFile.pdfDoc.getPage(page.sourcePageIndex + 1);
                    const viewport = pdfPage.getViewport({ scale: 0.3 * dpr, rotation: page.rotation });
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    await pdfPage.render({ canvasContext: ctx, viewport }).promise;
                } catch(e) {}
            } else {
                const img = new Image();
                let url = this.objectUrlCache.get(page.sourceFile.id);
                if(!url) { url = URL.createObjectURL(page.sourceFile.file); this.objectUrlCache.set(page.sourceFile.id, url); }
                img.src = url;
                await new Promise(r => img.onload = r);
                const size = 180 * dpr;
                const ratio = img.height / img.width;
                canvas.width = size; canvas.height = size * ratio;
                ctx.translate(canvas.width/2, canvas.height/2);
                ctx.rotate(page.rotation * Math.PI / 180);
                ctx.drawImage(img, -canvas.width/2, -canvas.height/2, canvas.width, canvas.height);
            }
        }

        async openEditor(pageId) {
            const page = this.pages.find(p => p.id === pageId);
            if(!page) return;
            this.editorState = { pageId: pageId, tempOverlays: JSON.parse(JSON.stringify(page.textOverlays || [])), rotation: page.rotation, cropper: null, selectedIndex: -1 };
            document.getElementById('text-modal').classList.remove('hidden');
            document.getElementById('editor-page-info').innerText = `Page ${this.pages.indexOf(page)+1} - ${page.sourceFile.name}`;
            document.getElementById('txt-content').value = "";
            await this.renderEditorCanvas();
            this.renderOverlays();
        }

        async renderEditorCanvas() {
            const page = this.pages.find(p => p.id === this.editorState.pageId);
            const canvas = document.getElementById('modal-bg-canvas');
            const ctx = canvas.getContext('2d');
            const container = document.getElementById('preview-wrapper');
            if (page.type === 'pdf') {
                const pdfPage = await page.sourceFile.pdfDoc.getPage(page.sourcePageIndex + 1);
                const viewport = pdfPage.getViewport({ scale: 1.5, rotation: this.editorState.rotation });
                canvas.width = viewport.width; canvas.height = viewport.height;
                container.style.width = viewport.width + 'px'; container.style.height = viewport.height + 'px';
                await pdfPage.render({ canvasContext: ctx, viewport }).promise;
            } else {
                const img = new Image();
                let url = this.objectUrlCache.get(page.sourceFile.id);
                img.src = url;
                await new Promise(r => img.onload = r);
                const cropImg = document.getElementById('crop-image-target');
                cropImg.src = url;
                const ratio = img.height / img.width;
                const baseW = 800; 
                canvas.width = baseW; canvas.height = baseW * ratio;
                container.style.width = canvas.width + 'px'; container.style.height = canvas.height + 'px';
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            }
        }

        addText() {
            const text = document.getElementById('txt-content').value || "New Text";
            const color = document.getElementById('txt-color').value;
            const size = document.getElementById('txt-size').value;
            this.editorState.tempOverlays.push({ text: text, x: 50, y: 50, type: 'text', color: color, size: size });
            this.editorState.selectedIndex = this.editorState.tempOverlays.length - 1;
            this.renderOverlays();
        }

        addRedaction() {
            this.editorState.tempOverlays.push({ text: "", x: 50, y: 50, type: 'redaction', width: 200, height: 50 });
            this.editorState.selectedIndex = this.editorState.tempOverlays.length - 1;
            this.renderOverlays();
        }

        updateSelectedStyle() {
            const idx = this.editorState.selectedIndex;
            if (idx === -1) return;
            const overlay = this.editorState.tempOverlays[idx];
            if (overlay.type === 'redaction') return;
            overlay.text = document.getElementById('txt-content').value;
            overlay.color = document.getElementById('txt-color').value;
            overlay.size = document.getElementById('txt-size').value;
            this.renderOverlays();
        }

        renderOverlays() {
            const container = document.getElementById('overlay-container');
            container.innerHTML = '';
            this.editorState.tempOverlays.forEach((ov, index) => {
                const el = document.createElement('div');
                el.className = `draggable-text ${ov.type === 'redaction' ? 'redaction' : ''}`;
                if (index === this.editorState.selectedIndex) el.classList.add('active');
                if(ov.type === 'redaction') {
                    el.style.width = '120px'; el.style.height = '40px'; 
                    el.style.backgroundColor = 'black'; el.style.opacity = '0.7';
                } else if (ov.type === 'signature') {
                    const img = document.createElement('img');
                    img.src = ov.imageData;
                    img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'contain';
                    el.appendChild(img);
                    el.style.width = ov.width + 'px'; el.style.height = ov.height + 'px';
                } else {
                    el.innerText = ov.text; el.style.color = ov.color;
                    el.style.fontSize = ov.size + 'px'; el.style.fontWeight = 'bold';
                    el.style.textShadow = '0px 0px 2px white';
                }
                el.style.left = ov.x + '%'; el.style.top = ov.y + '%';
                el.onmousedown = (e) => {
                    e.stopPropagation();
                    this.selectOverlay(index);
                    const rect = container.getBoundingClientRect();
                    let isDragging = true;
                    const onMove = (em) => {
                        if (!isDragging) return;
                        let newX = ((em.clientX - rect.left) / rect.width) * 100;
                        let newY = ((em.clientY - rect.top) / rect.height) * 100;
                        ov.x = Math.max(0, Math.min(100, newX));
                        ov.y = Math.max(0, Math.min(100, newY));
                        el.style.left = newX + '%'; el.style.top = newY + '%';
                    };
                    const onUp = () => { isDragging = false; document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); this.renderOverlays(); };
                    document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
                };
                container.appendChild(el);
            });
        }

        selectOverlay(index) {
            this.editorState.selectedIndex = index;
            const ov = this.editorState.tempOverlays[index];
            if (ov.type !== 'redaction') {
                document.getElementById('txt-content').value = ov.text;
                document.getElementById('txt-color').value = ov.color;
                document.getElementById('txt-size').value = ov.size;
            } else { document.getElementById('txt-content').value = "[REDACTED BLOCK]"; }
            this.renderOverlays();
        }

        savePageEdits() {
            const page = this.pages.find(p => p.id === this.editorState.pageId);
            page.textOverlays = this.editorState.tempOverlays;
            page.hasRedactions = page.textOverlays.some(o => o.type === 'redaction');
            this.saveState(); this.renderAllPages(); document.getElementById('text-modal').classList.add('hidden');
        }

        toggleCropper() {
            const page = this.pages.find(p => p.id === this.editorState.pageId);
            if(page.type === 'pdf') { alert('Convert PDF to Image to crop.'); return; }
            const canvas = document.getElementById('modal-bg-canvas');
            const imgTarget = document.getElementById('crop-image-target');
            const overlay = document.getElementById('overlay-container');
            const applyBtn = document.getElementById('applyCropBtn');
            const toggleBtn = document.getElementById('toggleCropBtn');
            if (this.editorState.cropper) {
                this.editorState.cropper.destroy(); this.editorState.cropper = null;
                canvas.classList.remove('hidden'); imgTarget.classList.add('hidden'); overlay.classList.remove('hidden');
                applyBtn.classList.add('hidden'); toggleBtn.innerText = "Start Crop";
            } else {
                canvas.classList.add('hidden'); imgTarget.classList.remove('hidden'); overlay.classList.add('hidden');
                applyBtn.classList.remove('hidden'); toggleBtn.innerText = "Cancel";
                this.editorState.cropper = new Cropper(imgTarget, { viewMode: 1, autoCropArea: 0.8 });
            }
        }

        async applyCrop() {
            if(!this.editorState.cropper) return;
            const blob = await new Promise(r => this.editorState.cropper.getCroppedCanvas().toBlob(r));
            const newFileId = `crop_${Date.now()}`;
            const newSource = { id: newFileId, name: "Cropped Image", type: blob.type, file: blob };
            this.sourceFiles.push(newSource);
            const page = this.pages.find(p => p.id === this.editorState.pageId);
            page.sourceFile = newSource; page.sourcePageIndex = 0; page.rotation = 0;
            this.toggleCropper(); this.renderEditorCanvas();
        }

        async createPdf(preview = false, print = false) {
            this.showLoader(true, 'Securing PDF...');
            const doc = await PDFLib.PDFDocument.create();
            doc.setTitle(document.getElementById('meta-title').value);
            const selectedOnly = document.getElementById('exportMenuBtn').innerText.includes('Selected');
            const pagesToExport = (selectedOnly && this.selectedPageIds.size > 0) ? this.pages.filter(p => this.selectedPageIds.has(p.id)) : this.pages;
            for (const p of pagesToExport) {
                let page;
                if (p.hasRedactions) {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const dpr = 2;
                    let dims = { width: 595, height: 842 };
                    if(p.type === 'pdf') {
                        const pp = await p.sourceFile.pdfDoc.getPage(p.sourcePageIndex + 1); const vp = pp.getViewport({ scale: dpr, rotation: p.rotation });
                        canvas.width = vp.width; canvas.height = vp.height; await pp.render({ canvasContext: ctx, viewport: vp }).promise;
                        dims = { width: vp.width/dpr, height: vp.height/dpr };
                    } else {
                         const img = new Image(); img.src = this.objectUrlCache.get(p.sourceFile.id); await new Promise(r => img.onload = r);
                         canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0); dims = { width: img.width, height: img.height };
                    }
                    p.textOverlays.forEach(ov => {
                        const x = (ov.x / 100) * canvas.width; const y = (ov.y / 100) * canvas.height;
                        if(ov.type === 'redaction') { ctx.fillStyle = 'black'; ctx.fillRect(x, y, 120 * (canvas.width/800), 40 * (canvas.height/600)); } 
                        else { ctx.fillStyle = ov.color; ctx.font = `bold ${ov.size * dpr}px Arial`; ctx.fillText(ov.text, x, y + (ov.size*dpr)); }
                    });
                    const imgData = canvas.toDataURL('image/jpeg', 0.8); const pdfImg = await doc.embedJpg(imgData);
                    page = doc.addPage([dims.width, dims.height]); page.drawImage(pdfImg, { x: 0, y: 0, width: dims.width, height: dims.height });
                } else {
                    if (p.type === 'pdf') { const [cp] = await doc.copyPages(p.sourceFile.pdfLibDoc, [p.sourcePageIndex]); cp.setRotation(PDFLib.degrees(p.rotation)); page = doc.addPage(cp); } 
                    else { const buffer = await p.sourceFile.file.arrayBuffer(); const img = p.sourceFile.type.includes('png') ? await doc.embedPng(buffer) : await doc.embedJpg(buffer); page = doc.addPage([img.width, img.height]); page.drawImage(img, {x:0,y:0,width:img.width,height:img.height}); }
                    const { height, width } = page.getSize();
                    p.textOverlays.forEach(ov => {
                        if(ov.type !== 'redaction') page.drawText(ov.text, { x: width * (ov.x/100), y: height - (height * (ov.y/100)) - parseInt(ov.size), size: parseInt(ov.size), color: PDFLib.rgb(parseInt(ov.color.slice(1,3),16)/255, parseInt(ov.color.slice(3,5),16)/255, parseInt(ov.color.slice(5,7),16)/255) });
                    });
                }
            }
            if (document.getElementById('auditTrailCheckbox').checked) { const auditPage = doc.addPage(); auditPage.drawText(this.auditLogger.getLogText(), { x: 50, y: 800, size: 10 }); }
            const pdfBytes = await doc.save(); const blob = new Blob([pdfBytes], { type: 'application/pdf' }); const url = URL.createObjectURL(blob);
            if (preview) window.open(url);
            else if (print) { const f = document.getElementById('printFrame'); f.src = url; f.onload = () => f.contentWindow.print(); }
            else { const a = document.createElement('a'); a.href = url; a.download = document.getElementById('filenameInput').value + '.pdf'; a.click(); }
            this.showLoader(false);
        }

        saveState() { this.dbManager.saveState(this.sourceFiles, this.pages, this.metadata); }
        handlePageClick(e, id) { if (e.ctrlKey) { if(this.selectedPageIds.has(id)) this.selectedPageIds.delete(id); else this.selectedPageIds.add(id); } else { this.selectedPageIds.clear(); this.selectedPageIds.add(id); } this.renderAllPages(); }
        updateFooter() { const count = this.selectedPageIds.size; document.getElementById('selection-count').innerText = `${count} selected`; const footer = document.getElementById('contextual-footer'); if(count > 0) footer.classList.remove('hidden-island'); else footer.classList.add('hidden-island'); }
        showLoader(show, text) { const l = document.getElementById('loader'); if(show) { l.classList.remove('hidden'); if(text) document.getElementById('loader-text').innerText=text; } else l.classList.add('hidden'); }
        
        initListeners() {
            document.getElementById('fileInput').addEventListener('change', e => this.addFiles(Array.from(e.target.files)));
            document.getElementById('addFilesBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('startChooseFileBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('toggleCropBtn').addEventListener('click', () => this.toggleCropper());
            document.getElementById('applyCropBtn').addEventListener('click', () => this.applyCrop());
            document.getElementById('addRedactBtn').addEventListener('click', () => this.addRedaction());
            document.getElementById('addTextLayerBtn').addEventListener('click', () => this.addText());
            ['txt-content', 'txt-size', 'txt-color'].forEach(id => { document.getElementById(id).addEventListener('input', () => this.updateSelectedStyle()); });
            document.getElementById('delete-layer-btn').addEventListener('click', () => { if(this.editorState.selectedIndex > -1) { this.editorState.tempOverlays.splice(this.editorState.selectedIndex, 1); this.editorState.selectedIndex = -1; this.renderOverlays(); }});
            document.getElementById('savePageEdits').addEventListener('click', () => this.savePageEdits());
            document.querySelector('.close-text-modal').addEventListener('click', () => document.getElementById('text-modal').classList.add('hidden'));
            document.getElementById('openTextModalBtn').addEventListener('click', () => { if(this.selectedPageIds.size) this.openEditor(Array.from(this.selectedPageIds)[0]); else alert('Select a page first'); });
            document.getElementById('exportMenuBtn').addEventListener('click', () => document.getElementById('exportMenuDropdown').classList.toggle('hidden'));
            document.getElementById('saveBtn').addEventListener('click', () => this.createPdf());
            document.getElementById('saveSelectedBtn').addEventListener('click', () => { 
                document.getElementById('exportMenuBtn').innerText = 'Export Selected'; 
                this.createPdf(); 
                document.getElementById('exportMenuBtn').innerHTML = 'Export PDF ‚ñº';
            });
            document.getElementById('clearBtn').addEventListener('click', () => { if(confirm('Wipe everything?')) { this.pages = []; this.sourceFiles = []; this.selectedPageIds.clear(); this.objectUrlCache.forEach(url => URL.revokeObjectURL(url)); this.objectUrlCache.clear(); this.dbManager.clear(); this.renderAllPages(); } });
            const z = document.getElementById('startDropZone'); z.addEventListener('dragover', e => { e.preventDefault(); }); z.addEventListener('drop', e => { e.preventDefault(); this.addFiles(Array.from(e.dataTransfer.files)); });
            document.getElementById('viewGridBtn').addEventListener('click', () => { this.pageGrid.className = 'view-grid pb-32'; });
            document.getElementById('viewListBtn').addEventListener('click', () => { this.pageGrid.className = 'view-list pb-20'; });
            document.getElementById('selectAllBtn').addEventListener('click', () => { this.pages.forEach(p => this.selectedPageIds.add(p.id)); this.renderAllPages(); });
            document.getElementById('deleteSelectedBtn').addEventListener('click', () => { if(confirm('Delete selected?')) { this.pages = this.pages.filter(p => !this.selectedPageIds.has(p.id)); this.selectedPageIds.clear(); this.saveState(); this.renderAllPages(); }});
            document.getElementById('rotateSelectedBtn').addEventListener('click', () => { this.pages.forEach(p => { if(this.selectedPageIds.has(p.id)) p.rotation = (p.rotation + 90) % 360; }); this.saveState(); this.renderAllPages(); });
            document.getElementById('sortByNumberBtn').addEventListener('click', () => { this.pages.sort((a,b) => a.sourceFile.name.localeCompare(b.sourceFile.name, undefined, {numeric: true})); this.saveState(); this.renderAllPages(); });
            document.getElementById('sortByAlphaBtn').addEventListener('click', () => { this.pages.sort((a,b) => a.sourceFile.name.localeCompare(b.sourceFile.name)); this.saveState(); this.renderAllPages(); });
            const closeMeta = document.querySelector('.close-meta-modal'); if(closeMeta) closeMeta.addEventListener('click', () => { document.getElementById('metadata-modal').classList.add('hidden'); });
            document.getElementById('openMetadataBtn').addEventListener('click', () => { document.getElementById('meta-title').value = this.metadata.title; document.getElementById('meta-author').value = this.metadata.author; document.getElementById('meta-subject').value = this.metadata.subject; document.getElementById('metadata-modal').classList.remove('hidden'); });
            document.getElementById('saveMetadataBtn').addEventListener('click', () => { this.metadata.title = document.getElementById('meta-title').value; this.metadata.author = document.getElementById('meta-author').value; this.metadata.subject = document.getElementById('meta-subject').value; this.saveState(); document.getElementById('metadata-modal').classList.add('hidden'); });
            document.getElementById('insertBlankBtn').addEventListener('click', () => {
                const blankId = `blank_${Date.now()}`;
                const canvas = document.createElement('canvas'); canvas.width=595; canvas.height=842;
                const ctx = canvas.getContext('2d'); ctx.fillStyle='white'; ctx.fillRect(0,0,595,842);
                canvas.toBlob(blob => {
                    const source = { id: blankId, name: "Blank Page", type: "image/png", file: blob };
                    this.sourceFiles.push(source);
                    this.pages.push({ id: `p_${Date.now()}`, sourceFile: source, sourcePageIndex: 0, type: 'image', rotation: 0, textOverlays: [], hasRedactions: false });
                    this.renderAllPages(); this.saveState();
                });
            });
            // Context Menu
            document.addEventListener('click', () => document.getElementById('context-menu').classList.add('hidden'));
            this.pageGrid.addEventListener('contextmenu', e => {
                const item = e.target.closest('.page-item'); if(!item) return;
                e.preventDefault(); 
                this.contextTargetId = item.dataset.id;
                const menu = document.getElementById('context-menu');
                menu.style.left = `${e.clientX}px`; menu.style.top = `${e.clientY}px`;
                menu.classList.remove('hidden');
            });
            document.getElementById('ctx-edit').addEventListener('click', () => this.openEditor(this.contextTargetId));
            document.getElementById('ctx-delete').addEventListener('click', () => { this.pages = this.pages.filter(p => p.id !== this.contextTargetId); this.renderAllPages(); this.saveState(); });
            document.getElementById('ctx-duplicate').addEventListener('click', () => { 
                const p = this.pages.find(x => x.id === this.contextTargetId); 
                if(p) { this.pages.push({...p, id: `copy_${Date.now()}`}); this.renderAllPages(); this.saveState(); } 
            });
            document.getElementById('ctx-rotate-cw').addEventListener('click', () => { const p = this.pages.find(x => x.id === this.contextTargetId); if(p) { p.rotation = (p.rotation + 90) % 360; this.renderAllPages(); this.saveState(); } });
        }

        initSignaturePad() {
            const canvas = document.getElementById('signature-pad'); const ctx = canvas.getContext('2d'); let painting = false;
            const resize = () => { canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight; ctx.lineWidth = 3; ctx.lineCap = 'round'; }; resize();
            const start = (e) => { painting = true; draw(e); }; const end = () => { painting = false; ctx.beginPath(); };
            const draw = (e) => { if (!painting) return; const rect = canvas.getBoundingClientRect(); ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top); ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top); };
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mouseup', end); canvas.addEventListener('mousemove', draw);
            document.getElementById('clearSigBtn').addEventListener('click', () => ctx.clearRect(0,0,canvas.width,canvas.height));
            document.getElementById('addSigBtn').addEventListener('click', () => { this.editorState.tempOverlays.push({ text: '', x: 50, y: 50, type: 'signature', imageData: canvas.toDataURL(), width: 150, height: 75 }); this.renderOverlays(); });
            document.getElementById('uploadSigBtn').addEventListener('click', () => document.getElementById('sigUpload').click());
            document.getElementById('sigUpload').addEventListener('change', (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    this.editorState.tempOverlays.push({ text: '', x: 50, y: 50, type: 'signature', imageData: event.target.result, width: 150, height: 75 });
                    this.renderOverlays();
                };
                reader.readAsDataURL(file);
            });
        }

        initSortable() { Sortable.create(this.pageGrid, { animation: 150, onEnd: () => { const newPages = []; [...this.pageGrid.children].forEach(el => newPages.push(this.pages.find(p => p.id === el.dataset.id))); this.pages = newPages; this.saveState(); } }); }
    }
    document.addEventListener('DOMContentLoaded', () => new VisualPDFTool());
    </script>
</body>
</html>
