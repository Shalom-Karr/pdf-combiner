<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual PDF Editor Pro</title>

    <!-- LOCAL LIBRARIES -->
    <script src="js/pdf-lib.min.js"></script>
    <script src="js/pdf.min.js"></script>
    <script src="js/sortable.min.js"></script>
    <script src="js/tailwindcss.js"></script>
    <script src="js/cropper.min.js"></script>
    <link rel="stylesheet" href="css/cropper.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: { primary: '#4f46e5', secondary: '#64748b' },
                    animation: { 
                        'shimmer': 'shimmer 1.5s infinite', 
                        'pop-in': 'popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: { 
                        shimmer: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } },
                        popIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; user-select: none; overscroll-behavior: none; }
        
        /* CARD & UI */
        .page-item { transition: all 0.2s; outline: none; position: relative; }
        .page-item:hover { transform: translateY(-4px); z-index: 20; box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1); }
        .page-item.selected { ring: 2px solid #6366f1; transform: translateY(-4px); }
        
        /* DRAG GHOSTS */
        .sortable-ghost { opacity: 0.4; background: #e0e7ff; border: 2px dashed #6366f1; }
        .sortable-drag { cursor: grabbing; opacity: 1 !important; background: white; transform: scale(1.05) rotate(2deg); z-index: 50; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        
        /* EDITOR OVERLAYS */
        .draggable-text { position: absolute; cursor: move; white-space: pre; padding: 4px; line-height: 1; transform-origin: center center; user-select: none; border: 1px dashed transparent; }
        .draggable-text:hover { border-color: rgba(99, 102, 241, 0.5); }
        .draggable-text.active { border: 2px solid #6366f1; background: rgba(99, 102, 241, 0.1); box-shadow: 0 0 0 2px white; z-index: 50; }
        
        /* UTILS */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        .skeleton-shimmer { position: relative; overflow: hidden; background: #f1f5f9; }
        .skeleton-shimmer::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent); animation: shimmer 1.5s infinite; }
        .dark .skeleton-shimmer { background: #334155; }
        .dark .skeleton-shimmer::after { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent); }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }
        
        #contextual-footer { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        #contextual-footer.hidden-island { transform: translate(-50%, 150%); pointer-events: none; }
        
        /* GRID */
        :root { --grid-size: 180px; }
        .view-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 2rem; }
        .view-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .view-list .page-item { flex-direction: row; height: 80px; align-items: center; padding: 0.5rem; width: 100%; max-width: 800px; margin: 0 auto; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 h-full overflow-hidden transition-colors duration-200">

    <!-- TOAST & OVERLAYS -->
    <div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-3 z-[100] pointer-events-none"></div>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity backdrop-blur-sm"></div>
    <iframe id="printFrame" class="hidden"></iframe>
    <input type="file" id="stampInput" accept="image/png, image/jpeg" class="hidden">
    <input type="file" id="sigUpload" class="hidden" accept="image/*">

    <!-- CONTEXT MENU -->
    <div id="context-menu" class="hidden fixed z-50 bg-white dark:bg-slate-800 shadow-xl rounded-lg border border-slate-200 dark:border-slate-700 w-52 py-1 transform scale-100 origin-top-left animate-pop-in">
        <button id="ctx-edit" class="w-full text-left px-4 py-2.5 text-sm font-bold text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-slate-700 flex items-center gap-3"><span>‚úé</span> Edit Page</button>
        <button id="ctx-split" class="w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3"><span>‚úÇ</span> Split Half (L/R)</button>
        <div class="h-px bg-slate-200 dark:bg-slate-700 my-1"></div>
        <button id="ctx-rotate-cw" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-3"><span>‚Ü∑</span> Rotate Right</button>
        <button id="ctx-duplicate" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-3"><span>‚ùê</span> Duplicate</button>
        <div class="h-px bg-slate-200 dark:bg-slate-700 my-1"></div>
        <button id="ctx-delete" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-3"><span>üóë</span> Delete</button>
    </div>

    <!-- START SCREEN -->
    <div id="start-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-900 via-slate-900 to-black p-4">
        <div class="w-full max-w-4xl bg-white/5 backdrop-blur-2xl border border-white/10 rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row">
            <div class="p-12 md:w-1/2 flex flex-col justify-center text-left text-white border-b md:border-b-0 md:border-r border-white/10">
                <div class="inline-flex w-fit items-center gap-2 bg-emerald-500/20 border border-emerald-500/40 text-emerald-300 px-3 py-1 rounded-full text-xs font-medium mb-6">Secure ‚Ä¢ Local ‚Ä¢ Private</div>
                <h1 class="text-4xl font-bold mb-4 tracking-tight">Premium <br><span class="text-indigo-400">PDF Editor</span></h1>
                <p class="opacity-80 mb-6 text-sm font-light leading-relaxed">Merge, split, edit, sign, and organize documents. All processing happens entirely in your browser.</p>
                <div id="restore-banner" class="hidden bg-indigo-600/30 border border-indigo-500/50 p-4 rounded-xl backdrop-blur-md">
                    <p class="text-sm font-medium">‚ö†Ô∏è Previous session found.</p>
                    <button id="restoreBtn" class="mt-3 text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg transition">Restore Work</button>
                </div>
            </div>
            <div class="p-12 md:w-1/2 bg-black/20 flex flex-col justify-center items-center">
                <div id="startDropZone" class="w-full aspect-square border-2 border-dashed border-slate-500/30 rounded-3xl flex flex-col items-center justify-center hover:bg-white/5 transition-all cursor-pointer group relative">
                    <svg class="w-16 h-16 text-slate-500 group-hover:text-indigo-400 transition-colors mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="text-slate-300 font-medium">Drag PDF or Image files here</p>
                    <button id="startChooseFileBtn" class="mt-8 bg-white text-slate-900 hover:bg-indigo-50 font-bold py-3 px-8 rounded-full shadow-xl transition transform hover:scale-105">Browse Files</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div class="app-container hidden flex h-screen">
        <aside id="sidebar" class="w-72 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col flex-shrink-0 z-40 fixed md:relative h-full transition-transform transform -translate-x-full md:translate-x-0 shadow-xl md:shadow-none">
            <div class="p-5 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800">
                <h2 class="font-bold text-sm uppercase tracking-wider text-slate-500 dark:text-slate-400">Source Files</h2>
                <div class="flex gap-2">
                    <button id="toggleSidebarSize" class="text-slate-400 hover:text-indigo-500" title="Collapse">¬´</button>
                    <button id="sidebar-close-btn" class="md:hidden text-slate-400 hover:text-slate-700">‚úï</button>
                </div>
            </div>
            <div id="sourceFileList" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scroll">
                <div id="empty-source-state" class="text-center py-10 opacity-50"><div class="text-4xl mb-2">üìÇ</div><p class="text-xs">No files added</p></div>
            </div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 space-y-3">
                <button id="insertBlankBtn" class="w-full py-2.5 px-4 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 text-sm font-medium text-left flex items-center gap-3 transition shadow-sm group">
                    <span class="text-indigo-500 font-bold group-hover:scale-110 transition">+</span> Insert Blank Page
                </button>
                <button id="openTextModalBtn" class="w-full py-2.5 px-4 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 text-sm font-medium text-left flex items-center gap-3 transition shadow-sm group">
                    <span class="text-indigo-500 font-bold group-hover:scale-110 transition">T</span> Edit / Sign / Text
                </button>
                <button id="openMetadataBtn" class="w-full py-3 px-4 bg-white dark:bg-slate-700 border border-slate-200 rounded-lg hover:bg-slate-50 text-sm font-medium text-left flex items-center gap-3 shadow-sm"><span>‚öô</span> Metadata</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-slate-100 dark:bg-slate-900/50 relative">
            <header class="glass-panel z-30 px-4 py-3 flex flex-wrap gap-4 items-center justify-between sticky top-0">
                <div class="flex items-center gap-4">
                    <button id="menu-toggle-btn" class="md:hidden text-slate-500 p-2 hover:bg-slate-100 rounded">‚ò∞</button>
                    <!-- VIEW TOGGLES -->
                    <div class="flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                        <button id="viewGridBtn" class="p-1.5 rounded bg-white dark:bg-slate-600 shadow-sm text-indigo-600 text-xs font-bold">Grid</button>
                        <button id="viewListBtn" class="p-1.5 rounded hover:bg-slate-200 dark:hover:bg-slate-500 text-slate-500 text-xs font-bold">List</button>
                    </div>
                    <!-- HISTORY -->
                    <div class="flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                        <button id="undoBtn" disabled class="p-1.5 rounded hover:bg-white dark:hover:bg-slate-600 disabled:opacity-30 transition" title="Undo"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg></button>
                        <button id="redoBtn" disabled class="p-1.5 rounded hover:bg-white dark:hover:bg-slate-600 disabled:opacity-30 transition" title="Redo"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10H11a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/></svg></button>
                    </div>
                    <span id="auto-save-indicator" class="text-xs text-emerald-500 font-medium opacity-0 transition-opacity flex items-center gap-1">Saved <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                </div>

                <div class="flex items-center gap-3">
                    <button id="clearBtn" class="text-xs font-bold px-3 py-1.5 bg-red-50 hover:bg-red-100 dark:bg-red-900/20 text-red-600 rounded transition">Clear All</button>
                    <div class="h-6 w-px bg-slate-300 dark:bg-slate-600 mx-1"></div>
                    <div class="flex items-center gap-1 text-sm bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded px-2 py-1.5">
                        <input type="text" id="filenameInput" value="document" class="bg-transparent border-none outline-none w-32 text-right text-slate-700 dark:text-slate-200 placeholder-slate-400">
                        <span class="text-slate-400 font-medium">.pdf</span>
                    </div>
                    <button id="darkModeToggle" class="p-2 text-slate-400 hover:text-indigo-500 transition rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
                        <!-- Sun Icon (for Dark Mode) -->
                        <svg class="w-5 h-5 hidden dark:block text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <!-- Moon Icon (for Light Mode) -->
                        <svg class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                    <button id="addFilesBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-5 rounded-lg shadow-md transition transform active:scale-95 flex items-center gap-2">Add Files</button>
                    <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.jpg,.jpeg,.png">
                </div>
            </header>

            <div id="page-grid-container" class="flex-1 overflow-y-auto p-8 relative custom-scroll">
                <div id="page-grid" class="view-grid pb-32"></div>
                <div id="empty-grid-state" class="hidden absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-50">
                    <p class="text-xl font-light text-slate-400">Workspace is empty</p>
                </div>
            </div>

            <footer id="contextual-footer" class="fixed bottom-8 left-1/2 -translate-x-1/2 hidden-island z-40 bg-slate-900/95 dark:bg-white/95 text-white dark:text-slate-900 backdrop-blur-md rounded-full shadow-2xl px-6 py-3 flex items-center gap-6 border border-slate-700 dark:border-slate-200 transition-all duration-300">
                <div class="flex items-center gap-3 text-sm font-medium border-r border-slate-600 dark:border-slate-300 pr-6">
                    <span id="selection-count">0 selected</span>
                    <button id="selectAllBtn" class="text-indigo-400 dark:text-indigo-600 hover:underline">All</button>
                    <span class="opacity-50">/</span>
                    <button id="deselectAllBtn" class="hover:text-slate-300 dark:hover:text-slate-600 underline decoration-dotted">None</button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="duplicateSelectedBtn" class="p-2 hover:bg-white/10 dark:hover:bg-slate-200 rounded-full transition" title="Duplicate"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                    <button id="rotateSelectedBtn" class="p-2 hover:bg-white/10 dark:hover:bg-slate-200 rounded-full transition" title="Rotate"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
                    <button id="deleteSelectedBtn" class="p-2 hover:bg-red-500/20 text-red-400 hover:text-red-300 dark:text-red-600 dark:hover:text-red-700 rounded-full transition" title="Delete"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                </div>
                <div class="h-6 w-px bg-slate-600 dark:bg-slate-300"></div>
                <div class="relative group">
                    <button class="bg-indigo-500 hover:bg-indigo-600 text-white pl-5 pr-3 py-1.5 rounded-full text-sm font-bold shadow-lg shadow-indigo-500/30 transition flex items-center gap-2">
                        Export PDF <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="absolute bottom-full right-0 mb-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden hidden group-hover:block text-left">
                        <button id="saveBtn" class="w-full text-left px-4 py-2.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-indigo-50 dark:hover:bg-slate-700 flex items-center gap-2"><span>üíæ</span> Save File</button>
                        <button id="printBtn" class="w-full text-left px-4 py-2.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-indigo-50 dark:hover:bg-slate-700 flex items-center gap-2"><span>üñ®</span> Print</button>
                        <button id="previewBtn" class="w-full text-left px-4 py-2.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-indigo-50 dark:hover:bg-slate-700 flex items-center gap-2"><span>üëÅ</span> Preview</button>
                        <div class="h-px bg-slate-200 dark:bg-slate-700"></div>
                        <div class="px-4 py-2">
                            <label class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 cursor-pointer">
                                <input type="checkbox" id="addPageNumbersCheckbox" class="rounded text-indigo-600 focus:ring-indigo-500"> Add Page # (Footer)
                            </label>
                            <label class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 cursor-pointer mt-1">
                                <input type="checkbox" id="auditTrailCheckbox" class="rounded text-indigo-600"> Add Audit Log
                            </label>
                        </div>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <!-- METADATA MODAL -->
    <div id="metadata-modal" class="fixed inset-0 z-[60] bg-black/80 hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold mb-4 dark:text-white">PDF Properties</h3>
            <div class="space-y-3">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Title</label><input type="text" id="meta-title" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Author</label><input type="text" id="meta-author" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Subject</label><input type="text" id="meta-subject" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
            </div>
            <div class="mt-6 flex justify-end gap-2"><button class="close-meta-modal px-4 py-2 text-sm text-slate-500 hover:text-slate-700 dark:text-slate-400">Cancel</button><button id="saveMetadataBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold">Save</button></div>
        </div>
    </div>

    <!-- EDITOR MODAL -->
    <div id="text-modal" class="fixed inset-0 z-[60] bg-black/90 hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-800 w-full max-w-7xl h-[95vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300">
            <div class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-4"><h3 class="font-bold text-lg text-slate-800 dark:text-white">Page Editor</h3><div class="h-4 w-px bg-slate-300 dark:bg-slate-600"></div><p id="editor-page-info" class="text-slate-500 text-sm"></p></div>
                <div class="flex gap-2"><button id="savePageEdits" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm font-bold transition shadow-md">Save & Close</button><button class="close-text-modal text-slate-500 hover:text-slate-800 dark:hover:text-white px-3 font-medium">Cancel</button></div>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <!-- CONTROLS SIDEBAR -->
                <div class="w-80 bg-slate-50 dark:bg-slate-900 border-r border-slate-200 dark:border-slate-700 flex flex-col overflow-y-auto p-5 z-10 shadow-lg custom-scroll">
                    <!-- Crop Section -->
                    <div class="mb-6 pb-6 border-b border-slate-200 dark:border-slate-700">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Tools</label>
                        <div class="flex gap-2 mb-3">
                            <button id="toggleCropBtn" class="flex-1 py-2 bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 rounded text-xs font-bold border border-slate-200 dark:border-slate-700 transition">‚úÇ Toggle Crop</button>
                            <button id="applyCropBtn" class="hidden flex-1 py-2 bg-emerald-600 text-white rounded text-xs font-bold shadow">Apply Crop</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="text-[10px] text-slate-500">Brightness</label><input type="range" id="filter-brightness" min="0" max="200" value="100" class="w-full h-1.5 bg-slate-200 rounded-lg"></div>
                            <div><label class="text-[10px] text-slate-500">Contrast</label><input type="range" id="filter-contrast" min="0" max="200" value="100" class="w-full h-1.5 bg-slate-200 rounded-lg"></div>
                        </div>
                    </div>

                    <!-- Stamps -->
                    <div class="mb-6 pb-6 border-b border-slate-200 dark:border-slate-700">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Quick Stamps</label>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button class="stamp-btn w-full bg-red-50 text-red-700 border border-red-200 py-1.5 rounded text-xs font-bold hover:bg-red-100 transition" data-text="CONFIDENTIAL" data-color="#DC2626">CONFIDENTIAL</button>
                            <button class="stamp-btn w-full bg-green-50 text-green-700 border border-green-200 py-1.5 rounded text-xs font-bold hover:bg-green-100 transition" data-text="APPROVED" data-color="#16A34A">APPROVED</button>
                            <button class="stamp-btn w-full bg-blue-50 text-blue-700 border border-blue-200 py-1.5 rounded text-xs font-bold hover:bg-blue-100 transition" data-text="DRAFT" data-color="#2563EB">DRAFT</button>
                            <button class="stamp-btn w-full bg-yellow-50 text-yellow-700 border border-yellow-200 py-1.5 rounded text-xs font-bold hover:bg-yellow-100 transition" data-text="COPY" data-color="#CA8A04">COPY</button>
                        </div>
                        <button id="uploadStampBtn" class="w-full py-1.5 text-xs border border-dashed border-slate-400 text-slate-500 rounded hover:bg-slate-50 dark:hover:bg-slate-800 transition">Upload Image / Logo</button>
                    </div>

                    <!-- Signature -->
                    <div class="mb-6 pb-6 border-b border-slate-200 dark:border-slate-700">
                        <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">Signature</label>
                        <div class="border border-slate-200 dark:border-slate-600 rounded h-24 mb-2 bg-white relative cursor-crosshair overflow-hidden touch-none shadow-inner" id="sig-pad-container">
                            <canvas id="signature-pad" class="w-full h-full block"></canvas>
                            <div class="absolute bottom-1 right-1 text-[10px] text-slate-300 pointer-events-none select-none">Sign Here</div>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <button id="addSigBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-1.5 rounded text-xs font-bold transition">Add Drawn</button>
                            <button id="clearSigBtn" class="px-3 bg-slate-100 hover:bg-slate-200 text-slate-600 py-1.5 rounded text-xs transition">Clear</button>
                        </div>
                        <button id="uploadSigBtn" class="w-full py-1.5 text-xs text-indigo-600 hover:underline">Upload Signature File</button>
                    </div>

                    <!-- Text Controls -->
                    <div class="space-y-4 flex-1">
                        <div class="p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800">
                            <label class="block text-xs font-bold text-indigo-900 dark:text-indigo-300 mb-2">ADD TEXT</label>
                            <div class="flex gap-2 mb-2">
                                <button id="txt-bold-btn" class="w-8 h-8 rounded border bg-white dark:bg-slate-700 font-bold text-xs hover:bg-slate-50">B</button>
                                <button id="txt-italic-btn" class="w-8 h-8 rounded border bg-white dark:bg-slate-700 italic font-serif text-xs hover:bg-slate-50">I</button>
                            </div>
                            <textarea id="txt-content" placeholder="Type here..." class="w-full h-16 text-sm p-3 rounded-lg border-0 focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-800 mb-2 resize-none shadow-sm dark:text-white"></textarea>
                            <button id="addTextLayerBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg text-sm font-medium shadow-sm transition">Add Text Layer</button>
                        </div>

                        <!-- Active Layer Controls -->
                        <div id="layer-controls" class="hidden space-y-4 opacity-50 pointer-events-none transition-opacity">
                            <div class="h-px bg-slate-200 dark:bg-slate-700"></div>
                            <div class="flex justify-between items-center"><span class="text-xs font-bold text-slate-400 uppercase">Selected Layer</span><button id="delete-layer-btn" class="text-red-500 text-xs hover:underline font-bold">Remove</button></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-slate-500 mb-1 block">Font</label><select id="txt-font" class="w-full text-xs p-1.5 rounded border border-slate-200 dark:border-slate-600 bg-transparent dark:text-white"><option value="Helvetica">Helvetica</option><option value="TimesRoman">Times</option><option value="Courier">Courier</option></select></div>
                                <div><label class="text-xs text-slate-500 mb-1 block">Size</label><input type="number" id="txt-size" class="w-full text-xs p-1.5 rounded border border-slate-200 dark:border-slate-600 bg-transparent dark:text-white"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-slate-500 mb-1 block">Color</label><input type="color" id="txt-color" class="w-full h-8 cursor-pointer rounded"></div>
                                <div><label class="text-xs text-slate-500 mb-1 block">Opacity</label><input type="range" id="txt-opacity" min="0.1" max="1" step="0.1" value="1" class="w-full h-2 bg-slate-200 rounded-lg mt-2"></div>
                            </div>
                            <div><label class="text-xs text-slate-500 mb-1 block">Rotation</label><input type="range" id="txt-rotation" min="-180" max="180" class="w-full h-2 bg-slate-200 rounded-lg accent-indigo-600"></div>
                            <label class="flex items-center gap-2 text-xs text-slate-500"><input type="checkbox" id="txt-shadow" class="rounded text-indigo-600"> Drop Shadow</label>
                            
                            <!-- Positioning Grid -->
                            <label class="text-xs text-slate-500 mt-2 block">Quick Align</label>
                            <div class="grid grid-cols-3 gap-1 w-24">
                                <button class="pos-btn p-1 bg-slate-100 hover:bg-slate-200 text-[10px] rounded" data-pos="tl">‚Üñ</button><button class="pos-btn p-1 bg-slate-100 hover:bg-slate-200 text-[10px] rounded" data-pos="tc">‚Üë</button><button class="pos-btn p-1 bg-slate-100 hover:bg-slate-200 text-[10px] rounded" data-pos="tr">‚Üó</button>
                                <button class="pos-btn p-1 bg-slate-100 hover:bg-slate-200 text-[10px] rounded" data-pos="cl">‚Üê</button><button class="pos-btn p-1 bg-slate-100 hover:bg-slate-200 text-[10px] rounded" data-pos="cc">‚óè</button><button class="pos-btn p-1 bg-slate-100 hover:bg-slate-200 text-[10px] rounded" data-pos="cr">‚Üí</button>
                                <button class="pos-btn p-1 bg-slate-100 hover:bg-slate-200 text-[10px] rounded" data-pos="bl">‚Üô</button><button class="pos-btn p-1 bg-slate-100 hover:bg-slate-200 text-[10px] rounded" data-pos="bc">‚Üì</button><button class="pos-btn p-1 bg-slate-100 hover:bg-slate-200 text-[10px] rounded" data-pos="br">‚Üò</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PREVIEW CANVAS -->
                <div id="preview-container-parent" class="flex-1 bg-slate-200 dark:bg-slate-950 flex items-center justify-center p-8 overflow-hidden relative">
                    <div id="preview-wrapper" class="relative shadow-2xl transition-transform duration-200 ease-out origin-center bg-white">
                        <canvas id="modal-bg-canvas" class="block"></canvas>
                        <div id="overlay-container" class="absolute inset-0"></div>
                        <img id="crop-image-target" class="hidden max-w-full max-h-full">
                        <div id="crop-overlay" class="absolute inset-0 hidden pointer-events-none border-4 border-indigo-500/50 z-50 flex items-center justify-center"><div class="bg-indigo-600 text-white text-xs px-2 py-1 rounded shadow-lg">Crop Mode Active</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOADER -->
    <div id="loader" class="fixed inset-0 z-[100] bg-white/90 dark:bg-slate-900/90 flex flex-col items-center justify-center hidden backdrop-blur-sm">
        <div class="w-12 h-12 border-4 border-slate-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
        <p id="loader-text" class="text-slate-600 dark:text-slate-300 font-medium animate-pulse">Processing...</p>
    </div>

    <script>
    // --- APP LOGIC ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/pdf.worker.min.js';

    class AuditLogger {
        constructor() { this.logs = []; this.add('Session Started'); }
        add(action) { const timestamp = new Date().toISOString(); this.logs.push(`[${timestamp}] ${action}`); }
        getLogText() { return "AUDIT TRAIL\n" + "-".repeat(50) + "\n" + this.logs.join('\n'); }
    }

    class LocalStorageManager {
        constructor(dbName='PDFEditorDB', storeName='StateStore') { this.dbName=dbName; this.storeName=storeName; this.db=null; }
        async init() { return new Promise((resolve, reject) => { const req = indexedDB.open(this.dbName, 1); req.onerror = e => reject(e); req.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains(this.storeName)) e.target.result.createObjectStore(this.storeName); }; req.onsuccess = e => { this.db = e.target.result; resolve(); }; }); }
        async saveState(sourceFiles, pages, metadata) { if(!this.db) await this.init(); const serialized = sourceFiles.map(f => ({ id: f.id, name: f.name, type: f.type, file: f.file })); const state = { sourceFiles: serialized, pages: pages, metadata: metadata, timestamp: Date.now() }; return new Promise((r, j) => { const tx=this.db.transaction([this.storeName], 'readwrite'); tx.objectStore(this.storeName).put(state, 'currentState'); tx.oncomplete=r; tx.onerror=j; }); }
        async loadState() { if(!this.db) await this.init(); return new Promise((r, j) => { const tx=this.db.transaction([this.storeName], 'readonly'); const req=tx.objectStore(this.storeName).get('currentState'); req.onsuccess=()=>r(req.result); req.onerror=j; }); }
        async clear() { if(!this.db) await this.init(); const tx=this.db.transaction([this.storeName], 'readwrite'); tx.objectStore(this.storeName).clear(); }
    }

    class VisualPDFTool {
        constructor() {
            this.sourceFiles = []; this.pages = []; this.selectedPageIds = new Set();
            this.metadata = { title: '', author: '', subject: '' };
            this.auditLogger = new AuditLogger();
            this.historyStack = []; this.redoStack = []; this.maxHistory = 20;
            this.dbManager = new LocalStorageManager();
            this.editorState = { pageId: null, tempOverlays: [], rotation: 0, cropper: null, selectedIndex: -1, brightness: 100, contrast: 100 };
            this.pageGrid = document.getElementById('page-grid');
            this.init();
        }

        async init() {
            this.initListeners(); this.initSortable(); this.initSignaturePad();
            
            // Check LocalStorage for Dark Mode preference
            const isDark = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) document.documentElement.classList.add('dark');
            
            try { await this.dbManager.init(); const saved = await this.dbManager.loadState(); if(saved && saved.pages.length > 0) { if(saved.metadata) this.metadata = saved.metadata; document.getElementById('restore-banner').classList.remove('hidden'); document.getElementById('restoreBtn').addEventListener('click', () => this.restoreSession(saved)); } } catch(e) { console.log("DB Init Error", e); }
        }

        safeAddListener(id, event, handler) { const el = document.getElementById(id); if (el) el.addEventListener(event, handler); }
        showToast(message, type='success') { const container = document.getElementById('toast-container'); const el = document.createElement('div'); const color = type === 'error' ? 'bg-red-500' : 'bg-indigo-600'; el.className = `${color} text-white px-4 py-3 rounded-lg shadow-lg animate-slide-up flex items-center gap-2`; el.innerHTML = `<span>${type==='error'?'‚ö†Ô∏è':'‚úì'}</span><span>${message}</span>`; container.appendChild(el); setTimeout(() => el.remove(), 3000); }
        autoSaveNotify() { const indicator = document.getElementById('auto-save-indicator'); indicator.classList.remove('opacity-0'); setTimeout(() => indicator.classList.add('opacity-0'), 2000); }
        
        // --- THEME ---
        toggleDarkMode() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
        }

        async addFiles(files) {
            if (files.length === 0) return;
            this.saveState(); this.showLoader(true, 'Importing...');
            if (this.pages.length === 0) { document.getElementById('start-screen').classList.add('hidden'); document.querySelector('.app-container').classList.remove('hidden'); }
            for (const file of files) {
                this.auditLogger.add(`Imported: ${file.name}`);
                const fileId = `f_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                const source = { id: fileId, name: file.name, type: file.type, file: file };
                if (file.type === 'application/pdf') {
                    try { const ab = await file.arrayBuffer(); source.pdfDoc = await pdfjsLib.getDocument({ data: ab }).promise; source.pdfLibDoc = await PDFLib.PDFDocument.load(ab); this.sourceFiles.push(source); for (let i = 0; i < source.pdfDoc.numPages; i++) this.addPageToData(source, i, 'pdf'); } catch(e) { this.showToast(`Error: ${file.name}`, 'error'); }
                } else if (file.type.startsWith('image/')) {
                    this.sourceFiles.push(source); this.addPageToData(source, 0, 'image');
                }
            }
            this.renderAllPages(); this.saveState(); this.showLoader(false);
        }

        addPageToData(source, index, type) { this.pages.push({ id: `p_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`, sourceFile: source, sourcePageIndex: index, type: type, rotation: 0, brightness: 100, contrast: 100, crop: {x:0,y:0,w:1,h:1}, textOverlays: [] }); }
        insertBlankPage() { this.saveState(); let blankSource = this.sourceFiles.find(f => f.id === 'v_blank'); if(!blankSource) { blankSource = { id: 'v_blank', name: 'Blank Page', type: 'blank' }; this.sourceFiles.push(blankSource); } this.addPageToData(blankSource, 0, 'blank'); this.renderAllPages(); }
        
        async renderThumbnail(pageData, index) {
            const item = document.createElement('div'); item.className = 'page-item group relative cursor-pointer overflow-hidden flex flex-col h-full rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm'; item.dataset.id = pageData.id; item.setAttribute('tabindex', '0');
            const hasEdits = (pageData.textOverlays && pageData.textOverlays.length > 0) || pageData.rotation !== 0 || pageData.crop.w < 1;
            const badgeHtml = hasEdits ? '<div class="absolute top-2 right-2 bg-indigo-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow z-10">‚úé</div>' : '';
            const widthStyle = pageData.crop.w < 1 ? 'width:50%; margin:0 auto;' : 'width:100%'; 
            item.innerHTML = `<div class="absolute top-2 left-2 z-20 opacity-0 group-hover:opacity-100 transition-opacity page-checkbox-wrapper"><input type="checkbox" class="page-checkbox w-5 h-5 cursor-pointer accent-indigo-600 rounded"></div>${badgeHtml}<div class="canvas-wrapper flex-1 bg-slate-50 dark:bg-slate-900/50 relative overflow-hidden flex items-center justify-center p-2"><div class="skeleton-shimmer w-full h-full absolute inset-0 z-0"></div><div class="relative shadow-sm bg-white z-10 opacity-0 transition-opacity duration-300 w-full h-full flex items-center justify-center" id="cv-cont-${pageData.id}"><canvas class="page-canvas max-w-full max-h-full object-contain block" style="${widthStyle}"></canvas></div></div><div class="page-info px-3 py-2 bg-white dark:bg-slate-800 border-t border-slate-100 dark:border-slate-700 text-xs flex justify-between items-center h-10"><div class="flex flex-col min-w-0"><span class="font-medium text-slate-700 dark:text-slate-200 truncate">${pageData.sourceFile.name}</span><span class="text-[10px] text-slate-400">Page ${pageData.sourcePageIndex + 1}</span></div></div>`;
            item.querySelector('.page-checkbox').addEventListener('click', (e) => { e.stopPropagation(); this.toggleSelection(pageData.id); }); this.pageGrid.appendChild(item); 
            if(this.observer) this.observer.observe(item);
        }

        async actuallyDrawCanvas(item, pageData) {
            const canvas = item.querySelector('canvas'); const container = item.querySelector(`#cv-cont-${pageData.id}`); const skeleton = item.querySelector('.skeleton-shimmer'); const dpr = window.devicePixelRatio || 1; const ctx = canvas.getContext('2d');
            const crop = pageData.crop || {x:0, y:0, w:1, h:1};
            if (pageData.type === 'blank') { canvas.width = 150*dpr; canvas.height = 200*dpr; ctx.scale(dpr,dpr); ctx.fillStyle='white'; ctx.fillRect(0,0,150,200); ctx.strokeStyle='#e2e8f0'; ctx.strokeRect(0,0,150,200); }
            else if (pageData.type === 'image') {
                const img = new Image(); const url = URL.createObjectURL(pageData.sourceFile.file); img.src = url;
                img.onload = () => {
                    const visualW = img.width * crop.w; const visualH = img.height * crop.h; const ratio = visualH / visualW;
                    canvas.width = 200 * dpr; canvas.height = 200 * ratio * dpr; ctx.scale(dpr, dpr); ctx.translate(100, 100 * ratio); ctx.rotate((pageData.rotation * Math.PI) / 180);
                    if(pageData.rotation % 180 !== 0) ctx.drawImage(img, img.width*crop.x, img.height*crop.y, img.width*crop.w, img.height*crop.h, -100 * ratio, -100, 200 * ratio, 200);
                    else ctx.drawImage(img, img.width*crop.x, img.height*crop.y, img.width*crop.w, img.height*crop.h, -100, -100 * ratio, 200, 200 * ratio);
                    URL.revokeObjectURL(url);
                };
            } else {
                try {
                    const page = await pageData.sourceFile.pdfDoc.getPage(pageData.sourcePageIndex + 1);
                    const viewport = page.getViewport({ scale: 1, rotation: pageData.rotation });
                    const scale = (250 / viewport.width) * dpr;
                    const croppedVp = page.getViewport({ scale: scale, rotation: pageData.rotation });
                    canvas.width = croppedVp.width * crop.w; canvas.height = croppedVp.height * crop.h;
                    ctx.save(); ctx.translate(-croppedVp.width * crop.x, -croppedVp.height * crop.y);
                    await page.render({ canvasContext: ctx, viewport: croppedVp }).promise; ctx.restore();
                } catch(e) {}
            }
            if(skeleton) skeleton.remove(); container.classList.remove('opacity-0');
        }
        
        splitPage(pageId) {
            const index = this.pages.findIndex(p => p.id === pageId);
            if (index > -1) {
                const p = this.pages[index];
                const p1 = JSON.parse(JSON.stringify(p)); p1.id = `page_${Date.now()}_L`; p1.crop = { x: 0, y: 0, w: 0.5, h: 1 };
                const p2 = JSON.parse(JSON.stringify(p)); p2.id = `page_${Date.now()}_R`; p2.crop = { x: 0.5, y: 0, w: 0.5, h: 1 };
                this.pages.splice(index, 1, p1, p2); this.saveState(); this.renderAllPages(); this.showToast("Page Split Successfully");
            }
        }

        async openPageEditor(pageId) {
            const page = this.pages.find(p => p.id === pageId); if(!page) return;
            this.editorState = { pageId: pageId, tempOverlays: JSON.parse(JSON.stringify(page.textOverlays || [])), rotation: page.rotation, brightness: page.brightness || 100, contrast: page.contrast || 100, cropper: null, selectedIndex: -1 };
            document.getElementById('editor-page-info').innerText = `${page.sourceFile.name} (Page ${page.sourcePageIndex + 1})`;
            document.getElementById('filter-brightness').value = this.editorState.brightness;
            document.getElementById('filter-contrast').value = this.editorState.contrast;
            const modal = document.getElementById('text-modal');
            modal.classList.remove('hidden', 'opacity-0'); modal.querySelector('div').classList.remove('scale-95');
            await this.renderEditorCanvas(); this.renderOverlayLayers();
        }

        async renderEditorCanvas() {
            const page = this.pages.find(p => p.id === this.editorState.pageId);
            const canvas = document.getElementById('modal-bg-canvas'); const ctx = canvas.getContext('2d'); const dpr = window.devicePixelRatio || 1;
            const crop = page.crop || {x:0, y:0, w:1, h:1};
            let natWidth, natHeight, imgBitmap, pdfProxy;
            if (page.type === 'blank') { natWidth=595; natHeight=842; }
            else if (page.type === 'image') { const url = URL.createObjectURL(page.sourceFile.file); const img = new Image(); img.src=url; await new Promise(r=>img.onload=r); natWidth=img.width; natHeight=img.height; imgBitmap=img; URL.revokeObjectURL(url); } 
            else { pdfProxy = await page.sourceFile.pdfDoc.getPage(page.sourcePageIndex+1); const vp=pdfProxy.getViewport({scale:1}); natWidth=vp.width; natHeight=vp.height; }

            const rot = this.editorState.rotation % 360; const isRotated = (rot===90||rot===270);
            const cropW = natWidth * crop.w; const cropH = natHeight * crop.h;
            const container = document.getElementById('preview-container-parent');
            const availW = container.clientWidth - 40; const availH = container.clientHeight - 40;
            const visW = isRotated ? cropH : cropW; const visH = isRotated ? cropW : cropH;
            const scale = Math.min(availW/visW, availH/visH);
            const finalW = visW * scale; const finalH = visH * scale;

            const wrapper = document.getElementById('preview-wrapper');
            wrapper.style.width = `${finalW}px`; wrapper.style.height = `${finalH}px`;
            canvas.width = finalW * dpr; canvas.height = finalH * dpr; canvas.style.width="100%"; canvas.style.height="100%";
            
            ctx.scale(dpr, dpr); ctx.filter = `brightness(${this.editorState.brightness}%) contrast(${this.editorState.contrast}%)`;
            ctx.translate(finalW/2, finalH/2); ctx.rotate((rot * Math.PI) / 180); ctx.translate(-cropW*scale/2, -cropH*scale/2);

            if(page.type === 'blank') { ctx.fillStyle='white'; ctx.fillRect(0,0,cropW*scale,cropH*scale); }
            else if(page.type === 'image') {
                ctx.drawImage(imgBitmap, natWidth*crop.x, natHeight*crop.y, natWidth*crop.w, natHeight*crop.h, 0, 0, cropW*scale, cropH*scale);
                const target = document.getElementById('crop-image-target');
                if(this.editorState.isCropping) {
                    canvas.classList.add('hidden'); target.classList.remove('hidden'); target.src=imgBitmap.src;
                    if(this.editorState.cropper) this.editorState.cropper.destroy();
                    this.editorState.cropper = new Cropper(target, { viewMode:1, autoCropArea:1 });
                } else {
                    canvas.classList.remove('hidden'); target.classList.add('hidden');
                    if(this.editorState.cropper) { this.editorState.cropper.destroy(); this.editorState.cropper=null; }
                }
            } else {
                ctx.save(); ctx.translate(-natWidth*crop.x*scale, -natHeight*crop.y*scale);
                await pdfProxy.render({ canvasContext: ctx, viewport: pdfProxy.getViewport({ scale: scale }) }).promise;
                ctx.restore();
            }
        }

        renderOverlayLayers() {
            const container = document.getElementById('overlay-container'); container.innerHTML = '';
            this.editorState.tempOverlays.forEach((txt, index) => {
                const el = document.createElement('div'); el.className = 'draggable-text'; if(index === this.editorState.selectedIndex) el.classList.add('active');
                if(txt.isImage) { const img = document.createElement('img'); img.src = txt.imageData; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='contain'; el.appendChild(img); el.style.width = (txt.width||150)+'px'; el.style.height = (txt.height||75)+'px'; el.style.border='none'; } 
                else { el.innerText = txt.text; el.style.fontSize = `${txt.size}px`; el.style.color = txt.color; if(txt.isBold) el.style.fontWeight='bold'; if(txt.isItalic) el.style.fontStyle='italic'; if(txt.hasShadow) el.style.textShadow='1px 1px 2px rgba(0,0,0,0.5)'; }
                el.style.left = `${txt.xPercent}%`; el.style.top = `${txt.yPercent}%`; el.style.opacity = txt.opacity; el.style.transform = `translate(-50%, -50%) rotate(${txt.rotation}deg)`; 
                el.addEventListener('mousedown', e => { e.stopPropagation(); this.setActiveLayer(index); this.startDrag(e, index, container); }); container.appendChild(el);
            });
            this.updateLayerControls();
        }

        updateLayerControls() {
            const controls = document.getElementById('layer-controls');
            if(this.editorState.selectedIndex > -1) {
                controls.classList.remove('hidden', 'opacity-50', 'pointer-events-none');
                const l = this.editorState.tempOverlays[this.editorState.selectedIndex];
                if(!l.isImage) {
                    document.getElementById('txt-content').value = l.text; document.getElementById('txt-size').value = l.size;
                    document.getElementById('txt-color').value = l.color; document.getElementById('txt-font').value = l.font;
                    document.getElementById('txt-bold-btn').classList.toggle('bg-slate-200', !!l.isBold);
                    document.getElementById('txt-italic-btn').classList.toggle('bg-slate-200', !!l.isItalic);
                    document.getElementById('txt-shadow').checked = !!l.hasShadow;
                }
                document.getElementById('txt-rotation').value = l.rotation; document.getElementById('txt-opacity').value = l.opacity;
            } else { controls.classList.add('opacity-50', 'pointer-events-none'); }
        }

        async createPdf(preview, print, onlySelected) {
            let targetPages = this.pages; if(onlySelected && this.selectedPageIds.size > 0) targetPages = this.pages.filter(p => this.selectedPageIds.has(p.id)); if (!targetPages.length) return; 
            this.showLoader(true, 'Generating PDF...');
            try {
                const doc = await PDFLib.PDFDocument.create();
                doc.setTitle(this.metadata.title); doc.setAuthor(this.metadata.author); doc.setSubject(this.metadata.subject);
                const fonts = { 'Helvetica': await doc.embedFont(PDFLib.StandardFonts.Helvetica), 'HelveticaBold': await doc.embedFont(PDFLib.StandardFonts.HelveticaBold), 'HelveticaOblique': await doc.embedFont(PDFLib.StandardFonts.HelveticaOblique), 'HelveticaBoldOblique': await doc.embedFont(PDFLib.StandardFonts.HelveticaBoldOblique), 'TimesRoman': await doc.embedFont(PDFLib.StandardFonts.TimesRoman), 'Courier': await doc.embedFont(PDFLib.StandardFonts.Courier) };
                const addPageNum = document.getElementById('addPageNumbersCheckbox').checked;
                const addAudit = document.getElementById('auditTrailCheckbox').checked;

                for (let i=0; i<targetPages.length; i++) {
                    const p = targetPages[i]; let page; const crop = p.crop || {x:0, y:0, w:1, h:1};
                    if (p.sourceFile.type.startsWith('image') && (p.brightness!==100 || p.contrast!==100 || crop.w<1 || p.rotation!==0)) {
                        const img = new Image(); img.src = URL.createObjectURL(p.sourceFile.file); await new Promise(r => img.onload = r);
                        const canvas = document.createElement('canvas'); canvas.width = img.width * crop.w; canvas.height = img.height * crop.h; const ctx = canvas.getContext('2d');
                        ctx.filter = `brightness(${p.brightness}%) contrast(${p.contrast}%)`; ctx.drawImage(img, img.width*crop.x, img.height*crop.y, img.width*crop.w, img.height*crop.h, 0, 0, canvas.width, canvas.height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.85); const emb = await doc.embedJpg(dataUrl); page = doc.addPage([emb.width, emb.height]); page.drawImage(emb, {x:0, y:0, width: emb.width, height: emb.height});
                    } else if (p.type === 'image') { const buff = await p.sourceFile.file.arrayBuffer(); const emb = p.sourceFile.type.includes('png') ? await doc.embedPng(buff) : await doc.embedJpg(buff); page = doc.addPage([emb.width, emb.height]); page.drawImage(emb, {x:0,y:0,width:emb.width,height:emb.height}); } 
                    else if (p.type === 'blank') { page = doc.addPage([595, 842]); } 
                    else { const [cp] = await doc.copyPages(p.sourceFile.pdfLibDoc, [p.sourcePageIndex]); const { x, y, width, height } = cp.getMediaBox(); cp.setCropBox(x + width*crop.x, y + height*(1-crop.y-crop.h), width*crop.w, height*crop.h); cp.setRotation(PDFLib.degrees((cp.getRotation().angle + p.rotation) % 360)); page = doc.addPage(cp); }

                    if (p.textOverlays) {
                        const { width, height } = page.getSize();
                        for(const t of p.textOverlays) {
                            const x = width * (t.xPercent / 100); const y = height - (height * (t.yPercent / 100));
                            if(t.isImage) { const pngImage = await doc.embedPng(t.imageData); const dims = pngImage.scale(0.5); page.drawImage(pngImage, { x: x - dims.width/2, y: y - dims.height/2, width: dims.width, height: dims.height, rotate: PDFLib.degrees(t.rotation) }); } 
                            else { 
                                let fontKey = t.font || 'Helvetica'; if(t.isBold && t.isItalic) fontKey += 'BoldOblique'; else if(t.isBold) fontKey += 'Bold'; else if(t.isItalic) fontKey += 'Oblique';
                                const font = fonts[fontKey] || fonts['Helvetica'];
                                page.drawText(t.text, { x, y, size: t.size, font: font, color: PDFLib.rgb(...this.hexToRgb(t.color)), opacity: t.opacity, rotate: PDFLib.degrees(t.rotation), xCentered: true, yCentered: true });
                            }
                        }
                    }
                    if(addPageNum) { const { width } = page.getSize(); page.drawText(`${i+1}`, { x: width/2, y: 20, size: 10, font: fonts['Helvetica'], color: PDFLib.rgb(0,0,0), xCentered: true }); }
                }
                if(addAudit) { const page = doc.addPage(); page.drawText("AUDIT LOG", { x: 50, y: 800, size: 18, font: fonts['HelveticaBold'] }); page.drawText(this.auditLogger.getLogText(), { x: 50, y: 750, size: 10, font: fonts['Courier'], lineHeight: 12 }); }
                const pdfBytes = await doc.save(); const blob = new Blob([pdfBytes], { type: 'application/pdf' }); const url = URL.createObjectURL(blob);
                if (preview) window.open(url, '_blank'); else if (print) { const f = document.getElementById('printFrame'); f.src = url; f.onload = () => f.contentWindow.print(); } else { const a = document.createElement('a'); a.href = url; a.download = document.getElementById('filenameInput').value + '.pdf'; a.click(); }
                this.showToast("Export Successful");
            } catch(e) { console.error(e); this.showToast("Export Failed: " + e.message, "error"); }
            this.showLoader(false);
        }

        hexToRgb(hex) { const r = parseInt(hex.slice(1,3), 16)/255; const g = parseInt(hex.slice(3,5), 16)/255; const b = parseInt(hex.slice(5,7), 16)/255; return [r,g,b]; }
        
        // --- EVENT HANDLERS ---
        initListeners() {
            document.addEventListener('keydown', e => { if ((e.ctrlKey||e.metaKey) && e.key === 'z') { e.preventDefault(); this.performUndo(); } if ((e.ctrlKey||e.metaKey) && e.key === 'y') { e.preventDefault(); this.performRedo(); } if ((e.key === 'Delete'||e.key === 'Backspace') && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) this.deleteSelectedPages(); if ((e.ctrlKey||e.metaKey) && e.key === 'a') { e.preventDefault(); this.pages.forEach(p=>this.selectedPageIds.add(p.id)); this.updateSelectionUI(); } });
            window.addEventListener('beforeunload', e => { if (this.pages.length > 0) { e.preventDefault(); e.returnValue = ''; } });
            
            // Toolbar
            this.safeAddListener('darkModeToggle', 'click', () => this.toggleDarkMode());
            this.safeAddListener('addFilesBtn', 'click', () => document.getElementById('fileInput').click());
            this.safeAddListener('fileInput', 'change', async (e) => { await this.addFiles(Array.from(e.target.files)); e.target.value = ''; });
            this.safeAddListener('startChooseFileBtn', 'click', () => document.getElementById('fileInput').click());
            this.safeAddListener('clearBtn', 'click', () => this.clearWorkspace());
            this.safeAddListener('viewGridBtn', 'click', () => { document.getElementById('page-grid').className = 'view-grid pb-32'; });
            this.safeAddListener('viewListBtn', 'click', () => { document.getElementById('page-grid').className = 'view-list pb-20'; });
            this.safeAddListener('zoomSlider', 'input', e => document.documentElement.style.setProperty('--grid-size', `${e.target.value}px`));
            this.safeAddListener('undoBtn', 'click', () => this.performUndo());
            this.safeAddListener('redoBtn', 'click', () => this.performRedo());
            
            // Sidebar
            this.safeAddListener('toggleSidebarSize', 'click', () => this.toggleSidebarSize());
            this.safeAddListener('sidebar-close-btn', 'click', () => this.toggleSidebar(false));
            this.safeAddListener('menu-toggle-btn', 'click', () => this.toggleSidebar(true));
            this.safeAddListener('insertBlankBtn', 'click', () => this.insertBlankPage());
            this.safeAddListener('openTextModalBtn', 'click', () => { if(this.pages.length > 0) this.openPageEditor(this.pages[0].id); else this.showToast('Add pages first', 'error'); });
            this.safeAddListener('openMetadataBtn', 'click', () => this.openMetadataModal());

            // Footer
            this.safeAddListener('selectAllBtn', 'click', () => { this.pages.forEach(p => this.selectedPageIds.add(p.id)); this.updateSelectionUI(); });
            this.safeAddListener('deselectAllBtn', 'click', () => { this.selectedPageIds.clear(); this.updateSelectionUI(); });
            this.safeAddListener('deleteSelectedBtn', 'click', () => this.deleteSelectedPages());
            this.safeAddListener('rotateSelectedBtn', 'click', () => this.rotateSelectedPages(90));
            this.safeAddListener('duplicateSelectedBtn', 'click', () => this.duplicateSelected());
            
            // Export
            document.getElementById('exportMenuBtn').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('exportMenuDropdown').classList.toggle('hidden'); });
            document.addEventListener('click', () => document.getElementById('exportMenuDropdown').classList.add('hidden'));
            this.safeAddListener('saveBtn', 'click', () => this.createPdf());
            this.safeAddListener('saveSelectedBtn', 'click', () => this.createPdf(false, false, true));
            this.safeAddListener('printBtn', 'click', () => this.createPdf(false, true));
            this.safeAddListener('previewBtn', 'click', () => this.createPdf(true));

            // Editor
            this.safeAddListener('addTextLayerBtn', 'click', () => this.addText());
            ['txt-content', 'txt-size', 'txt-color', 'txt-rotation', 'txt-font', 'txt-opacity'].forEach(id => { const el = document.getElementById(id); if(el) el.addEventListener('input', () => this.updateActiveTextLayer()); });
            this.safeAddListener('txt-shadow', 'change', () => this.updateActiveTextLayer());
            this.safeAddListener('txt-bold-btn', 'click', () => this.toggleBold());
            this.safeAddListener('txt-italic-btn', 'click', () => this.toggleItalic());
            this.safeAddListener('delete-layer-btn', 'click', () => this.deleteActiveLayer());
            this.safeAddListener('toggleCropBtn', 'click', () => this.toggleCrop());
            this.safeAddListener('applyCropBtn', 'click', () => this.toggleCrop());
            this.safeAddListener('savePageEdits', 'click', () => this.savePageEdits());
            document.querySelectorAll('.stamp-btn').forEach(btn => btn.addEventListener('click', e => this.addStamp(e.target.dataset.text, e.target.dataset.color)));
            document.querySelectorAll('.pos-btn').forEach(btn => btn.addEventListener('click', e => this.setTextPosition(e.target.dataset.pos)));
            this.safeAddListener('uploadStampBtn', 'click', () => document.getElementById('stampInput').click());
            this.safeAddListener('stampInput', 'change', e => this.uploadStamp(e.target.files[0]));
            this.safeAddListener('filter-brightness', 'input', e => { this.editorState.brightness = e.target.value; this.renderEditorCanvas(); });
            this.safeAddListener('filter-contrast', 'input', e => { this.editorState.contrast = e.target.value; this.renderEditorCanvas(); });
            const closeText = document.querySelector('.close-text-modal'); if(closeText) closeText.addEventListener('click', () => { document.getElementById('text-modal').classList.add('hidden', 'opacity-0'); document.getElementById('text-modal').querySelector('div').classList.add('scale-95'); });

            // Metadata Modal
            this.safeAddListener('saveMetadataBtn', 'click', () => this.saveMetadata());
            const closeMeta = document.querySelector('.close-meta-modal'); if(closeMeta) closeMeta.addEventListener('click', () => { document.getElementById('metadata-modal').classList.add('hidden', 'opacity-0'); document.getElementById('metadata-modal').querySelector('div').classList.add('scale-95'); });

            // Context Menu
            document.getElementById('context-menu').addEventListener('click', (e) => { e.stopPropagation(); });
            document.addEventListener('click', () => document.getElementById('context-menu').classList.add('hidden'));
            this.pageGrid.addEventListener('contextmenu', e => { 
                const item = e.target.closest('.page-item'); if(!item) return; e.preventDefault(); 
                this.contextTargetId = item.dataset.id;
                const menu = document.getElementById('context-menu');
                let x = e.clientX, y = e.clientY;
                if(x + 200 > window.innerWidth) x = window.innerWidth - 210;
                if(y + 300 > window.innerHeight) y = window.innerHeight - 310;
                menu.style.left = `${x}px`; menu.style.top = `${y}px`; menu.classList.remove('hidden');
            });
            this.safeAddListener('ctx-edit', 'click', () => { document.getElementById('context-menu').classList.add('hidden'); this.openPageEditor(this.contextTargetId); });
            this.safeAddListener('ctx-split', 'click', () => { document.getElementById('context-menu').classList.add('hidden'); this.splitPage(this.contextTargetId); });
            this.safeAddListener('ctx-delete', 'click', () => { document.getElementById('context-menu').classList.add('hidden'); this.deletePages([this.contextTargetId]); });
            this.safeAddListener('ctx-duplicate', 'click', () => { document.getElementById('context-menu').classList.add('hidden'); this.selectedPageIds.clear(); this.selectedPageIds.add(this.contextTargetId); this.duplicateSelected(); });
            this.safeAddListener('ctx-rotate-cw', 'click', () => { document.getElementById('context-menu').classList.add('hidden'); this.rotatePages([this.contextTargetId], 90); });

            // Drag & Drop
            ['startDropZone', 'main-view'].forEach(id => { const z = document.getElementById(id); if(z) { z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('dragover'); }); z.addEventListener('dragleave', e => { e.preventDefault(); z.classList.remove('dragover'); }); z.addEventListener('drop', e => { e.preventDefault(); z.classList.remove('dragover'); this.addFiles(Array.from(e.dataTransfer.files)); }); } });
            
            // Sort
            this.safeAddListener('sortByNumberBtn', 'click', () => this.sortByNumber());
            this.safeAddListener('sortByAlphaBtn', 'click', () => this.sortByAlpha());
        }

        // --- CORE FUNCTIONS (Extracted for readability) ---
        addText() { this.editorState.tempOverlays.push({ text: "Text", xPercent:50, yPercent:50, size:24, color:'#000000', opacity:1, rotation:0, font:'Helvetica', isBold:false, isItalic:false, hasShadow:false }); this.editorState.selectedIndex=this.editorState.tempOverlays.length-1; this.renderOverlayLayers(); }
        addStamp(text, color) { this.editorState.tempOverlays.push({ text: text, xPercent:50, yPercent:50, size:60, color:color, opacity:0.3, rotation:45, font:'HelveticaBold', isBold:true }); this.editorState.selectedIndex=this.editorState.tempOverlays.length-1; this.renderOverlayLayers(); }
        uploadStamp(file) { const reader = new FileReader(); reader.onload=e=>{ this.editorState.tempOverlays.push({ isImage:true, imageData:e.target.result, xPercent:50, yPercent:50, width:150, height:150, rotation:0, opacity:1 }); this.renderOverlayLayers(); }; reader.readAsDataURL(file); }
        toggleBold() { if(this.editorState.selectedIndex > -1) { this.editorState.tempOverlays[this.editorState.selectedIndex].isBold = !this.editorState.tempOverlays[this.editorState.selectedIndex].isBold; this.renderOverlayLayers(); } }
        toggleItalic() { if(this.editorState.selectedIndex > -1) { this.editorState.tempOverlays[this.editorState.selectedIndex].isItalic = !this.editorState.tempOverlays[this.editorState.selectedIndex].isItalic; this.renderOverlayLayers(); } }
        setActiveLayer(index) { this.editorState.selectedIndex = index; this.renderOverlayLayers(); }
        deleteActiveLayer() { if(this.editorState.selectedIndex > -1) { this.editorState.tempOverlays.splice(this.editorState.selectedIndex, 1); this.editorState.selectedIndex = -1; this.renderOverlayLayers(); } }
        updateActiveTextLayer() { if(this.editorState.selectedIndex === -1) return; const l = this.editorState.tempOverlays[this.editorState.selectedIndex]; if(!l.isImage) { l.text = document.getElementById('txt-content').value; l.size = parseInt(document.getElementById('txt-size').value); l.color = document.getElementById('txt-color').value; l.font = document.getElementById('txt-font').value; l.hasShadow = document.getElementById('txt-shadow').checked; } l.rotation = parseInt(document.getElementById('txt-rotation').value); l.opacity = parseFloat(document.getElementById('txt-opacity').value); this.renderOverlayLayers(); }
        startDrag(e, index, container) { let isDragging = true; const rect = container.getBoundingClientRect(); const moveHandler = (ev) => { if(!isDragging) return; const x = ev.clientX - rect.left; const y = ev.clientY - rect.top; this.editorState.tempOverlays[index].xPercent = Math.max(0, Math.min(100, (x / rect.width) * 100)); this.editorState.tempOverlays[index].yPercent = Math.max(0, Math.min(100, (y / rect.height) * 100)); this.renderOverlayLayers(); }; const upHandler = () => { isDragging = false; document.removeEventListener('mousemove', moveHandler); document.removeEventListener('mouseup', upHandler); }; document.addEventListener('mousemove', moveHandler); document.addEventListener('mouseup', upHandler); }
        setTextPosition(pos) { if(this.editorState.selectedIndex === -1) return; const l = this.editorState.tempOverlays[this.editorState.selectedIndex]; const m=10; if(pos.includes('l')) l.xPercent=m; if(pos.includes('r')) l.xPercent=100-m; if(pos.includes('c')&&pos[0]!='c') l.xPercent=50; if(pos.includes('t')) l.yPercent=m; if(pos.includes('b')) l.yPercent=100-m; if(pos.includes('c')&&pos[1]!='c') l.yPercent=50; if(pos=='cc') { l.xPercent=50; l.yPercent=50; } this.renderOverlayLayers(); }
        
        toggleCrop() {
            this.editorState.isCropping = !this.editorState.isCropping;
            document.getElementById('crop-overlay').classList.toggle('hidden', !this.editorState.isCropping);
            const target = document.getElementById('crop-image-target'); const canvas = document.getElementById('modal-bg-canvas');
            if(this.editorState.isCropping) {
                canvas.classList.add('hidden'); target.classList.remove('hidden'); target.src = canvas.toDataURL();
                this.editorState.cropper = new Cropper(target, { viewMode:1, autoCropArea:0.8 });
            } else {
                if(this.editorState.cropper) { this.editorState.cropper.destroy(); this.editorState.cropper=null; }
                canvas.classList.remove('hidden'); target.classList.add('hidden');
            }
        }
        initSignaturePad() {
            const canvas = document.getElementById('signature-pad'); if(!canvas) return; const ctx = canvas.getContext('2d'); let painting = false;
            const resize = () => { canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight; ctx.lineWidth = 3; ctx.lineCap = 'round'; }; resize();
            const start = (e) => { painting = true; draw(e); }; const end = () => { painting = false; ctx.beginPath(); };
            const draw = (e) => { if (!painting) return; const rect = canvas.getBoundingClientRect(); ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top); ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top); };
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mouseup', end); canvas.addEventListener('mousemove', draw);
            document.getElementById('clearSigBtn').addEventListener('click', () => ctx.clearRect(0,0,canvas.width,canvas.height));
            document.getElementById('addSigBtn').addEventListener('click', () => { this.editorState.tempOverlays.push({ isImage:true, imageData:canvas.toDataURL(), xPercent:50, yPercent:50, width:150, height:75, rotation:0, opacity:1 }); this.renderOverlayLayers(); });
            document.getElementById('uploadSigBtn').addEventListener('click', () => document.getElementById('sigUpload').click());
            document.getElementById('sigUpload').addEventListener('change', e => { const file = e.target.files[0]; if(file) { const r = new FileReader(); r.onload = ev => { this.editorState.tempOverlays.push({ isImage:true, imageData:ev.target.result, xPercent:50, yPercent:50, width:150, height:75, rotation:0, opacity:1 }); this.renderOverlayLayers(); }; r.readAsDataURL(file); }});
        }
        
        savePageEdits() { if (!this.editorState.pageId) return; const page = this.pages.find(p => p.id === this.editorState.pageId); if (!page) return; page.textOverlays = JSON.parse(JSON.stringify(this.editorState.tempOverlays)); page.rotation = this.editorState.rotation; page.brightness = this.editorState.brightness; page.contrast = this.editorState.contrast; this.saveState(); this.showToast("Changes saved"); this.renderAllPages(); document.getElementById('text-modal').classList.add('hidden', 'opacity-0'); document.getElementById('text-modal').querySelector('div').classList.add('scale-95'); }
        openMetadataModal() { document.getElementById('meta-title').value = this.metadata.title; document.getElementById('meta-author').value = this.metadata.author; document.getElementById('meta-subject').value = this.metadata.subject; const m = document.getElementById('metadata-modal'); m.classList.remove('hidden', 'opacity-0'); m.querySelector('div').classList.remove('scale-95'); }
        saveMetadata() { this.metadata.title = document.getElementById('meta-title').value; this.metadata.author = document.getElementById('meta-author').value; this.metadata.subject = document.getElementById('meta-subject').value; this.saveState(); document.getElementById('metadata-modal').classList.add('hidden', 'opacity-0'); document.getElementById('metadata-modal').querySelector('div').classList.add('scale-95'); this.showToast("Metadata saved"); }
        restoreSession(saved) { this.showLoader(true, 'Restoring Session...'); this.sourceFiles = []; for (const f of saved.sourceFiles) { const source = { id: f.id, name: f.name, type: f.type, file: f.file }; if(f.type === 'application/pdf') { const ab = await f.file.arrayBuffer(); source.pdfDoc = await pdfjsLib.getDocument({ data: ab }).promise; source.pdfLibDoc = await PDFLib.PDFDocument.load(ab); } this.sourceFiles.push(source); } this.pages = []; saved.pages.forEach(p => { const source = this.sourceFiles.find(s => s.id === p.sourceFileId); if(source) this.pages.push({ id: p.id, sourceFile: source, sourcePageIndex: p.sourcePageIndex, type: p.type, rotation: p.rotation, textOverlays: p.textOverlays, brightness: p.brightness, contrast: p.contrast, crop: p.crop || {x:0,y:0,w:1,h:1} }); }); document.getElementById('start-screen').classList.add('hidden'); document.querySelector('.app-container').classList.remove('hidden'); this.renderAllPages(); this.updateStatus(); this.showLoader(false); }
        saveState() { const snapshot = this.pages.map(p => ({ id: p.id, sourceFileId: p.sourceFile.id, sourcePageIndex: p.sourcePageIndex, type: p.type, rotation: p.rotation, textOverlays: JSON.parse(JSON.stringify(p.textOverlays || [])), brightness: p.brightness, contrast: p.contrast, crop: p.crop })); this.historyStack.push(snapshot); if(this.historyStack.length>20) this.historyStack.shift(); this.redoStack=[]; this.updateHistoryButtons(); this.dbManager.saveState(this.sourceFiles, snapshot, this.metadata); this.autoSaveNotify(); }
        restoreState(snapshot) { this.pages = []; snapshot.forEach(item => { const source = this.sourceFiles.find(f => f.id === item.sourceFileId); if(source) this.pages.push({ ...item, sourceFile: source }); }); this.selectedPageIds.clear(); this.renderAllPages(); this.updateStatus(); }
        performUndo() { if(this.historyStack.length) { this.redoStack.push(this.snapshotCurrentState()); this.restoreState(this.historyStack.pop()); this.updateHistoryButtons(); } }
        performRedo() { if(this.redoStack.length) { this.historyStack.push(this.snapshotCurrentState()); this.restoreState(this.redoStack.pop()); this.updateHistoryButtons(); } }
        snapshotCurrentState() { return this.pages.map(p => ({ id: p.id, sourceFileId: p.sourceFile.id, sourcePageIndex: p.sourcePageIndex, type: p.type, rotation: p.rotation, textOverlays: JSON.parse(JSON.stringify(p.textOverlays || [])), brightness: p.brightness, contrast: p.contrast, crop: p.crop })); }
        updateHistoryButtons() { document.getElementById('undoBtn').disabled = !this.historyStack.length; document.getElementById('redoBtn').disabled = !this.redoStack.length; }
        updateStatus() { this.updateSelectionUI(); if(this.pages.length === 0) this.clearWorkspace(); }
        async clearWorkspace() { if(!confirm("Clear all?")) return; this.pages = []; this.sourceFiles = []; this.selectedPageIds.clear(); this.renderAllPages(); document.getElementById('start-screen').classList.remove('hidden'); document.querySelector('.app-container').classList.add('hidden'); await this.dbManager.clear(); }
        showLoader(show, text) { const l = document.getElementById('loader'); if(show) { l.classList.remove('hidden'); if(text) document.getElementById('loader-text').innerText=text; } else l.classList.add('hidden'); }
        initSortable() { Sortable.create(this.pageGrid, { animation: 200, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', onEnd: () => { this.saveState(); this.updateDataOrderFromDOM(); } }); }
        updateDataOrderFromDOM() { const newPages = []; [...this.pageGrid.children].forEach(el => newPages.push(this.pages.find(p => p.id === el.dataset.id))); this.pages = newPages; this.renderAllPages(); }
        initIntersectionObserver() { const container = document.getElementById('page-grid-container'); if(!container) return; this.observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { this.observer.unobserve(entry.target); const p = this.pages.find(page => page.id === entry.target.dataset.id); if(p) this.actuallyDrawCanvas(entry.target, p); } }); }, { root: container, rootMargin: '300px', threshold: 0 }); }
        handlePageClick(e) { const item = e.target.closest('.page-item'); if(!item) return; const id = item.dataset.id; if(e.shiftKey && this.lastSelectedId) { const all=[...this.pageGrid.children]; const start=all.findIndex(el=>el.dataset.id===this.lastSelectedId); const end=all.findIndex(el=>el.dataset.id===id); if(start>-1 && end>-1) { all.slice(Math.min(start,end),Math.max(start,end)+1).forEach(el=>this.selectedPageIds.add(el.dataset.id)); } } else if(e.ctrlKey || e.metaKey) this.toggleSelection(id); else { this.selectedPageIds.clear(); this.selectedPageIds.add(id); } this.lastSelectedId=id; this.updateSelectionUI(); }
        toggleSelection(id) { if(this.selectedPageIds.has(id)) this.selectedPageIds.delete(id); else this.selectedPageIds.add(id); this.updateSelectionUI(); }
        updateSelectionUI() { [...this.pageGrid.children].forEach(el => { const s=this.selectedPageIds.has(el.dataset.id); el.classList.toggle('selected',s); el.querySelector('.page-checkbox').checked=s; el.querySelector('.page-checkbox-wrapper').classList.toggle('opacity-0',!s); }); document.getElementById('selection-count').innerText=`${this.selectedPageIds.size} selected`; if(this.selectedPageIds.size>0) document.getElementById('contextual-footer').classList.remove('hidden-island'); else document.getElementById('contextual-footer').classList.add('hidden-island'); }
        duplicateSelected() { if(!this.selectedPageIds.size) return; this.saveState(); const newPages=[]; this.pages.forEach(p=>{ newPages.push(p); if(this.selectedPageIds.has(p.id)) newPages.push({...p, id: `p_${Date.now()}_d`, textOverlays: JSON.parse(JSON.stringify(p.textOverlays))}); }); this.pages=newPages; this.renderAllPages(); this.updateStatus(); }
        deleteSelectedPages() { if(this.selectedPageIds.size) { this.saveState(); this.pages=this.pages.filter(p=>!this.selectedPageIds.has(p.id)); this.selectedPageIds.clear(); this.renderAllPages(); this.updateStatus(); } }
        rotateSelectedPages(deg) { this.saveState(); this.pages.forEach(p=>{ if(this.selectedPageIds.has(p.id)) p.rotation = (p.rotation+deg+360)%360; }); this.renderAllPages(); }
        rotatePages(ids, deg) { this.saveState(); ids.forEach(id=>{ const p=this.pages.find(x=>x.id===id); if(p) p.rotation=(p.rotation+deg+360)%360; }); this.renderAllPages(); }
        deletePages(ids) { this.saveState(); this.pages=this.pages.filter(p=>!ids.includes(p.id)); this.selectedPageIds.clear(); this.renderAllPages(); this.updateStatus(); }
        splitPage(pageId) { const idx = this.pages.findIndex(p=>p.id===pageId); if(idx>-1) { const p=this.pages[idx]; const p1=JSON.parse(JSON.stringify(p)); p1.id=`p_${Date.now()}_L`; p1.crop={x:0,y:0,w:0.5,h:1}; const p2=JSON.parse(JSON.stringify(p)); p2.id=`p_${Date.now()}_R`; p2.crop={x:0.5,y:0,w:0.5,h:1}; this.pages.splice(idx,1,p1,p2); this.saveState(); this.renderAllPages(); } }
        sortByNumber() { this.saveState(); this.pages.sort((a,b)=> (a.sourceFile.name.match(/\d+/) || 0) - (b.sourceFile.name.match(/\d+/) || 0)); this.renderAllPages(); }
        sortByAlpha() { this.saveState(); this.pages.sort((a,b)=> a.sourceFile.name.localeCompare(b.sourceFile.name)); this.renderAllPages(); }
        toggleSidebar(show){ document.querySelector('.app-container').classList.toggle('sidebar-mobile-open', show); document.getElementById('sidebar-overlay').classList.toggle('hidden', !show); if(show) document.getElementById('sidebar').classList.remove('-translate-x-full'); else document.getElementById('sidebar').classList.add('-translate-x-full'); }
        toggleSidebarSize() { const sb = document.getElementById('sidebar'); sb.classList.toggle('w-72'); sb.classList.toggle('w-16'); const labels = sb.querySelectorAll('.text-sm, .text-xs, .truncate'); labels.forEach(l => l.classList.toggle('hidden')); }
    }
    document.addEventListener('DOMContentLoaded', () => new VisualPDFTool());
    </script>
</body>
</html>
